
---
title: "Insider trading regulation and trader migration."
subtitle: "Data analyses script"
author: 
  - Robert Merl
  - Stefan Palan
  - Dominik Schmidt
  - Thomas Stöckl
output:
  pdf_document:
    fig_caption: yes
    toc: true
    
header-includes: 
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
  - \floatsetup[table]{capposition=top}
  - \floatplacement{figure}{H}
  - \floatplacement{table}{H}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load, echo = FALSE, include=F}
### install.packages ####
library("ggplot2")
library("mgcv")
library("effects")
library("margins")
library("lme4")
library("car")
library("lmtest")
library("sandwich")
library("texreg")
library("gplots")
library("visreg")
library("dplyr")
library("ggpubr")
library("MASS")
library("pscl")
# library("lme4")

### setwd ####
setwd(getwd())

### collect data ####
load("Data.RData")
```

***


## Variable description

The file 'Data.RData' consists of nine data tables:

### marketsummary
The table 'marketsummary' summarizes data for each market, i.e. two observations per period and cohort.

| Variable | Description |
---| ---|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Period| Period index, ranging from '1' to '12'.|
|Period0| Period index, ranging from '0' to '5', indicating the distance to the phase’s first period, starting with 0 to facilitate the interpretation of the intercept.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|history| Treatment index specifying the regulation in previous Phases, which is either '1' for markets in Phase 1, 'N' (resp. 'R') for markets in Phase 2 which succeeded NOREG (REG) markets, 'N.N', 'N.R', 'R.N', or 'R.R' for markets in Phase 3.| 
|Location| City index, which is either 'Graz' or 'Vienna'.|
|BBV| Buyback Value.|
|BBVCent| Buyback Value centralized by the unconditional expected value of 57.5.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a period apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is eiterh '1' when a market in Phase 2 applies regulation or '0' otherwise.|
|BestBid180| Active bid in the order book when market ended which offered the highest bid price.|
|BestAsk180| Active ask in the order book when market ended which offered assets for the lowest ask price.|
|BAspread180| Difference between best bid and best ask price when market ended.
|midpointBA180| Arithmetic average of the best bid and best ask price when market ended.|
|BestBid150| Mean best bids in the order book in the last 30 seconds weighted with the seconds providing the highest bid price.|
|BestAsk150| Mean best asks in the order book in the last 30 seconds weighted with the seconds providing the lowest ask price.|
|BAspread150| Mean difference between best bid and best ask price in the last 30 seconds each second.|
|midpointBA150| Mean midpoint between best bid and best ask price in the last 30 seconds each second.|
|midpointBAavg150| Midpoint between mean best bid and mean best ask price in the last 30 seconds each second.|
|BA_BBV| Difference between the mean midpoints between best bid and best ask prices of the whole timespan of one market, and the the buyback value.|
|BA_BBV150| Difference between the mean midpoints between best bid and best ask prices in the last 30 seconds, and the the buyback value.|
|BA_BBV180| Difference between the mean midpoints between best bid and best ask prices when market closes, and the the buyback value.|
|lnBA_BBV| Logarithmic ratio of the mean midpoints between best bid and best ask prices of the whole timespan of one market, and the the buyback value.|
|lnBA_BBV150| Logarithmic ratio between the mean midpoints between best bid and best ask prices in the last 30 seconds, and the the buyback value.|
|lnBA_BBV180| Logarithmic ratio between the mean midpoints between best bid and best ask prices when market closes, and the the buyback value.|
|meanBestBid| Mean best bids in the order book in the whole timespan of a market weighted with the seconds providing the highest bid price.|
|meanBestAsk| Mean best asks in the order book in the whole timespan of a market weighted with the seconds providing the lowerst ask price.|
|meanBAspread| Mean difference between best bid and best ask price each second.|
|meanmidpointBA| Mean midpoint between best bid and best ask price in the whole timespan of a market.|
|meanBAspreadwins| Mean difference between best bid and best ask price each second after a symmetric 90% winsorization of prices.|
|meanBAspreadwins2| Mean difference between best bid and best ask price each second after a symmetric 90% winsorization.|
|meanreturnsec| Mean price change between observations each second.|
|meanreturn| Mean price change between transactions.|
|meanreturnwins| Mean price change between transactions after a symmetric 90% winsorization of prices.|
|meanreturnwins2| Mean price change between transactions after a symmetric 90% winsorization.|
|obsreturn| Number of observations of returns, i.e., of two consecutive transactions.|
|sdreturnsec| Standard deviation of price changes observed each second within a market.|
|volatility| Standard deviation of transaction price returns within a market.|
|volatilitywins| Standard deviation of transaction price returns within a market after a symmetric 90% winsorization of prices.|
|volatilitywins2| Standard deviation of transaction price returns within a market after a symmetric 90% winsorization.|
|meanPrice| Mean transaction price within a market.|
|sdPrice| Standard deviation of transaction prices within a market.|
|Volume| Number of assets transacted in a single market.|
|lagVolume| Number of assets transacted in the previous market.|
|VolumeUni| Number of assets transacted involving uninformed traders in a single market.|
|VolumeInf| Number of assets transacted involving informed traders in a single market.|
|Volume_Informed_Informed| Number of assets offered and accepted by informed traders in a single market.|
|Volume_Uninformed_Informed| Number of assets offered by uninformed and accepted by informed traders in a single market.|
|Volume_Informed_Uninformed| Number of assets offered by informed and accepted by uninformed traders in a single market.|
|Volume_Uninformed_Uninformed| Number of assets offered and accepted by uninformed traders in a single market.|
|LimitVolume| Number of assets offered in limit orders in a single market.|
|lagLimitVolume| Number of assets offered in limit orders in the previous market.|
|LimitVolumeInf| Number of assets offered  in limit orders by informed traders in a single market.|
|LimitVolumeUni| Number of assets offered  in limit orders by uninformed traders in a single market.|
|NumTransactions| Number of transactions in a single market.|
|Countoffers| Number of limit orders placed in a single market.|
|CountSelloffers| Number of asks placed in a single market.|
|CountBuyoffers| Number of bids placed in a single market.|
|CancelledVolume| Number of offered assets withdrawn before market closing.|
|remainingVol| Number of offered assets in the order book at market closing.|
|SellLimitVolume| Number of assets offered in ask limit orders in a single market.|
|BuyLimitVolume| Number of assets offered in bid limit orders in a single market.|
|ProfitPotential| Sum absolute difference between the transaction price and the buyback value for each transaction times the transacted volume.|
|GD| Geometric Deviation - Geometric volume-weighted average relative mispricing within a market.|
|GAD| Geometric Absolute Deviation - Absolute geometric volume-weighted average relative mispricing within a market.|
|GADhyp| Hypothetical GAD when prices are set to be the unconditional expected value, 57.5.|
|rGAD| 1 minus the ratio between GAD and the hypothetical GAD.|
|RD| Relative Deviation - Arithmetic volume-weighted average relative mispricing within a market.|
|RAD| Relative Absolute Deviation - Absolute arithmetic volume-weighted average relative mispricing within a market.|
|GD120| Geometric volume-weighted average relative mispricing in the last minute of a market.|
|GAD120| Absolute geometric volume-weighted average relative mispricing in the last minute of a market.|
|RD120| Arithmetic volume-weighted average relative mispricing in the last minute of a market.|
|RAD120| Absolute arithmetic volume-weighted average relative mispricing in the last minute of a market.|
|Price| Last transaction price in a market.|
|Price120| Mean transaction price in the last minute of a market.|
|marketshare| Ratio of transacted volume over the transacted volume of both simultaneously operating markets.|
|lagmarketshare| marketshare in the previous period.|
|marketshareLimit| Ratio of limit order volume over the limit order volume of both simultaneously operating markets.|
|lagmarketshareLimit| marketshare of limits in the previous period.|
|AssetTurnover| Ratio of transacted volume over the remaining volume at market closing.|
|TransactionSize| Ratio of transacted volume over the number of transactions in a single market.|
|LimitOrderTurnover| Ratio of limit order volume over the remaining volume at market closing.|
|LimitOrderSize| Ratio of limit order volume over the number of transactions in a single market.|
|odds| Ratio of transacted volume over the transacted volume in the other, simultaneously operating market.|
|lagodds| odds in the previous period.|
|oddsLimit| Ratio of limit order volume over the limit order volume in the other, simultaneously operating market.|
|lagoddsLimit| limit order odds in the previous period.|
|oddsUninf| Ratio of transacted volume involving uninformed traders over the transacted volume involving uninformed traders in the other, simultaneously operating market.|
|oddsInf| Ratio of transacted volume involving informed traders over the transacted volume involving informed traders in the other, simultaneously operating market.|
|oddsInfmax| Ratio of transacted volume involving informed traders over the transacted volume involving informed traders in the other, simultaneously operating market such that markets with all market share are associated with the highest observed ratio.|
|oddsInfmax2| Ratio of transacted volume involving uninformed traders over the transacted volume involving uninformed traders in the other, simultaneously operating market such that markets with all market share are associated with the transacted volume over 1.|
|oddsInfmax3| Ratio of transacted volume involving uninformed traders over the transacted volume involving uninformed traders in the other, simultaneously operating market such that markets with all market share are associated with the highest observed ratio in the same phase.|
|oddswins| odds after 90% winsorization.|
|oddsLimitwins| Limit order odds after 90% winsorization.|
|oddsInfwins| odds involving informed traders after 90% winsorization.|
|oddsUninfwins| odds involving uninformed traders after 90% winsorization.|
|oddsLimitUninf|  Limit order odds involving uninformed traders.|
|oddsLimitInf| Limit order odds involving informed traders.|
|geomodds_start| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 1.|
|geomodds_middle| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 2.|
|geomodds_end| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 1.|
|absgeomodds_start| Absolute geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 1.|
|absgeomodds_middle| Absolute geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 2.|
|absgeomodds_end| Absolute geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 3.|
|geomoddsInf_start| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 1.|
|geomoddsInf_middle| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 2.|          
|geomoddsInf_end| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 3.|
|geomoddsUni_start| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 1.|
|geomoddsUni_middle| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 1.|
|geomoddsUni_end| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 3.|
|geomoddswins_start"| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 1 after 90% winsorization of odds.|
|geomoddswins_middle| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 2 after 90% winsorization of odds.|
|geomoddswins_end| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 3 after 90% winsorization of odds.|
|geomoddsInfwins_start| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 1 after 90% winsorization of odds.|
|geomoddsInfwins_middle| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 2 after 90% winsorization of odds.|
|geomoddsInfwins_end| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 3 after 90% winsorization of odds.|
|geomoddsUniwins_start| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 1 after 90% winsorization of odds.|
|geomoddsUniwins_middle| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 2 after 90% winsorization of odds.|
|geomoddsUniwins_end| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 3 after 90% winsorization of odds.|
|geomoddsLimitInf_start| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 1.|
|geomoddsLimitInf_middle| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 2.|
|geomoddsLimitInf_end| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving informed traders in Phase 3.|
|geomoddsLimitUni_start| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 1.|
|geomoddsLimitUni_middle| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 2.|
|geomoddsLimitUni_end| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) involving uninformed traders in Phase 3.|
|geomoddsLimit_start| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 1.|
|geomoddsLimit_middle| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 2.|
|geomoddsLimit_end| Geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 3.|
|absgeomoddsLimit_start| Absolute geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 1.|
|absgeomoddsLimit_middle| Absolute geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 2.|
|absgeomoddsLimit_end| Absolute geometric ratio of limit order volume over the transacted volume in the other, simultaneously operating markets (geometric averages) in Phase 3.|
|unprofittime| Unexectued Profitable Orders per Time - Money on the table times the time on the market, i.e., profitable price difference between an offer and the fundamental value times the remaining volume times the timespan the order is on the market.|
|RUPT| Relative Unexecuted Profitable Orders per Time - relative money on the table, i.e., profitable price difference between an offer and the fundamental value times the remaining volume times the timespan the order is on the market divided by the fundamental value and divided by the sum of time times volume of all limit orders.|
|shortsells| Number of assets sold with negative asset endowment using the short limit capacity.|
|marginbuysTaler| Money spend to buy assets with negative money endowment using the credit limit.|
|marginbuysAsset| Purchases with negative money endowments divided by the transaction price.|
|marginbuys| Purchases with negative money endowments divided by the buyback value.|
|shortsells_Informed| Number of assets sold with negative asset endowment using the short limit capacity involving informed traders.|
|shortsells_Uninformed| Number of assets sold with negative asset endowment using the short limit capacity involving uninformed traders.| 
|marginbuys_Informed| Purchases with negative money endowments divided by the buyback value involving informed traders.|
|marginbuys_Uninformed| Purchases with negative money endowments divided by the buyback value involving uninformed traders.|
|marginbuysAsset_Informed| Purchases with negative money endowments divided by the transaction price involving informed traders.|
|marginbuysAsset_Uninformed| Purchases with negative money endowments divided by the transaction price involving uninformed traders.|
|NumActiveTrader| Number of traders who either placed a limit order or accepted a market order.|
|NumTransactingTraders| Number of traders who either accepted a market order or whose limit order has been accepted by others.|
|NumOfferingTraders| Number of traders who placed a limit order.|
|ParticipationRate_Uninf| Number of active uninformed traders divided by the total number of uninformed traders.|
|ParticipationRate_Inf| Number of active informed traders divided by the total number of informed traders.|
|HHInitialAssets| Herfindahl–Hirschman index for the initial asset endowment with an alpha of 2.|
|HHEndAssets| Herfindahl–Hirschman index for the asset endowment at market closing with an alpha of 2.|
|HHInitialEndowment| Herfindahl–Hirschman index for the initial endowment with an alpha of 2.|
|HHEndEndowment| Herfindahl–Hirschman index for the endowment at market closing with an alpha of 2.|
|HHEndEndowmentPun| Herfindahl–Hirschman index for the endowment at market closing after punishment payments with an alpha of 2.|
|HHVolume| Herfindahl–Hirschman index for the transacted volume with an alpha of 2.|
|HHPDbefore| Herfindahl–Hirschman index for the wealth change before redistributions with an alpha of 2.|
|HHPDPun| Herfindahl–Hirschman index for the wealth change after punishement payments with an alpha of 2.|
|HHI_InitialAssets| Herfindahl–Hirschman index for the initial asset endowment with an alpha of 2 for active traders.|
|HHI_EndAssets| Herfindahl–Hirschman index for the asset endowment at market closing with an alpha of 2 for active traders.|
|HHI_InitialEndowment| Herfindahl–Hirschman index for the initial endowment with an alpha of 2 for active traders.|
|HHI_EndEndowment| Herfindahl–Hirschman index for the endowment at market closing with an alpha of 2 for active traders.|
|HHI_EndEndowmentPun| Herfindahl–Hirschman index for the endowment after punishment payment at market closing with an alpha of 2 for active traders.|
|HHI_Volume| Herfindahl–Hirschman index for the transacted volume with an alpha of 2 for active traders.|
|HHI_PDbefore| Herfindahl–Hirschman index for the wealth change before redistributions with an alpha of 2 for active traders.|
|HHI_PDPun| Herfindahl–Hirschman index for the wealth change after punisment payments with an alpha of 2 for active traders.|
|GiniPDbefore| Gini index for wealth change before redistributions.|
|GiniPDPun| Gini index for wealth change after punishment payment.|
|GiniProfit| Gini index for payoffs at market closing after punishemnt payment.|
|GiniAssets| Gini index for the initial asset endowment.|
|GiniEndowment| Gini index for the initial endowment.|

### subjectsummary
The table 'subjectsummary' summarizes data for each individual in each market, i.e. 14 observations for each market, period, and cohort. 

| Variable | Description |
---| ---|
|subjectID| ID variable, which uniquely identifies each participant from '1' to '382'.|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Subject| ID variable, which identifies participants within an experimental session from '1' to '14'.|
|client| ID variable, which identifies participants within an experimental session.|
|Period| Period index, ranging from '1' to '12'.|
|Period0| Period index, ranging from '0' to '5', indicating the distance to the phase’s first period, starting with 0 to facilitate the interpretation of the intercept.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|history| Treatment index specifying the regulation in previous Phases, which is either '1' for markets in Phase 1, 'N' (resp. 'R') for markets in Phase 2 which succeeded NOREG (REG) markets, 'N.N', 'N.R', 'R.N', or 'R.R' for markets in Phase 3.| 
|Location| City index, which is either 'Graz' or 'Vienna'.|
|BBV| Buyback Value.|
|BBVCent| Buyback Value centralized by the unconditional expected value of 57.5.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a period apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is either '1' when a market in Phase 2 applies regulation or '0' otherwise.|
|Role| Trader type index which is either 'Informed trader' or 'Uninformed trader'.|
|InitialAssets| Number of assets this participant is endowed at the beginning of this period.|
|Assets| Number of assets this participants holds at market closing of this period.|
|InitialCash| Monetary units this participant is endowed at the beginning of this period.|
|Cash| Monetary units this participants holds at market closing of this period.|
|InitialEndowment| Initial asset endowment time the buyback value plus the initial monetary units.|
|EndVermoegen| Asset endowment times the buyback value plus the monetary units at market closing before redistributions and punishment.|
|EndEndowmentPun| Asset endowment times the buyback value plus the monetary units at market closing after redistributions and punishment.|
|InitialEndowmentUnits| Initial asset endowment value plus initial monetary units divided by the buyback value.|
|EndEndowmentUnits| Asset endowment plus the monetary units divided by the buyback value at market closing before redistributions and punishment.|
|EndEndowmentUnitsPun| Asset endowment plus the monetary units divided by the buyback value at market closing after redistributions and punishment.|
|Punished| Binary variable which is either '1' when this trader is informed and correctly identified, or '0' otherwise.|
|PunishmentReceived| Sum of redistributions and punishement payments lost or received in this single market.|
|TradingProfit| Trading profits from market participation in experimental monetary units before redistribution and punishment.|
|TPRedist| Trading profits from market participation in experimental monetary units after redistribution.|
|TPPun| Trading profits from market participation in experimental monetary units after redistribution and punishment.|
|TPUnits| Trading profits from market participation in asset units (experimental monetary units divided by the buyback value) before redistribution and punishment.|
|TPUnitsRedist| Trading profits from market participation in asset units after redistribution.|
|TPUnitsPun| Trading profits from market participation in asset units after redistribution and punishment.|
|ProfitPeriod| Profit from market participation in Euro after redistribution and punishment.|
|PDbefore| Wealth change before redistribution and punishement.|
|PDRedist| Wealth change after redistribution.|
|PDPun| Wealth change after redistribution and punishment.|
|PDbeforeVol| Wealth change per transacted asset before redistribution and punishment.|
|PDRedistVol| Wealth change per transacted asset after redistribution.|
|PDPunVol| Wealth change per transacted asset after redistribution and punishment.|
|rankPDbefore| Ordered rank of wealth change before redistribution and punishment within a single market from '1' (lowest) to '14' (highest).|
|rankPDbeforeRole| Ordered rank of wealth change before redistribution and punishment within a single market by trader type from '1' (lowest) to '10' (highest, resp. '4' for informed traders).|
|rankavgPDbeforeRole| Ordered rank of average wealth change before redistribution and punishment throughout the experiment by role from '1' (lowest) to '14' (highest).|
|AvgPDbeforeRole| Arithmetic mean of wealth changes per transacted asset before redistribution and punishment in periods in the same trader type as in this period.|
|Volume| Number of assets transacted in a single market.|
|LimitVolume| Number of assets offered in limit orders in a single market.|
|CancelledVolume| Number of offered assets withdrawn before market closing.|
|VolumeMarketOrder| Number of accepted assets in market orders in a single market.|
|VolumeLimitOrder| Number of offered assets accepted by another trader in a single market.|
|VolumeSold| Number of assets sold in a single market.|
|VolumePurchased| Number of assets purchased in a single market.|
|activeTrader| Binary variable which identifies whether this trader placed any limit order or accepted any market order.|
|transacted| Binary variable which identifies whether this trader accepted any market order.|
|offered| Binary variable which identifies whether this trader placed any limit order.|
|TPUnProfitTransaction| Trading losses from unprofitable transactions in a single market.|
|VolUnprofitTransaction| Number of assets transacted in unprofitable transactions in a single market.|
|NumUnprofitTransactions| Number of unprofitable transactions in a single market.|
|marketshare| Ratio of transacted volume of this trader over the transacted volume in both simultaneously operating markets.|
|odds| Ratio of transacted volume of this trader over the transacted volume in the other, simultaneously operating market.|
|oddsLimit| Ratio of limit order volume of this trader over the limit order volume in the other, simultaneously operating market.|
|shortsells| Number of assets sold with negative asset endowment using the short limit capacity.|
|marginbuysTaler| Money spend to buy assets with negative money endowment using the credit limit.|
|marginbuysAsset| Purchases with negative money endowments divided by the transaction price.|
|marginbuys| Purchases with negative money endowments divided by the buyback value.|
|ParticipationRate_Uninf| Number of active uninformed traders in this market divided by the total number of uninformed traders.|
|ParticipationRate_Inf| Number of active informed traders in this market divided by the total number of informed traders.|
|ObserverStrategy| Self-description of observers at the end of the experiment how they use information: PostQ1: 'Please describe how you think the available information (1. volume limit; 2. volume limit deleted; 3. trading volume limit; 4. trading volume market; 5. volume purchased; 6. volume sold; 7. volume purchased - sold; 8. average price; 9. average volume) can be used to identify informed traders!'.|
|WhichMarket| Self-description of traders at the end of the experiment how they estimate the probability of a detection of informed traders. PostQ2: 'Please describe, which criteria were decisive for you, when choosing which market to trade on!'.|
|ProbabilityDetected| Self-description of traders at the end of the experiment how they estimate the probability of a detection of informed traders. PostQ3: 'How high do you estimate the probability that an observer correctly identifies a trader with information as such.'.|
|StrategyTrader| Self-description of traders at the end of the experiment of their trading strategy. PostQ4: 'What strategies did you use to avoid being recognized by observers as a trader with information?'.|
|OpinionPenalty| Self-description of participants at the end of the experiment about their opinion on the appropriateness of the penalty. PostQ5: 'If a trader with information is correctly selected by the observer, he loses his trading profit and must pay an additional penalty equal to the trading profit. Please indicate whether you consider this penalty to be appropriate, too low, or too high.'.|
|RiskGeneral| Self-description of participants' risk tolerance at the end of the experiment. PostQ6: 'How do you see yourself: are you generally a person who is fully prepared to take risks or do you try to avoid taking risks?'.|
|RiskFinancial| Self-description of participants' financial risk tolerance at the end of the experiment. PostQ7 'People can behave differently in different situations. How would you rate your willingness to take risks in financial matters?'.|
|LossAversion| Self-description of participants loss tolerance at the end of the experiment. PostQ8 'In financial decisions, both gains and losses are possible. To what extent do possible losses compared to possible gains influence you?'.|
|Department| Self-description of participants' department of studies. PostQ9: 'Which faculty are you studying at?'.|
|MajorOther| If they specified other at department, they are asked to specify here their faculty.|
|Age| Self-description of participants' age. PostQ10a: 'Age in years'.|
|Female| Self-description of participants' gender which can be either 'Weiblich' for Female, 'Männlich' for Male, or 'Divers'.
|GeneralComments| Room for further comments concerning the experiment.|
|gender| Self-description of participants' gender which can be either 'female', 'male', or 'xdivers'.

### subjects
The table 'subjects' summarizes data for each individual in each period, i.e. 14 observations for each period and cohort. 

| Variable | Description |
---| ---|
|subjectID| ID variable, which uniquely identifies each participant from '1' to '382'.|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Subject| ID variable, which identifies participants within an experimental session from '1' to '14'.|
|Group| ID variable, which identifies participants' group within an experiemntal session from '1' to '2'.|
|client| ID variable, which identifies participants within an experimental session.|
|Period| Period index, ranging from '1' to '12'.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|Location| City index, which is either 'Graz' or 'Vienna'.|
|Role| Participant role index which is either 'Informed trader', 'Uninformed trader', 'Observer', or 'Experimenter'.|
|IsInsider| Participant role index which is either '1' for informed traders or '0' otherwise.|
|IsExperimenter| Participant role index which is either '1' for the experimenter or '0' otherwise.|
|IsAuthority| Participant role index which is either '1' for observers or '0' otherwise.|
|InitialAssets[1]| Number of assets this participant is endowed at the beginning of this period.|
|Assets[1]| Number of assets this participants holds at market closing of this period.|
|InitialCash| Monetary units this participant is endowed at the beginning of this period.|
|Cash| Monetary units this participants holds at market closing of this period.|
|InitialEndowment| Initial asset endowment time the buyback value plus the initial monetary units.|
|EndVermoegen| Asset endowment times the buyback value plus the monetary units at market closing before redistributions and punishment.|
|EndEndowmentPun| Asset endowment times the buyback value plus the monetary units at market closing after redistributions and punishment.|
|Punished[1]| Binary variable which is either '1' when this trader is informed and correctly identified in the top market, or '0' otherwise.|
|Punished[2]| Binary variable which is either '1' when this trader is informed and correctly identified in the bottom market, or '0' otherwise.|
|TradingProfit[1]| Trading profits from market participation in experimental monetary units before redistribution and punishment in the top market.|
|TradingProfit[2]| Trading profits from market participation in experimental monetary units before redistribution and punishment in the bottom market.|
|CompensationReceived[1]| Sum of redistributions and punishement payments lost or received in the top market.|
|CompensationReceived[2]| Sum of redistributions and punishement payments lost or received in the bottom market.|
|ProfitPeriod| Profit from market participation in Euro after redistribution and punishment.|
|PD| Wealth change after redistribution and punishment.|
|VolumeTransactions[1]| Number of assets transacted in the top market.|
|VolumeTransactions[2]| Number of assets transacted in the bottom market.|
|LimitVol[1]| Number of assets offered in limit orders in the top market.|
|LimitVol[2]| Number of assets offered in limit orders in the bottom market.|
|CancelledVol[1]| Number of offered assets withdrawn before market closing in the top market.|
|CancelledVol[2]| Number of offered assets withdrawn before market closing in the bottom market.|
|VolMarketTran[1]| Number of accepted assets in market orders in the top market.|
|VolMarketTran[2]| Number of accepted assets in market orders in the bottom market.|
|VolLimitTran[1]| Number of offered assets accepted by another trader in the top market.|
|VolLimitTran[2]| Number of offered assets accepted by another trader in the bottom market.|
|Transactions[1]| Number of transactions in the top market.|
|Transactions[2]| Number of transactions in the bottom market.|
|VolPurch[1]| Number of assets purchased in the top market.|
|VolPurch[2]| Number of assets purchased in the bottom market.|
|VolSold[1]| Number of assets sold in the top market.|
|VolSold[2]| Number of assets sold in the bottom market.|
|TotalProfit| Profit from participation in Euro at the end of an experimental session.|
|ObserverStrategy| Self-description of observers at the end of the experiment how they use information: PostQ1: 'Please describe how you think the available information (1. volume limit; 2. volume limit deleted; 3. trading volume limit; 4. trading volume market; 5. volume purchased; 6. volume sold; 7. volume purchased - sold; 8. average price; 9. average volume) can be used to identify informed traders!'.|
|WhichMarket| Self-description of traders at the end of the experiment how they estimate the probability of a detection of informed traders. PostQ2: 'Please describe, which criteria were decisive for you, when choosing which market to trade on!'.|
|ProbabilityDetected| Self-description of traders at the end of the experiment how they estimate the probability of a detection of informed traders. PostQ3: 'How high do you estimate the probability that an observer correctly identifies a trader with information as such.'.|
|StrategyTrader| Self-description of traders at the end of the experiment of their trading strategy. PostQ4: 'What strategies did you use to avoid being recognized by observers as a trader with information?'.|
|OpinionPenalty| Self-description of participants at the end of the experiment about their opinion on the appropriateness of the penalty. PostQ5: 'If a trader with information is correctly selected by the observer, he loses his trading profit and must pay an additional penalty equal to the trading profit. Please indicate whether you consider this penalty to be appropriate, too low, or too high.'.|
|RiskGeneral| Self-description of participants' risk tolerance at the end of the experiment. PostQ6: 'How do you see yourself: are you generally a person who is fully prepared to take risks or do you try to avoid taking risks?'.|
|RiskFinancial| Self-description of participants' financial risk tolerance at the end of the experiment. PostQ7 'People can behave differently in different situations. How would you rate your willingness to take risks in financial matters?'.|
|LossAversion| Self-description of participants loss tolerance at the end of the experiment. PostQ8 'In financial decisions, both gains and losses are possible. To what extent do possible losses compared to possible gains influence you?'.|
|Department| Self-description of participants' department of studies. PostQ9: 'Which faculty are you studying at?'.|
|MajorOther| If they specified other at department, they are asked to specify here their faculty.|
|Age| Self-description of participants' age. PostQ10a: 'Age in years'.|
|Female| Self-description of participants' gender which can be either 'Weiblich' for Female, 'Männlich' for Male, or 'Divers'.
|GeneralComments| Room for further comments concerning the experiment.|
|gender| Self-description of participants' gender which can be either 'female', 'male', or 'xdivers'.

### phasesummary
The table 'phasesummary' summarizes data for each phase, market, and trader type and for the overall market, i.e. three observations for each trader type times two markets times three phases constitute 18 observations for each cohort.

| Variable | Description |
---| ---|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Role| Trader type index which is either 'Informed trader', 'Uninformed trader', or 'market'.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|history| Treatment index specifying the regulation in previous Phases, which is either '1' for markets in Phase 1, 'N' (resp. 'R') for markets in Phase 2 which succeeded NOREG (REG) markets, 'N.N', 'N.R', 'R.N', or 'R.R' for markets in Phase 3.| 
|Location| City index, which is either 'Graz' or 'Vienna'.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a phase apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is eiterh '1' when markets in Phase 2 apply regulation or '0' otherwise.|
|Volume| Number of assets transacted in a phase.|
|LimitVolume| Number of assets offered in limit orders in a phase.|
|NumActiveTrader| Number of traders who either placed a limit order or accepted a market order.|
|PR| Participation Rate - Number of active traders divided by the total number of traders.|
|CancelledVolume| Number of offered assets withdrawn before market closing.|
|TraderCount| Number of traders times periods in a phase.|
|obs| Number of market observations, i.e. number of markets with activity.|
|TraderVolume| Number of assets transacted per trader in a phase.|
|TraderLimitVolume| Number of assets offered in limit orders per trader in a phase.|
|shortsells| Number of assets sold with negative asset endowment using the short limit capacity.|
|marginbuysTaler| Money spend to buy assets with negative money endowment using the credit limit.|
|marginbuysAsset| Purchases with negative money endowments divided by the transaction price.|
|marginbuys| Purchases with negative money endowments divided by the buyback value.|
|odds| Ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (arithmetic averages).|
|odds_start| Ratio of transacted volume between simultaneously operating market of the same cohort in Phase 1.|
|odds_middle| Ratio of transacted volume between simultaneously operating market of the same cohort in Phase 2.|
|odds_end| Ratio of transacted volume between simultaneously operating market of the same cohort in Phase 3.|
|oddsLimit| Ratio of limit order volume over the limit order volume in the other, simultaneously operating markets.|
|oddsLimit_start| Ratio of limit order volume between simultaneously operating market of the same cohort in Phase 1.|
|oddsLimit_middle| Ratio of limit order volume between simultaneously operating market of the same cohort in Phase 2.|
|oddsLimit_end| Ratio of limit order volume between simultaneously operating market of the same cohort in Phase 3.|
|geomodds| Geometric ratio of transacted volume over the transacted volume in the other, simultaneously operating markets (geometric averages).|
|geomoddsLimit| Geometric ratio of limit order volume over the limit order volume in the other, simultaneously operating markets.|
|absgeomodds| Geometric absolute ratio of transacted volume over the transacted volume in the other, simultaneously operating markets.|
|absgeomoddsLimit| Geometric absolute ratio of limit order volume over the limit order volume in the other, simultaneously operating markets.|
|geomodds_start| Geometric ratio of transacted volume between simultaneously operating market of the same cohort in Phase 1.|
|geomodds_middle| Geometric ratio of transacted volume between simultaneously operating market of the same cohort in Phase 2.|
|geomodds_end| Geometric ratio of transacted volume between simultaneously operating market of the same cohort in Phase 3.|
|geomoddsLimit_start| Geometric ratio of limit order volume between simultaneously operating market of the same cohort in Phase 1.|
|geomoddsLimit_middle| Geometric ratio of limit order volume between simultaneously operating market of the same cohort in Phase 2.|
|geomoddsLimit_end| Geometric ratio of limit order volume between simultaneously operating market of the same cohort in Phase 3.|
|marketshare| Ratio of transacted volume over the transacted volume of simultaneously operating markets.|
|marketshareLimit| Ratio of limit order volume over the limit order volume of simultaneously operating markets.|
|d1| Difference in odds between this phase and Phase 1.|
|d2| Difference in odds between this phase and Phase 2.|
|d3| Difference in odds between this phase and Phase 3.|
|d1r| Difference in odds between this phase and Phase 1 dividing odds by the number of periods in the resp. phase.|
|d2r| Difference in odds between this phase and Phase 2 dividing odds by the number of periods in the resp. phase.|
|d3r| Difference in odds between this phase and Phase 3 dividing odds by the number of periods in the resp. phase.|
|d1P| Difference in geometric odds between this phase and Phase 1.|
|d2P| Difference in geometric odds between this phase and Phase 2.|
|d3P| Difference in geometric odds between this phase and Phase 3.|

### observers
The table 'observers' summarizes data for each observer in each period, i.e. two observations for each period and cohort. 

| Variable | Description |
---| ---|
|subjectID| ID variable, which uniquely identifies each participant from '1' to '382'.|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Subject| ID variable, which identifies participants within an experimental session from '1' to '14'.|
|client| ID variable, which identifies participants within an experimental session.|
|Period| Period index, ranging from '1' to '12'.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|Location| City index, which is either 'Graz' or 'Vienna'.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|Role| Participants' role index which is 'Observer'.|
|NumSelected| Number of traders suspected to be informed after market closing.|
|NumDetections| Number of traders correctly identified to be informed after market closing.|
|NumPunished| Number of traders correctly identified to be informed in the regulatory regime REG after market closing.|
|NumSelected| Number of traders incorrectly suspected to be informed after market closing.|
|ProfitPeriod| Profit from market observation in Euro.|
|ObserverStrategy| Self-description of observers at the end of the experiment how they use information: PostQ1: 'Please describe how you think the available information (1. volume limit; 2. volume limit deleted; 3. trading volume limit; 4. trading volume market; 5. volume purchased; 6. volume sold; 7. volume purchased - sold; 8. average price; 9. average volume) can be used to identify informed traders!'.|
|OpinionPenalty| Self-description of participants at the end of the experiment about their opinion on the appropriateness of the penalty. PostQ5: 'If a trader with information is correctly selected by the observer, he loses his trading profit and must pay an additional penalty equal to the trading profit. Please indicate whether you consider this penalty to be appropriate, too low, or too high.'.|
|RiskGeneral| Self-description of participants' risk tolerance at the end of the experiment. PostQ6: 'How do you see yourself: are you generally a person who is fully prepared to take risks or do you try to avoid taking risks?'.|
|RiskFinancial| Self-description of participants' financial risk tolerance at the end of the experiment. PostQ7 'People can behave differently in different situations. How would you rate your willingness to take risks in financial matters?'.|
|LossAversion| Self-description of participants loss tolerance at the end of the experiment. PostQ8 'In financial decisions, both gains and losses are possible. To what extent do possible losses compared to possible gains influence you?'.|
|Department| Self-description of participants' department of studies. PostQ9: 'Which faculty are you studying at?'.|
|MajorOther| If they specified other at department, they are asked to specify here their faculty.|
|Age| Self-description of participants' age. PostQ10a: 'Age in years'.|
|Female| Self-description of participants' gender which can be either 'Weiblich' for Female, 'Männlich' for Male, or 'Divers'.
|GeneralComments| Room for further comments concerning the experiment.|
|gender| Self-description of participants' gender which can be either 'female', 'male', or 'xdivers'.

### transactions
The table 'transactions' summarizes data for each acceptence of a limit order, i.e. one observation per market order.

| Variable | Description |
---| ---|
|transactionID| ID variable, which uniquely identifies each market order from '1' to '23549'.|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Period| Period index, ranging from '1' to '12'.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|Location| City index, which is either 'Graz' or 'Vienna'.|
|BBV| Buyback Value.|
|BBVCent| Buyback Value centralized by the unconditional expected value of 57.5.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a period apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is eiterh '1' when a market in Phase 2 applies regulation or '0' otherwise.|
|offerID| ID variable, which uniquely identifies each limit order from '1' to '19390'.|
|type| Limit order index specifying whether the liquidity provider offers to buy ('BuyingOffer') or to sell ('SellingOffer').|
|takerID| ID variable, which uniquely identifies the liquidity taker from '1' to '382'.|
|makerID| ID variable, which uniquely identifies the liquidity provider from '1' to '382'.|
|makerRole | Trader type index for the liquidity taker which is either 'Informed trader' or 'Uninformed trader'.|
|takerRole| Trader type index for the liquidity provider which is either 'Informed trader' or 'Uninformed trader'.|
|BuyerID| ID variable, which uniquely identifies the buying party from '1' to '382'.|
|SellerID| ID variable, which uniquely identifies the selling party from '1' to '382'.|
|orderID| ID variable, which uniquely identifies each withdrawal, limit, and market order from '1' to '19390'.|
|Price| Price of the transactions at which the asset is bought and sold.|
|Volume| Number of assets transacted via this market order.|
|remainingVolExAnte| Number of assets offered via the respective limit order before this market order.|
|remainingVolExPost| Number of assets offered via the respective limit order after the execution of this market order.|
|SellersProfit| Trading profit in Taler of the selling party by this market order.|
|MakersProfit| Trading profit in Taler of the liquidity provider by this market order.|
|shortsells| Number of assets sold by the selling party with negative asset endowment using the short limit capacity.|
|marginbuysTaler| Money spend to buy assets by the buying party with negative money endowment using the credit limit.|
|marginbuysAsset| Purchases by the buying party with negative money endowments divided by the transaction price.|
|Pricewins| Price of the transactions at which the asset is bought and sold after a symmetric 90% winsorization of prices.|
L.Pricewins| Last price before this market order after a symmetric 90% winsorization of prices.|
|L.Price| Last price before this market order.|
|return| Log price change between transactions, i.e., ln('Price') - ln('L.Price').|
|returnwins| Log price change between transactions after a symmetric 90% winsorization of prices.|
|returnwins2| Log price change between transactions after a symmetric 90% winsorization of returns.|
|Time| Time in seconds that has been passed since z-Tree has been started until the market order was executed.|
|transactionVol| Number of assets transacted via this market order.|
|OfferTime| Time in seconds that has been passed since z-Tree has been started until the limit order was placed.|
|AuctionStartTime| Time in seconds that has been passed since z-Tree has been started until the start of the auction.|
|AuctionEndTime| Time in seconds that has been passed since z-Tree has been started until the end of the auction.|
|offertime| Time in seconds that has been passed since the start of the auction until the limit order was placed.|
|transactiontime| Time in seconds that has been passed since the start of the auction until the market order was executed.|

### offers
The table 'offers' summarizes data for each placement of a limit order, i.e. one observation per limit order.

| Variable | Description |
---| ---|
|offerID| ID variable, which uniquely identifies each limit order from '1' to '19390'.|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Period| Period index, ranging from '1' to '12'.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|Location| City index, which is either 'Graz' or 'Vienna'.|
|BBV| Buyback Value.|
|BBVCent| Buyback Value centralized by the unconditional expected value of 57.5.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a period apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is eiterh '1' when a market in Phase 2 applies regulation or '0' otherwise.|
|type| Limit order index specifying whether the liquidity provider offers to buy ('BuyingOffer') or to sell ('SellingOffer').|
|makerID| ID variable, which uniquely identifies the liquidity provider from '1' to '382'.|
|makerRole | Trader type index for the liquidity taker which is either 'Informed trader' or 'Uninformed trader'.|
|status| Limit order index, which is either 'cancelled' if this limit order got cancelled somewhen throughout the auction, 'on market' if this limit order remaind in the order book at market closing, 'sold out' when all assets were accepted by another party, or 'fully invalidated' when they are no longer feasible at market closing.|
|Price| Price of the limit order at which the asset is offered to buy or sell.|
|Volume| Number of assets offered via this limit order.|
|LimitVolume| Number of assets offered via this limit order.|
|totTransacted| Number of assets transacted via this limit order.|
|CancelledVolume| Number of assets cancelled of this limit order.|
|remainingVol| Number of assets offered via this limit order at market closing.|
|BuyVol| Number of assets offered via this limit order which the liquidity provided offered to buy.|
|SellVol| Number of assets offered via this limit order which the liquidity provided offered to sell.|
|AuctionStartTime| Time in seconds that has been passed since z-Tree has been started until the start of the auction.|
|AuctionEndTime| Time in seconds that has been passed since z-Tree has been started until the end of the auction.|
|offertime| Time in seconds that has been passed since the start of the auction until the limit order was placed.|
|offertimeEnd| Time in seconds that has been passed since the start of the auction until the end of the respective limit order, i.e., either at market closing, withdrawal, or when the limit order sold out.|

### orders
The table 'orders' summarizes data for each order, i.e. one observation per withdrawal, limit, and market order.

| Variable | Description |
---| ---|
|orderID| ID variable, which uniquely identifies each withdrawal, limit, and market order from '1' to '19390'.|
|offerID| ID variable, which uniquely identifies each limit order from '1' to '19390'.|
|transactionID| ID variable, which uniquely identifies each market order from '1' to '23549'.|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Period| Period index, ranging from '1' to '12'.|
|Phase| Phase index, which is either 'Phase 1' for periods 1 to 3, 'Phase 2' for periods 4 to 9, or 'Phase 3'.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|Location| City index, which is either 'Graz' or 'Vienna'.|
|BBV| Buyback Value.|
|BBVCent| Buyback Value centralized by the unconditional expected value of 57.5.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a period apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is eiterh '1' when a market in Phase 2 applies regulation or '0' otherwise.|
|type| Limit order index specifying whether the liquidity provider offers to buy ('BuyingOffer') or to sell ('SellingOffer').|
|makerID| ID variable, which uniquely identifies the liquidity provider from '1' to '382'.|
|takerID| ID variable, which uniquely identifies the liquidity taker from '1' to '382'.|
|status| Limit order index, which is either 'cancelled' if this limit order got cancelled via this order, 'on market' if this limit order remaind in the order book after this order, 'sold out' when all assets were accepted by another party, or 'fully invalidated' when they are no longer feasible.|
|Price| Price of the limit order at which the asset is offered to buy or sell.|
|Volume| Number of assets offered via this limit order.|
|LimitVolume| Number of assets offered via the respective limit order.|
|transactionVol| Number of assets transacted via the respective market order.|
|totTransacted| Number of assets transacted via the respective limit order.|
|remainingVolExAnte| Number of assets offered via the respective limit order before this order.|
|remainingVolExPost| Number of assets offered via the respective limit order after the execution of this order.|
|AuctionStartTime| Time in seconds that has been passed since z-Tree has been started until the start of the auction.|
|AuctionEndTime| Time in seconds that has been passed since z-Tree has been started until the end of the auction.|
|ordertime| Time in seconds that has been passed since the start of the auction until the order was executed/placed/withdrawn.|
|orderStarttime| Time in seconds that has been passed since the start of the auction until the order was placed, i.e. since the limit order was placed or the last market order was executed.|
|offertime| Time in seconds that has been passed since the start of the auction until the limit order was placed.|
|offertimeEnd| Time in seconds that has been passed since the start of the auction until the end of the respective limit order, i.e., either at market closing, withdrawal, or when the limit order sold out.|

### seconds
The table 'seconds' summarizes data for each second within each market, i.e. 180 observations per period and cohort.

| Variable | Description |
---| ---|
|SessionID| ID variable, which uniquely identifies each session from '1' to '24'.|
|Date| Date and Program Starting Time of the experimental session in format yymmdd_hhmm.|
|Period| Period index, ranging from '1' to '12'.|
|Period0| Period index, ranging from '0' to '5', indicating the distance to the phase’s first period, starting with 0 to facilitate the interpretation of the intercept.|
|market| Market index, which is either 'Bottom' or 'Top' indicating the position on the screen.|
|time| Time in seconds that has been passed since the start of the auction.|
|Programme| Progress index, which is either '1' for the pre-experimental questionnaire, '2' for the training periods, and '3' for the actual experimental data.|
|Treatment| Treatment index, which is either 'NN.NR.RR', 'NN.RN.RR', 'RR.NR.NN', 'RR.NR.RR', 'RR.RN.NN', or 'RR.RN.RR'.|
|regOrder| Treatment index specifying the order of market regulation in Phase 2, which is either 'NR', or 'RN'.| 
|embTreatment| Treatment index specifying the regulation in Phase 1 and 3, which is either'NN.RR'', 'RR.NN'', or 'RR.RR'.|
|history| Treatment index specifying the regulation in previous Phases, which is either '1' for markets in Phase 1, 'N' (resp. 'R') for markets in Phase 2 which succeeded NOREG (REG) markets, 'N.N', 'N.R', 'R.N', or 'R.R' for markets in Phase 3.| 
|Location| City index, which is either 'Graz' or 'Vienna'.|
|MA| Moving average of transaction volume with past volume being weighted by $$\left\{\frac{1}{2}^n\quad\vert\quad n\in\{1,2,\ldots, 8, 9, 9\}\right\}$$.|
|BBV| Buyback Value.|
|BBVCent| Buyback Value centralized by the unconditional expected value of 57.5.|
|IsREG| Regulatory index, which is either 'REG' for regulated markets or 'NOREG'.|
|othermarket| Regulatory index for the simultaneous opposite market, which is either 'REG' for regulated markets or 'NOREG'.|
|REGBoth| Regulatory index which is either '1' when both markets in a period apply regulation or '0' otherwise.|
|REGSH| Regulatory index which is eiterh '1' when a market in Phase 2 applies regulation or '0' otherwise.|
|BestBid| Active bid in the order book at this time which offered the highest bid price.|
|BestAsk| Active ask in the order book at this time which offered assets for the lowest ask price.|
|BAspread| Difference between best bid and best ask price each second.|
|midpointBA| Midpoint between best bid and best ask price each second.|
|last| Last transaction price in a market before this second.|
|lnlastPrice| Log transformed last transaction price in a market.|
|L.lnlastPrice| Log transformed price in a market in the previous second.|
|return| Log-change in prices between last seconds.|
|BestBidwins| Active bid in the order book at this time which offered the highest bid price after a symmetric 90% winsorization of prices.|
|BestAskwins| Active ask in the order book at this time which offered assets for the lowest ask price after a symmetric 90% winsorization of prices.|
|BAspreadwins| Difference between best bid and best ask price each second after a symmetric 90% winsorization of prices.|
|BAspreadwins2| Difference between best bid and best ask price each second after a symmetric 90% winsorization of spreads.|



### Descriptive Statistics table - markets
```{r destable, echo=FALSE}
table <- lapply( marketsummary[c("Volume", "VolumeInf", "VolumeUni", "LimitVolume", "ProfitPotential", "unprofittime", "GD", "GAD", "RD", "RAD", "NumActiveTrader", "AssetTurnover", "TransactionSize", "LimitOrderTurnover", "LimitOrderSize", "relCancelledVolume")], function(x) rbind( mean = mean(x) ,
                                         sd = sd(x) ,
                                         median = median(x) ,
                                         minimum = min(x) ,
                                         maximum = max(x) ,
                                         n = length(x) ) )
data.frame(table)
```


```{r persecond, echo=F, results = 'asis', warning=F}
transactionspersecond <- length(transactions$transactionID)/24/180/12
volumepersecond <- sum(transactions$transactionVol)/24/180/12

```
The number of transactions per second is equal to `r transactionspersecond`, while `r volumepersecond` is the transacted volume per second over all sessions, periods, and markets.

### Descriptive Statistics table - trader

```{r allsubjects, echo=F}
table <- lapply( c(subset(subjects, Role!="Experimenter" & Period==12)["TotalProfit"], subset(subjects, Role=="Observer" & Period==12)["TotalProfit"], subset(subjects, Subject!=17 & Role!="Observer" & Period==12)["TotalProfit"], subset(subjects, Subject!=17 & Role=="Informed trader")["ProfitPeriod"], subset(subjects, Subject!=17 & Role=="Uninformed trader")["ProfitPeriod"]), function(x) rbind( mean = mean(x), 
                                         sd = sd(x) ,
                                         median = median(x) ,
                                         minimum = min(x) ,
                                         maximum = max(x) ,
                                         n = length(x) ) )
names(table) <- c("TotProfit", "ObserverProfit", "TraderProfit", "Informed trader", "Uninformed trader")
data.frame(table)
```

```{r allsubjectsREG, echo=F, result = 'asis'}
table <- lapply( c(subset(subjectsummary, Role=="Informed trader" & IsREG=="REG")["ProfitPeriod"], subset(subjectsummary, Role=="Informed trader" & IsREG=="NOREG")["ProfitPeriod"], subset(subjectsummary, Role=="Uninformed trader"& IsREG=="REG")["ProfitPeriod"], subset(subjectsummary, Role=="Uninformed trader"& IsREG=="NOREG")["ProfitPeriod"]), function(x) rbind( mean = mean(x), 
                                         sd = sd(x) ,
                                         median = median(x) ,
                                         minimum = min(x) ,
                                         maximum = max(x) ,
                                         n = length(x) ) )
names(table) <- c("Informed trader-REG", "Informed trader-NOREG", "Uninformed trader_REG", "Uninformed trader_NOREG")
data.frame(table)
```

```{r destableTrader, echo=FALSE}
subjectsummary$Active <- 0
subjectsummary$Active[subjectsummary$activeTrader=="active"] <- 1
subjectsummary$CAratio <- subjectsummary$InitialCash/subjectsummary$BBV/subjectsummary$InitialAssets
table <- lapply( subjectsummary[c("Volume", "LimitVolume", "TradingProfit", "ProfitPeriod", "Active", "CAratio")], function(x) rbind( mean = mean(x) ,
                                         geoMean = exp(mean(replace(log(x), is.infinite(log(x)), 0), na.rm = T)),
                                         sd = sd(x) ,
                                         median = median(x) ,
                                         minimum = min(x) ,
                                         maximum = max(x) ,
                                         n = length(x) ) )
data.frame(table)
```

### raders’ demographics by treatment (Table WA13).
```{r destablemarkets, echo=FALSE}
#### Table WA13 ####
tableTrader <- t(aggregate(cbind((gender=="female"), (gender=="male"), (Department=="SOWI"), Age, RiskGeneral, RiskFinancial, LossAversion, ProbabilityDetected, OpinionPenalty) ~ embTreatment, data=subjectsummary, function(x) mean(x)))[2:10,]
tableTrader <- data.frame(tableTrader)
colnames(tableTrader) <- c("NN.RR", "RR.NN", "RR.RR")
row.names(tableTrader) <- c("Females", "Males", "Econ", "Age", "RiskGeneral", "RiskFinancial", "LossAversion", "Riskdisclosure", "Opinionpenalty")

kttrfem <- kruskal.test((gender=="female") ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrmal <- kruskal.test((gender=="male") ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrsowi <- kruskal.test((Department=="SOWI") ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrage <- kruskal.test(Age ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrrisk <- kruskal.test(RiskGeneral ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrfinrisk <- kruskal.test(RiskFinancial ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrlossav <- kruskal.test(LossAversion ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttrprdet <- kruskal.test(ProbabilityDetected ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value
kttroppen <- kruskal.test(OpinionPenalty ~ embTreatment, data = subset(subjectsummary, Period == 12 & market == "Top"))$p.value

tableTrader$pvalue <- c(kttrfem, kttrmal, kttrsowi, kttrage, kttrrisk, kttrfinrisk, kttrlossav, kttrprdet, kttroppen)
data.frame(tableTrader)

```

### Wealth distribution 
```{r tablemarketdist, echo = F}
tableDist <- t(aggregate(cbind(HHInitialAssets, HHEndAssets, HHInitialEndowment, HHEndEndowment, HHEndEndowmentPun, HHVolume, HHPDbefore, HHPDPun, HHI_InitialAssets, HHI_EndAssets, HHI_InitialEndowment, HHI_EndEndowment, HHI_EndEndowmentPun, HHI_Volume, HHI_PDbefore, HHI_PDPun, GiniPDbefore, GiniPDPun, GiniProfit, GiniAssets, GiniEndowment) ~ embTreatment, data=marketsummary, function(x) mean(x)))
tableDist <- data.frame(tableDist)
colnames(tableDist) <- c("NN.RR", "RR.NN", "RR.RR")

data.frame(tableDist)
```

### Informed traders' activity per trader
```{r destableuninformed, echo=FALSE}
table <- lapply(subset(subjectsummary, Role=="Informed trader", select = c("Volume", "LimitVolume", "TradingProfit", "ProfitPeriod", "Active", "TPUnProfitTransaction", "VolUnprofitTransaction", "NumUnprofitTransactions")), function(x) rbind( mean = mean(x) ,
                                         sd = sd(x) ,
                                         median = median(x) ,
                                         minimum = min(x) ,
                                         maximum = max(x) ,
                                         n = length(x) ) )
data.frame(table)
```

### Uninformed traders' activity per trader
```{r destableinformed, echo=FALSE}
table <- lapply(subset(subjectsummary, Role=="Uninformed trader", select = c("Volume", "LimitVolume", "TradingProfit", "ProfitPeriod", "Active", "TPUnProfitTransaction", "VolUnprofitTransaction", "NumUnprofitTransactions")), function(x) rbind( mean = mean(x) ,
                                         sd = sd(x) ,
                                         median = median(x) ,
                                         minimum = min(x) ,
                                         maximum = max(x) ,
                                         n = length(x) ) )
data.frame(table)
```

### Observers' performance by treatment (Table WA12). 
```{r destableobservers, echo=FALSE}
### Table WA12 ####
tableObs <- t(aggregate(cbind(NumSelected/14, (NumSelected>0),NumDetections/4, (NumDetections>0)) ~ embTreatment, data=observers, function(x) mean(x)))[2:5,]
tableObs <- data.frame(tableObs)
colnames(tableObs) <- c("NN.RR", "RR.NN", "RR.RR")
row.names(tableObs) <- c("Selected", "Any selected", "Unveiled", "Any unveiled")
observers2 <- aggregate(cbind(NumSelected, (NumSelected>0), NumDetections, (NumDetections>0), 1) ~ subjectID + Treatment + embTreatment, data=observers, FUN=sum)

ktobsSel <- kruskal.test(NumSelected ~ embTreatment, data = observers2)$p.value
ktobsASel <- kruskal.test(V2 ~ embTreatment, data = observers2)$p.value
ktobsPun <- kruskal.test(NumDetections ~ embTreatment, data = observers2)$p.value
ktobsAPun <- kruskal.test(V4 ~ embTreatment, data = observers2)$p.value

tableObs$pvalue <- c(ktobsSel, ktobsASel, ktobsPun, ktobsAPun)
data.frame(tableObs)

```



## Active trader

Traders are active, if they either placed a limit order or accepted a market order..


```{r activetrader, echo=FALSE ,fig.cap="Participation rates and traders’ mean trading volume in a market by regulatory regime, trader type, and phase (Figure 1).", warning=F}
### Figure 1 ####
# Data for Figure 5 ##
avgtraderphasesummary <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset, VolumeSold, VolumePurchased) ~ Role + Phase + IsREG, data=subjectsummary, function(x) mean(x))
colnames(avgtraderphasesummary)[colnames(avgtraderphasesummary) == "V7"] <- "PR"
avgtraderphasesummary2 <- reshape2::melt(subset(avgtraderphasesummary), id.vars = c("Phase", "IsREG", "Role"))
avgtraderphasesummaryul <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset, VolumeSold, VolumePurchased) ~ Role + Phase + IsREG, data=subjectsummary, function(x) quantile(x, probs = 0.975))
colnames(avgtraderphasesummaryul) <- c("Role", "Phase","IsREG", "ulVolume", "ulLimitVolume", "ulTradingProfit", "ulTPUnits", "ulTPUnitsPun", "ulProfitPeriod", "ulPR", "ulPDbefore", "ulPDPun", "ulPDRedist", "ulPDbeforeVol", "ulPDPunVol", "ulPDRedistVol", "ulV14", "ulV15", "ulV16", "ulV17", "ulV18", "ulV19", "ulshortsells", "ulmarginbuys", "ulmarginbuysAsset", "ulVolumeSold", "ulVolumePurchased")
avgtraderphasesummaryll <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset, VolumeSold, VolumePurchased) ~ Role + Phase + IsREG, data=subjectsummary, function(x) quantile(x, probs = 0.025))
colnames(avgtraderphasesummaryll) <- c("Role", "Phase","IsREG", "llVolume", "llLimitVolume", "llTradingProfit", "llTPUnits", "llTPUnitsPun", "llProfitPeriod", "llPR", "llPDbefore", "llPDPun", "llPDRedist", "llPDbeforeVol", "llPDPunVol", "llPDRedistVol", "llV14", "llV15", "llV16", "llV17", "llV18", "llV19", "llshortsells", "llmarginbuys", "llmarginbuysAsset", "llVolumeSold", "llVolumePurchased")
avgtraderphasesummarysd <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset, VolumeSold, VolumePurchased) ~ Role + Phase + IsREG, data=subjectsummary, function(x) sd(x))
colnames(avgtraderphasesummarysd)[colnames(avgtraderphasesummarysd) == "V7"] <- "PR"
avgtraderphasesummary2sd <- reshape2::melt(subset(avgtraderphasesummarysd), id.vars = c("Phase", "IsREG", "Role"))
colnames(avgtraderphasesummary2sd)[colnames(avgtraderphasesummary2sd) == "value"] <- "sd"
colnames(avgtraderphasesummarysd) <- c("Role", "Phase","IsREG", "sdVolume", "sdLimitVolume", "sdTradingProfit", "sdTPUnits", "sdTPUnitsPun", "sdProfitPeriod", "sdPR", "sdPDbefore", "sdPDPun", "sdPDRedist", "sdPDbeforeVol", "sdPDPunVol", "sdPDRedistVol", "sdV14", "sdV15", "sdV16", "sdV17", "sdV18", "sdV19", "sdshortsells", "sdmarginbuys", "sdmarginbuysAsset", "sdVolumeSold", "sdVolumePurchased")
avgtraderphasesummaryn <- aggregate(Volume ~ Role + Phase + IsREG, data=subjectsummary, function(x) length(x))
colnames(avgtraderphasesummaryn) <- c("Role", "Phase","IsREG", "n")
avgtraderphasesummary <- merge(avgtraderphasesummary, avgtraderphasesummaryn, by = c("Role" ,"Phase","IsREG"))
avgtraderphasesummary <- merge(avgtraderphasesummary, avgtraderphasesummaryul, by = c("Role", "Phase","IsREG"))
avgtraderphasesummary <- merge(avgtraderphasesummary, avgtraderphasesummaryll, by = c("Role", "Phase","IsREG"))
avgtraderphasesummary <- merge(avgtraderphasesummary, avgtraderphasesummarysd, by = c("Role", "Phase","IsREG"))
avgtraderphasesummary$uplVolume <- avgtraderphasesummary$Volume+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolVolume <- avgtraderphasesummary$Volume+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplLimitVolume <- avgtraderphasesummary$LimitVolume+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdLimitVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolLimitVolume <- avgtraderphasesummary$LimitVolume+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdLimitVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplVolumeSold <- avgtraderphasesummary$VolumeSold+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolVolumeSold <- avgtraderphasesummary$VolumeSold+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplVolumePurchased <- avgtraderphasesummary$VolumePurchased+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolVolumePurchased <- avgtraderphasesummary$VolumePurchased+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdVolume/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplTradingProfit <- avgtraderphasesummary$TradingProfit+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdTradingProfit/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolTradingProfit <- avgtraderphasesummary$TradingProfit+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdTradingProfit/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplTPUnits <- avgtraderphasesummary$TPUnits+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdTPUnits/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolTPUnits <- avgtraderphasesummary$TPUnits+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdTPUnits/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplTPUnitsPun <- avgtraderphasesummary$TPUnitsPun+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdTPUnitsPun/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolTPUnitsPun <- avgtraderphasesummary$TPUnitsPun+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdTPUnitsPun/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplProfitPeriod <- avgtraderphasesummary$ProfitPeriod+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdProfitPeriod/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolProfitPeriod <- avgtraderphasesummary$ProfitPeriod+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdProfitPeriod/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPR <- avgtraderphasesummary$PR+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPR/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPR <- avgtraderphasesummary$PR+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPR/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPDbefore <- avgtraderphasesummary$PDbefore+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDbefore/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPDbefore <- avgtraderphasesummary$PDbefore+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDbefore/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPDPun <- avgtraderphasesummary$PDPun+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDPun/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPDPun <- avgtraderphasesummary$PDPun+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDPun/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPDRedist <- avgtraderphasesummary$PDRedist+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDRedist/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPDRedist <- avgtraderphasesummary$PDRedist+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDRedist/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPDbeforeVol <- avgtraderphasesummary$PDbeforeVol+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDbeforeVol/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPDbeforeVol <- avgtraderphasesummary$PDbeforeVol+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDbeforeVol/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPDPunVol <- avgtraderphasesummary$PDPunVol+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDPunVol/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPDPunVol <- avgtraderphasesummary$PDPunVol+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDPunVol/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplPDRedistVol <- avgtraderphasesummary$PDRedistVol+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDRedistVol/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolPDRedistVol <- avgtraderphasesummary$PDRedistVol+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdPDRedistVol/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplshortsells <- avgtraderphasesummary$shortsells+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdshortsells/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolshortsells <- avgtraderphasesummary$shortsells+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdshortsells/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplmarginbuys <- avgtraderphasesummary$marginbuys+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdmarginbuys/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolmarginbuys <- avgtraderphasesummary$marginbuys+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdmarginbuys/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$uplmarginbuysAsset <- avgtraderphasesummary$marginbuysAsset+qt(.975,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdmarginbuysAsset/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$dolmarginbuysAsset <- avgtraderphasesummary$marginbuysAsset+qt(.025,avgtraderphasesummary$n-1)*avgtraderphasesummary$sdmarginbuysAsset/sqrt(avgtraderphasesummary$n)
avgtraderphasesummary$Phase <- factor(avgtraderphasesummary$Phase, levels = c("Phase 1", "Phase 2", "Phase 3"))
avgtraderphasesummary$maxV <- max(avgtraderphasesummary$uplVolume)
avgtraderphasesummary$Role <- factor(avgtraderphasesummary$Role, labels = c("Informed\ntraders","Uninformed\ntraders"))
avgtraderphasesummary$Role <- ordered(avgtraderphasesummary$Role, levels = c("Informed\ntraders","Uninformed\ntraders"))

avgtraderphasesummary2 <- merge(avgtraderphasesummary2, avgtraderphasesummary2sd, by = c("Role", "Phase","IsREG", "variable"))
avgtraderphasesummary2 <- merge(avgtraderphasesummary2, avgtraderphasesummaryn, by = c("Role", "Phase","IsREG"))
avgtraderphasesummary2$upl <- avgtraderphasesummary2$value+qt(.975,avgtraderphasesummary2$n-1)*avgtraderphasesummary2$sd/sqrt(avgtraderphasesummary2$n)
avgtraderphasesummary2$dol <- avgtraderphasesummary2$value+qt(.025,avgtraderphasesummary2$n-1)*avgtraderphasesummary2$sd/sqrt(avgtraderphasesummary2$n)
avgtraderphasesummary2$Phase <- factor(avgtraderphasesummary2$Phase, levels = c("Phase 1", "Phase 2", "Phase 3"))
avgtraderphasesummary2$Role <- factor(avgtraderphasesummary2$Role, labels = c("Informed\ntraders","Uninformed\ntraders"))
avgtraderphasesummary2$Role <- ordered(avgtraderphasesummary2$Role, levels = c("Informed\ntraders","Uninformed\ntraders"))
avgtraderphasesummary2$Variable <- as.character(avgtraderphasesummary2$variable)
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "LimitVolume"] <- "Limit volume"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "Volume"] <- "Traders' mean trading volume"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PR"] <- "Participation rate"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "shortsells"] <- "Short sells"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "marginbuysAsset"] <- "Margin buys"

avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PDbefore"] <- "Trading profig before redistribution"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PDredist"] <- "Trading profig after redistribution"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PDPun"] <- "Trading profig after punishment"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PDbeforeVol"] <- "Trading profig before redistribution per transacted asset"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PDredistVol"] <- "Trading profig after redistribution per transacted asset"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "PDPunVol"] <- "Trading profig after punishment per transacted asset"

avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "V14"] <- "PDbeforePos"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "V17"] <- "PDbeforePos"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "V15"] <- "PDPunPos"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "V18"] <- "PDPunPos"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "V16"] <- "PDRedisPos"
avgtraderphasesummary2$Variable[avgtraderphasesummary2$variable == "V19"] <- "PDRedisPos"

## Data for Table WA1
tPRInf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPRUni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPR1Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPR1Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPR2Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPR2Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPR3Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPR3Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPR13Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPR13Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVolInf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVolUni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol2Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol2Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol3Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol3Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolInf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolUni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

dat_textPR <- data.frame(
  label = c(paste0("p = ",tPR1Inf,""), paste0("p = ",tPR1Uni,""), paste0("p = ",tPR2Inf,""), paste0("p = ",tPR2Uni,""), paste0("p = ",tPR3Inf,""),paste0("p = ",tPR3Uni,""),paste0("p = ",tVol1Inf,""),paste0("p = ",tVol1Uni,""),paste0("p = ",tVol2Inf,""),paste0("p = ",tVol2Uni,""),paste0("p = ",tVol3Inf,""),paste0("p = ",tVol3Uni,"")),
  IsREG = c("REG", "REG", "NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG"),
  Role = c("Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders"),
  Phase = c("Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3", "Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3"),
  Variable = c("Participation rate", "Participation rate", "Participation rate","Participation rate","Participation rate","Participation rate","Traders' mean trading volume","Traders' mean trading volume","Traders' mean trading volume", "Traders' mean trading volume", "Traders' mean trading volume", "Traders' mean trading volume"),
  vjust = c(0,0,0,0,0,0,20,20,20,20,20,20)
  )

#postscript("Figures/GraphvolumePhaseallTreat.eps")
ggplot(data=subset(avgtraderphasesummary2, variable == "Volume" | variable =="PR"), aes(y= value, x= Role, group=(IsREG), fill = IsREG)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.5))+ 
  labs(y="") +
  geom_text(data = subset(dat_textPR, Variable == "Participation rate"), mapping = aes(x = Role, y = 1.06 + 1.7*vjust, label = label), color = "black", size = 4) +
  geom_text(data = subset(dat_textPR, Variable == "Traders' mean trading volume"), mapping = aes(x = Role, y = 1.06 + 1.7*vjust, label = label), color = "black", size = 4) +
  theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(Variable ~ Phase, scales = "free") +
  scale_fill_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  scale_color_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  geom_errorbar(aes(ymin = dol, ymax = upl), width=.2, color = 'black', position=position_dodge(width=0.5))
#dev.off()
```

### Participation rates and traders’ mean volumes by regulatory regime, trader type, and phase (Table WA1).
```{r activetradermarket, echo = F}
### Table WA1 ####
ePRInf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePRUni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR1Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR1Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR2Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR2Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR3Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR3Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR13Inf <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePR13Uni <- format(round(t.test((LimitVolume>0 | Volume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVolInf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVolUni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol1Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol1Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol2Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol2Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol3Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol3Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol13Inf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol13Uni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)

eLimitVolInf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVolUni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol1Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol1Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Period < 4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol2Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol2Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>3 & Period < 10 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol3Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol3Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol13Inf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol13Uni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase != "Phase 2" & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)


dat_PR <- data.frame( c(ePRInf, tPRInf, ePRUni, tPRUni), c(ePR1Inf, tPR1Inf, ePR1Uni, tPR1Uni), c(ePR2Inf, tPR2Inf, ePR2Uni, tPR2Uni), c(ePR3Inf, tPR3Inf, ePR3Uni, tPR3Uni), c(ePR13Inf, tPR13Inf, ePR13Uni, tPR13Uni),
                       c(eVolInf, tVolInf, eVolUni, tVolUni), c(eVol1Inf, tVol1Inf, eVol1Uni, tVol1Uni), c(eVol2Inf, tVol2Inf, eVol2Uni, tVol2Uni), c(eVol3Inf, tVol3Inf, eVol3Uni, tVol3Uni), c(eVol13Inf, tVol13Inf, eVol13Uni, tVol13Uni), 
c(eLimitVolInf, tLimitVolInf, eLimitVolUni, tLimitVolUni), c(eLimitVol1Inf, tLimitVol1Inf, eLimitVol1Uni, tLimitVol1Uni), c(eLimitVol2Inf, tLimitVol2Inf, eLimitVol2Uni, tLimitVol2Uni), c(eLimitVol3Inf, tLimitVol3Inf, eLimitVol3Uni, tLimitVol3Uni), c(eLimitVol13Inf, tLimitVol13Inf, eLimitVol13Uni, tLimitVol13Uni)
                      )
dat_PR <- t(dat_PR)
colnames(dat_PR) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_PR) <- c("PR all phases", "PR Phase 1", "PR Phase 2", "PR Phase 3", "PR Phase 1 & 3", "Vol all phases", "Vol Phase 1", "Vol Phase 2", "Vol Phase 3", "Vol Phase 1 & 3", "LimitVol all phases", "LimitVol Phase 1", "LimitVol Phase 2", "LimitVol Phase 3", "LimitVol Phase 1 & 3")

dat_PR
```


### Proportions test for traders' participation rates
```{r ttestactiveall, echo = F}
t1 <- sum(with(subset(subjectsummary, Period > 0 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 0 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 0 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 0 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPRUni <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

t1 <- sum(with(subset(subjectsummary, Period > 0 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 0 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 0 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 0 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPRInf <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)


t1 <- sum(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPR1Uni <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

t1 <- sum(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 0 & Period < 4 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPR1Inf <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

t1 <- sum(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPR2Uni <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

t1 <- sum(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 3 & Period < 10 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPR2Inf <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

t1 <- sum(with(subset(subjectsummary, Period > 9 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 9 & Role=="Uninformed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 9 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 9 & Role=="Uninformed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPR3Uni <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

t1 <- sum(with(subset(subjectsummary, Period > 9 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t1s <- length(with(subset(subjectsummary, Period > 9 & Role=="Informed trader" & IsREG == "REG"), as.numeric(LimitVolume>0 | Volume>0)))
t2s <- length(with(subset(subjectsummary, Period > 9 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
t2 <- sum(with(subset(subjectsummary, Period > 9 & Role=="Informed trader" & IsREG == "NOREG"), as.numeric(LimitVolume>0 | Volume>0)))
ptPR3Inf <- format(round(prop.test(c(t1,t2), c(t1s,t2s))$p.value, digits = 4), scientific = FALSE)

dat_PR2 <- data.frame( c(ePRInf, tPRInf, ptPRInf, ePRUni, tPRUni, ptPRUni), c(ePR1Inf, tPR1Inf, ptPR1Inf, ePR1Uni, tPR1Uni, ptPR1Uni), c(ePR2Inf, tPR2Inf, ptPR2Inf, ePR2Uni, tPR2Uni, ptPR2Uni), c(ePR3Inf, tPR3Inf, ptPR3Inf, ePR3Uni, tPR3Uni, ptPR3Uni)
                      )
dat_PR2 <- t(dat_PR2)
colnames(dat_PR2) <- c("NOREG", "REG", "pvalues_Informed","pvalues_prob_test_Informed", "NOREG", "REG", "pvalues_Uninformed","pvalues_prob_test_Uninformed")
row.names(dat_PR2) <- c("PR all phases", "PR Phase 1", "PR Phase 2", "PR Phase 3")

dat_PR2
```

```{r PRtableAll, echo=F, results = 'asis', warning=F}
### Table WA2 ####
lnPRmiddleUninf <- lm(ParticipationRate_Uninf ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
lnPRmiddleInf <- lm(ParticipationRate_Inf ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
lnPRbeginningUninf <- lm(ParticipationRate_Uninf ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period <=3))
lnPRbeginningInf <- lm(ParticipationRate_Inf ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period <=3))
lnPRendUninf <- lm(ParticipationRate_Uninf ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
lnPRendInf <- lm(ParticipationRate_Inf ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))

lnPRallUninf <- lm(ParticipationRate_Uninf ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))
lnPRallInf <- lm(ParticipationRate_Inf ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary,VolumeInf>0 & Programme==3))

lnPRmiddle <- lm((ParticipationRate_Uninf*10 + ParticipationRate_Inf-4)/14 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
lnPRbeginning <- lm((ParticipationRate_Uninf*10 + ParticipationRate_Inf-4)/14 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
lnPRend <- lm((ParticipationRate_Uninf*10 + ParticipationRate_Inf-4)/14 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
lnPRall <- lm((ParticipationRate_Uninf*10 + ParticipationRate_Inf-4)/14 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_lnPRmiddle <- coeftest(lnPRmiddle, vcov. = vcovCL(lnPRmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRmiddle <- coeftest(lnPRmiddle, vcov. = vcovCL(lnPRmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRbeginning <- coeftest(lnPRbeginning, vcov. = vcovCL(lnPRbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRbeginning <- coeftest(lnPRbeginning, vcov. = vcovCL(lnPRbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRend <- coeftest(lnPRend, vcov. = vcovCL(lnPRend, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRend <- coeftest(lnPRend, vcov. = vcovCL(lnPRend, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRall <- coeftest(lnPRall, vcov. = vcovCL(lnPRall, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRall <- coeftest(lnPRall, vcov. = vcovCL(lnPRall, cluster = ~ SessionID, type = "HC3"))[,4]


se_lnPRmiddleUninf <- coeftest(lnPRmiddleUninf, vcov. = vcovCL(lnPRmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRmiddleUninf <- coeftest(lnPRmiddleUninf, vcov. = vcovCL(lnPRmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRbeginningUninf <- coeftest(lnPRbeginningUninf, vcov. = vcovCL(lnPRbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRbeginningUninf <- coeftest(lnPRbeginningUninf, vcov. = vcovCL(lnPRbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRendUninf <- coeftest(lnPRendUninf, vcov. = vcovCL(lnPRendUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRendUninf <- coeftest(lnPRendUninf, vcov. = vcovCL(lnPRendUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRallUninf <- coeftest(lnPRallUninf, vcov. = vcovCL(lnPRallUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRallUninf <- coeftest(lnPRallUninf, vcov. = vcovCL(lnPRallUninf, cluster = ~ SessionID, type = "HC3"))[,4]

se_lnPRmiddleInf <- coeftest(lnPRmiddleInf, vcov. = vcovCL(lnPRmiddleInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRmiddleInf <- coeftest(lnPRmiddleInf, vcov. = vcovCL(lnPRmiddleInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRbeginningInf <- coeftest(lnPRbeginningInf, vcov. = vcovCL(lnPRbeginningInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRbeginningInf <- coeftest(lnPRbeginningInf, vcov. = vcovCL(lnPRbeginningInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRendInf <- coeftest(lnPRendInf, vcov. = vcovCL(lnPRendInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRendInf <- coeftest(lnPRendInf, vcov. = vcovCL(lnPRendInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnPRallInf <- coeftest(lnPRallInf, vcov. = vcovCL(lnPRallInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnPRallInf <- coeftest(lnPRallInf, vcov. = vcovCL(lnPRallInf, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(lnPRbeginning, lnPRmiddle, lnPRend,lnPRbeginningInf, lnPRmiddleInf, lnPRendInf, lnPRbeginningUninf, lnPRmiddleUninf, lnPRendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"), custom.header = list("All traders" = 1:3, "Informed trader" = 4:6, "Uninformed trader" = 7:9),
       caption = "Regressions of participation rate by trader type and phase (Table WA2).", override.se=list(se_lnPRbeginning, se_lnPRmiddle, se_lnPRend, se_lnPRbeginningInf, se_lnPRmiddleInf, se_lnPRendInf, se_lnPRbeginningUninf, se_lnPRmiddleUninf, se_lnPRendUninf), 
       override.p = list(p_lnPRbeginning, p_lnPRmiddle, p_lnPRend, p_lnPRbeginningInf, p_lnPRmiddleInf, p_lnPRendInf, p_lnPRbeginningUninf, p_lnPRmiddleUninf, p_lnPRendUninf))

```

### Between regulation t-tests by Treatment
```{r tPRTreat, echo = F}
dat_VolTreat <- matrix(data = NA, ncol = 6, nrow = 3)
i <- 1
while(i<4){
for(t in c("NN.RR", "RR.NN", "RR.RR")){
  eVolTreatInf <- format(round(t.test(as.numeric(Volume>0 & LimitVolume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  tVolTreatInf <- format(round(t.test(as.numeric(Volume>0 & LimitVolume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Informed trader"), paired = T, var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eVolTreatUni <- format(round(t.test(as.numeric(Volume>0 & LimitVolume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  tVolTreatUni <- format(round(t.test(as.numeric(Volume>0 & LimitVolume>0) ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Uninformed trader"), paired = T, var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_VolTreat[i,] <- as.numeric(c(eVolTreatInf, tVolTreatInf, eVolTreatUni, tVolTreatUni))
  i <- i + 1
}}
                    
colnames(dat_VolTreat) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_VolTreat) <- c("Vol NR", "Vol RN", "Vol RR")

dat_VolTreat
```

********************************************************************
\newpage

## Volume

```{r histogramVol, echo=FALSE ,fig.cap="Distribution of Volume per market in Phase 2"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period < 10 ,select= Volume)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period < 10), aes(Volume, color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
 
```

### Aggregated mean volumes by regulatory regime, trader type, and phase.
```{r Volumemarket, echo = F}
tVolM <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol2M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol3M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolM <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

tVolInf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVolUni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol2Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol2Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol3Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol3Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolInf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolUni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

tVolInf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVolUni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol1Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol2Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol2Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tVol3Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol3Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tVol13Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolInf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVolUni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol1Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol2Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol3Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tLimitVol13Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

eVolM <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol1M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol2M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol3M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol13M <- format(round(t.test(Volume ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVolM <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol1M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol2M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol3M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol13M <- format(round(t.test(LimitVolume ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$estimate, digits = 4), scientific = FALSE)

eVolInf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVolUni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol1Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol1Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol2Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol2Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol3Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol3Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol13Inf <- format(round(t.test(VolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eVol13Uni <- format(round(t.test(VolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$estimate, digits = 4), scientific = FALSE)

eLimitVolInf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVolUni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol1Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol1Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Period < 4), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol2Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol2Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>3 & Period < 10), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol3Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol3Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>9), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol13Inf <- format(round(t.test(LimitVolumeInf ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eLimitVol13Uni <- format(round(t.test(LimitVolumeUni ~ IsREG, data=subset(marketsummary, Period>0 & Phase != "Phase 2"), var.equal=T)$estimate, digits = 4), scientific = FALSE)


dat_Vol <- data.frame(c(eVolM, tVolM, eVolInf, tVolInf, eVolUni, tVolUni), c(eVol1M, tVol1M, eVol1Inf, tVol1Inf, eVol1Uni, tVol1Uni), c(eVol2M, tVol2M, eVol2Inf, tVol2Inf, eVol2Uni, tVol2Uni), c(eVol3M, tVol3M, eVol3Inf, tVol3Inf, eVol3Uni, tVol3Uni), c(eVol13M, tVol13M, eVol13Inf, tVol13Inf, eVol13Uni, tVol13Uni), 
c(eLimitVolM, tLimitVolM, eLimitVolInf, tLimitVolInf, eLimitVolUni, tLimitVolUni), c(eLimitVol1M, tLimitVol1M, eLimitVol1Inf, tLimitVol1Inf, eLimitVol1Uni, tLimitVol1Uni), c(eLimitVol2M, tLimitVol2M, eLimitVol2Inf, tLimitVol2Inf, eLimitVol2Uni, tLimitVol2Uni), c(eLimitVol3M, tLimitVol3M, eLimitVol3Inf, tLimitVol3Inf, eLimitVol3Uni, tLimitVol3Uni), c(eLimitVol13M, tLimitVol13M, eLimitVol13Inf, tLimitVol13Inf, eLimitVol13Uni, tLimitVol13Uni)
                      )
dat_Vol <- t(dat_Vol)
colnames(dat_Vol) <- c("NOREG", "REG", "pvalues_market", "NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_Vol) <- c("Vol all phases", "Vol Phase 1", "Vol Phase 2", "Vol Phase 3", "Vol Phase 1 & 3", "LimitVol all phases", "LimitVol Phase 1", "LimitVol Phase 2", "LimitVol Phase 3", "LimitVol Phase 1 & 3")

dat_Vol
```


```{r RoleTreatTrade, echo=F, fig.cap = "Mean market trading volume by combination of trading partners, regulatory regime, phase, and treatment.", warning=F}
# Data Figure 2 and Figure WA1
u <- aggregate(cbind(Volume_Informed_Informed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u)[4] <- "Volume"
un <- aggregate(cbind(Volume_Informed_Informed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) length(x[x < Inf & x > -Inf]))
colnames(un) <- c("Phase", "embTreatment", "IsREG", "n")
usd <- aggregate(cbind(Volume_Informed_Informed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(usd) <- c("Phase", "embTreatment", "IsREG", "sd")
u$type <- "ii"
u <- merge(u, usd, by=c("Phase", "embTreatment", "IsREG"))
u <- merge(u, un, by=c("Phase", "embTreatment", "IsREG"))

u2 <- aggregate(cbind(Volume_Informed_Uninformed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u2)[4] <- "Volume"
u2n <- aggregate(cbind(Volume_Informed_Uninformed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) length(x[x < Inf & x > -Inf]))
colnames(u2n) <- c("Phase", "embTreatment", "IsREG", "n")
u2sd <- aggregate(cbind(Volume_Informed_Uninformed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u2sd) <- c("Phase", "embTreatment", "IsREG", "sd")
u2$type <- "iu"
u2 <- merge(u2, u2sd, by=c("Phase", "embTreatment", "IsREG"))
u2 <- merge(u2, u2n, by=c("Phase", "embTreatment", "IsREG"))

u3 <- aggregate(cbind(Volume_Uninformed_Informed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u3)[4] <- "Volume"
u3n <- aggregate(cbind(Volume_Uninformed_Informed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) length(x[x < Inf & x > -Inf]))
colnames(u3n) <- c("Phase", "embTreatment", "IsREG", "n")
u3sd <- aggregate(cbind(Volume_Uninformed_Informed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u3sd) <- c("Phase", "embTreatment", "IsREG", "sd")
u3$type <- "ui"
u3 <- merge(u3, u3sd, by=c("Phase", "embTreatment", "IsREG"))
u3 <- merge(u3, u3n, by=c("Phase", "embTreatment", "IsREG"))

u4 <- aggregate(cbind(Volume_Uninformed_Uninformed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u4)[4] <- "Volume"
u4n <- aggregate(cbind(Volume_Uninformed_Uninformed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) length(x[x < Inf & x > -Inf]))
colnames(u4n) <- c("Phase", "embTreatment", "IsREG", "n")
u4sd <- aggregate(cbind(Volume_Uninformed_Uninformed) ~ Phase + embTreatment + IsREG, data = subset(marketsummary), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(u4sd) <- c("Phase", "embTreatment", "IsREG", "sd")
u4$type <- "uu"
u4 <- merge(u4, u4sd, by=c("Phase", "embTreatment", "IsREG"))
u4 <- merge(u4, u4n, by=c("Phase", "embTreatment", "IsREG"))
u <- rbind(u,u2,u3,u4)
u$maxV <- max(u$Volume)
u$ll <- u$Volume + qt(.025,u$n)*u$sd/sqrt(u$n)
u$ul <- u$Volume + qt(.975,u$n)*u$sd/sqrt(u$n)
u$Phase <- factor(u$Phase, levels = c("Phase 1", "Phase 2", "Phase 3"))

dt1 <- format(round(t.test(Volume_Informed_Informed ~ IsREG, data=subset(marketsummary, Phase == "Phase 1"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt2 <- format(round(t.test(Volume_Informed_Informed ~ IsREG, data=subset(marketsummary, Phase == "Phase 2"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
dt3 <- format(round(t.test(Volume_Informed_Informed ~ IsREG, data=subset(marketsummary, Phase == "Phase 3"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt4 <- format(round(t.test(Volume_Informed_Uninformed ~ IsREG, data=subset(marketsummary, Phase == "Phase 1"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt5 <- format(round(t.test(Volume_Informed_Uninformed ~ IsREG, data=subset(marketsummary, Phase == "Phase 2"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
dt6 <- format(round(t.test(Volume_Informed_Uninformed ~ IsREG, data=subset(marketsummary, Phase == "Phase 3"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt7 <- format(round(t.test(Volume_Uninformed_Informed ~ IsREG, data=subset(marketsummary, Phase == "Phase 1"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt8 <- format(round(t.test(Volume_Uninformed_Informed ~ IsREG, data=subset(marketsummary, Phase == "Phase 2"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
dt9 <- format(round(t.test(Volume_Uninformed_Informed ~ IsREG, data=subset(marketsummary, Phase == "Phase 3"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt10 <- format(round(t.test(Volume_Uninformed_Uninformed ~ IsREG, data=subset(marketsummary, Phase == "Phase 1"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
dt11 <- format(round(t.test(Volume_Uninformed_Uninformed ~ IsREG, data=subset(marketsummary, Phase == "Phase 2"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
dt12 <- format(round(t.test(Volume_Uninformed_Uninformed ~ IsREG, data=subset(marketsummary, Phase == "Phase 3"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

dat_text <- data.frame(
  label = c(paste0("p = ",dt1,""), paste0("p = ",dt2,""), paste0("p = ",dt3,""), paste0("p = ",dt4,""), paste0("p = ",dt5,""),paste0("p = ",dt6,""),paste0("p = ",dt7,""),paste0("p = ",dt8,""),paste0("p = ",dt9,""),paste0("p = ",dt10,""),paste0("p = ",dt11,""),paste0("p = ",dt12,"")),
  IsREG = c("REG", "REG", "NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG"),
  Phase = c("Phase 1", "Phase 2", "Phase 3", "Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
  type = c("ii", "ii", "ii", "iu", "iu", "iu", "ui", "ui", "ui", "uu", "uu", "uu")
)

#postscript("Figures/GraphvolumeRole.eps")
ggplot(data=u, aes(y= Volume, x= type, group=interaction(embTreatment, IsREG), fill = IsREG, color = type)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.5))+  
  labs(y="Markets' mean trading volume") +
  geom_errorbar(aes(ymin = ll, ymax = ul), width=.2, color = 'black', position=position_dodge(width=0.5)) +
  theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "vertical", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(embTreatment ~ Phase,scales = "free") +
  scale_fill_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  scale_colour_manual(name = "", values = c(0,0,0,0), labels = c("ii  = informed accepted from informed", "iu = informed accepted from uninformed", "ui = uninformed accepted from informed", "uu = uninformed accepted from uninformed")) +
  guides(color = guide_legend(keywidth = unit(0,"mm"))) +
  geom_blank(aes(y= maxV))
#dev.off()
```

```{r RoleTrade, echo=F, fig.cap = "Mean market trading volume by combination of trading partners and regulatory regime, in Phase 2 (Figure 2).", warning=F}
### Figure 2 ####
uT2 <- aggregate(cbind(Volume_Informed_Informed, Volume_Uninformed_Informed, Volume_Informed_Uninformed, Volume_Uninformed_Uninformed) ~ Phase + IsREG, data = subset(marketsummary), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
uT <- reshape2::melt(subset(uT2), id.vars = c("Phase", "IsREG"))
colnames(uT)[colnames(uT) == "value"] <- "Volume"
uTn <- aggregate(cbind(Volume_Informed_Informed) ~ Phase + IsREG, data = subset(marketsummary), function(x) length(x[x < Inf & x > -Inf]))
colnames(uTn)[colnames(uTn) == "Volume_Informed_Informed"] <- "n"
uTsd <- aggregate(cbind(Volume_Informed_Informed, Volume_Uninformed_Informed, Volume_Informed_Uninformed, Volume_Uninformed_Uninformed) ~ Phase + IsREG, data = subset(marketsummary), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
uTsd2 <- reshape2::melt(subset(uTsd), id.vars = c("Phase", "IsREG"))
colnames(uTsd2)[colnames(uTsd2) == "value"] <- "sd"
uT <- merge(uT, uTsd2, by=c("Phase", "IsREG", "variable"))
uT <- merge(uT, uTn, by=c("Phase", "IsREG"), all = T)
uT$type = 'ii'
uT$type[uT$variable == "Volume_Informed_Uninformed"] <- "iu"
uT$type[uT$variable == "Volume_Uninformed_Informed"] <- "ui"
uT$type[uT$variable == "Volume_Uninformed_Uninformed"] <- "uu"
uT$ll <- uT$Volume + qt(.025,uT$n)*uT$sd/sqrt(uT$n)
uT$ul <- uT$Volume + qt(.975,uT$n)*uT$sd/sqrt(uT$n)
uT$maxV <- max(uT$Volume)
uT$Phase <- factor(uT$Phase, levels = c("Phase 1", "Phase 2", "Phase 3"))

#postscript("Figures/GraphvolumeRolemiddleT.eps")
ggplot(data=subset(uT, Phase == "Phase 2"), aes(y= Volume, x= type, group=interaction(IsREG), fill = IsREG, color = type)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.5))+  
  labs(y="Markets' mean trading volume") +
  geom_text(data = subset(dat_text, Phase == "Phase 2"), mapping = aes(x = type, y = 67, label = label), color = "black", size = 4) +
  theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "vertical", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(. ~ Phase,scales = "free") +
  scale_fill_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  scale_colour_manual(name = "", values = c(0,0,0,0), labels = c("ii  = informed accepted from informed", "iu = informed accepted from uninformed", "ui = uninformed accepted from informed", "uu = uninformed accepted from uninformed")) +
  guides(color = guide_legend(keywidth = unit(0,"mm"))) +
  geom_errorbar(aes(ymin = ll, ymax = ul), width=.2, color = 'black', position=position_dodge(width=0.5)) +
  geom_blank(aes(y= maxV))
#dev.off()

```


```{r volumetableAll, echo=F, results = 'asis', warning=F}
### Table 3 ####
lnmiddleUninf <- lm(log(VolumeUni) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
lnmiddleInf <- lm(log(VolumeInf) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, VolumeInf>0 & Programme==3 & Period>3 & Period < 10))
lnbeginningUninf <- lm(log(VolumeUni) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period <=3))
lnbeginningInf <- lm(log(VolumeInf) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, VolumeInf>0 & Programme==3 & Period <=3))
lnendUninf <- lm(log(VolumeUni) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
lnendInf <- lm(log(VolumeInf) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, VolumeInf>0 & Programme==3 & Period>=10))
ln13Uninf <- lm(log(VolumeUni) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + Phase, data = subset(marketsummary, Programme==3 & Period > 0 & (Period>=10 | Period<=3 )))
ln13Inf <- lm(log(VolumeInf) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + Phase, data = subset(marketsummary, VolumeInf>0 & Programme==3 & Period > 0 & (Period>=10 | Period<=3 )))

lnallUninf <- lm(log(VolumeUni) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))
lnallInf <- lm(log(VolumeInf) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary,VolumeInf>0 & Programme==3))

lnmiddle <- lm(log(Volume) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
lnbeginning <- lm(log(Volume) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
lnend <- lm(log(Volume) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
lnall <- lm(log(Volume) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_lnmiddle <- coeftest(lnmiddle, vcov. = vcovCL(lnmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnmiddle <- coeftest(lnmiddle, vcov. = vcovCL(lnmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnbeginning <- coeftest(lnbeginning, vcov. = vcovCL(lnbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnbeginning <- coeftest(lnbeginning, vcov. = vcovCL(lnbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnend <- coeftest(lnend, vcov. = vcovCL(lnend, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnend <- coeftest(lnend, vcov. = vcovCL(lnend, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnall <- coeftest(lnall, vcov. = vcovCL(lnall, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnall <- coeftest(lnall, vcov. = vcovCL(lnall, cluster = ~ SessionID, type = "HC3"))[,4]


se_lnmiddleUninf <- coeftest(lnmiddleUninf, vcov. = vcovCL(lnmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnmiddleUninf <- coeftest(lnmiddleUninf, vcov. = vcovCL(lnmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnbeginningUninf <- coeftest(lnbeginningUninf, vcov. = vcovCL(lnbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnbeginningUninf <- coeftest(lnbeginningUninf, vcov. = vcovCL(lnbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnendUninf <- coeftest(lnendUninf, vcov. = vcovCL(lnendUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnendUninf <- coeftest(lnendUninf, vcov. = vcovCL(lnendUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnallUninf <- coeftest(lnallUninf, vcov. = vcovCL(lnallUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnallUninf <- coeftest(lnallUninf, vcov. = vcovCL(lnallUninf, cluster = ~ SessionID, type = "HC3"))[,4]

se_lnmiddleInf <- coeftest(lnmiddleInf, vcov. = vcovCL(lnmiddleInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnmiddleInf <- coeftest(lnmiddleInf, vcov. = vcovCL(lnmiddleInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnbeginningInf <- coeftest(lnbeginningInf, vcov. = vcovCL(lnbeginningInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnbeginningInf <- coeftest(lnbeginningInf, vcov. = vcovCL(lnbeginningInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnendInf <- coeftest(lnendInf, vcov. = vcovCL(lnendInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnendInf <- coeftest(lnendInf, vcov. = vcovCL(lnendInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnallInf <- coeftest(lnallInf, vcov. = vcovCL(lnallInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnallInf <- coeftest(lnallInf, vcov. = vcovCL(lnallInf, cluster = ~ SessionID, type = "HC3"))[,4]

se_ln13Inf <- coeftest(ln13Inf, vcov. = vcovCL(ln13Inf, cluster = ~ SessionID, type = "HC3"))[,2]
p_ln13Inf <- coeftest(ln13Inf, vcov. = vcovCL(ln13Inf, cluster = ~ SessionID, type = "HC3"))[,4]
se_ln13Uninf <- coeftest(ln13Uninf, vcov. = vcovCL(ln13Uninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_ln13Uninf <- coeftest(ln13Uninf, vcov. = vcovCL(ln13Uninf, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(lnbeginning, lnmiddle, lnend,lnbeginningInf, lnmiddleInf, lnendInf, lnbeginningUninf, lnmiddleUninf, lnendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Regressions of trading volume (‘ln(transaction volume)’) by trader type and phase (Table 3).", custom.header = list("All traders" = 1:3, "Informed trader" = 4:6, "Uninformed trader" = 7:9), override.se=list(se_lnbeginning, se_lnmiddle, se_lnend, se_lnbeginningInf, se_lnmiddleInf, se_lnendInf, se_lnbeginningUninf, se_lnmiddleUninf, se_lnendUninf), 
       override.p = list(p_lnbeginning, p_lnmiddle, p_lnend, p_lnbeginningInf, p_lnmiddleInf, p_lnendInf, p_lnbeginningUninf, p_lnmiddleUninf, p_lnendUninf))

```

```{r tablelnvolumebegincalc, echo = F}
t1 <- linearHypothesis(lnall, c("historyR = historyN"), singular.ok = T, vcov. = vcovCL(lnall, cluster = ~ SessionID, type = "HC3"))
t2 <- linearHypothesis(lnall, c("historyN.R = historyR.R", "historyN.N = historyR.N"), singular.ok = T, vcov. = vcovCL(lnall, cluster = ~ SessionID, type = "HC3"))
t3 <- linearHypothesis(lnall, c("historyR.R = historyR.N","historyN.R = historyN.N"), singular.ok = T, vcov. = vcovCL(lnall, cluster = ~ SessionID, type = "HC3"))

t4 <- linearHypothesis(lnmiddle, c("historyR = (Intercept)"), singular.ok = T, vcov. = vcovCL(lnmiddle, cluster = ~ SessionID, type = "HC3"))

t5 <- linearHypothesis(lnend, c("historyN.R = historyR.R", "(Intercept) = historyR.N"), singular.ok = T, vcov. = vcovCL(lnend, cluster = ~ SessionID, type = "HC3"))
t6 <- linearHypothesis(lnend, c("historyR.R = historyR.N","historyN.R = (Intercept)"), singular.ok = T, vcov. = vcovCL(lnend, cluster = ~ SessionID, type = "HC3"))

ta <- data.frame("all" = c(t1$`Pr(>F)`[2], t2$`Pr(>F)`[2], t3$`Pr(>F)`[2]), 
                "center" = c(t4$`Pr(>F)`[2], NA,NA),
                "end" = c(NA, t5$`Pr(>F)`[2], t6$`Pr(>F)`[2]))
rownames(ta) <- c("1$^{st}$ phase effect in the 2$^{nd}$ phase", "1$^{st}$ phase effect in the 3$^{rd}$ phase", "2$^{nd}$ phase effect")

data.frame(format(ta,  digits = 3, scientific = 5))
```

```{r tVolTreat, echo = F}
dat_VolTreat <- matrix(data = NA, ncol = 6, nrow = 3)
i <- 1
while(i<4){
for(t in c("NN.RR", "RR.NN", "RR.RR")){
  eVolTreatInf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  tVolTreatInf <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Informed trader"), paired = T, var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eVolTreatUni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  tVolTreatUni <- format(round(t.test(Volume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Uninformed trader"), paired = T, var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_VolTreat[i,] <- as.numeric(c(eVolTreatInf, tVolTreatInf, eVolTreatUni, tVolTreatUni))
  i <- i + 1
}}
                    
colnames(dat_VolTreat) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_VolTreat) <- c("Vol NR",  "Vol RN", "Vol RR")

dat_VolTreat
```

********************************************************************
\newpage

## Limit orders
```{r histogramofferVol, echo=FALSE ,fig.cap="Histogram of limit order volume per market in Phase 2"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period<10 ,select= LimitVolume)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10), aes((LimitVolume), color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density")) +
  labs(x = "Limit volume")
```

```{r histogramoffersVolTrader, echo=FALSE ,fig.cap="Mean market limit order volume, short selling volume and margin buys by trader type, regulatory regime, phase"}
# Data for Table WA4 #
eshortInf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshortUni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort1Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort1Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort2Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort2Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort3Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort3Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort13Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
eshort13Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
tshortInf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshortUni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshort1Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshort1Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshort2Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tshort2Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tshort3Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshort3Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshort13Inf <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tshort13Uni <- format(round(t.test(shortsells ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

emarginInf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emarginUni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin1Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin1Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin2Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin2Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin3Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin3Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin13Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin13Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
tmarginInf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmarginUni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin1Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin1Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin2Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tmargin2Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tmargin3Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin3Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin13Inf <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin13Uni <- format(round(t.test(marginbuysAsset ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)


dat_textLimit <- data.frame(
  label = c(paste0("p = ",tLimitVol1Inf,""),paste0("p = ",tLimitVol1Uni,""),paste0("p = ",tLimitVol2Inf,".0000"),paste0("p = ",tLimitVol2Uni,""),paste0("p = ",tLimitVol3Inf,""), paste0("p = ",tLimitVol3Uni,""),
  paste0("p = ",tshort1Inf,""),paste0("p = ",tshort1Uni,""),paste0("p = ",tshort2Inf,""),paste0("p = ",tshort2Uni,""),paste0("p = ",tshort3Inf,"0"), paste0("p = ",tshort3Uni,""),
  paste0("p = ",tmargin1Inf,""),paste0("p = ",tmargin1Uni,".0000"),paste0("p = ",tmargin2Inf,""),paste0("p = ",tmargin2Uni,""),paste0("p = ",tmargin3Inf,""), paste0("p = ",tmargin3Uni,"")),
  IsREG   = c("NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG","NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG","NOREG", "NOREG", "REG", "REG", "NOREG", "NOREG"),
  Role = c("Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders",
           "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders"),
  Phase = c("Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3","Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3","Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3"),
    Variable = c("Limit volume","Limit volume","Limit volume","Limit volume","Limit volume","Limit volume", "Short sells", "Short sells", "Short sells", "Short sells", "Short sells", "Short sells", "Margin buys", "Margin buys", "Margin buys", "Margin buys", "Margin buys", "Margin buys"), 
  #Variable = c("Traders' mean limit volume","Traders' mean limit volume","Traders' mean limit volume", "Traders' mean limit volume", "Traders' mean limit volume", "Traders' mean limit volume", "Traders' mean short selling volume", "Traders' mean short selling volume", "Traders' mean short selling volume", "Traders' mean short selling volume", "Traders' mean short selling volume", "Traders' mean short selling volume", "Traders' mean margin buys in volume", "Traders' mean margin buys in volume", "Traders' mean margin buys in volume", "Traders' mean margin buys in volume", "Traders' mean margin buys in volume", "Traders' mean margin buys in volume"), 
  vjust = c(38,38,38,38,38,38,4.3,4.3,4.3,4.3,4.3,4.3,4.3,4.3,4.3,4.3,4.3,4.3)
  )

#postscript("Figures/GraphLimitvolumePhaseallTreat.eps")
ggplot(data=subset(avgtraderphasesummary2, variable == "LimitVolume" | variable == "shortsells" | variable == "marginbuysAsset"), aes(y= value, x= Role, group=(IsREG), fill = IsREG)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.5))+ 
  labs(y="") +
  geom_text(data = subset(dat_textLimit), mapping = aes(x = Role, y = vjust, label = label), color = "black", size = 4) +
  theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"),  plot.background = element_rect(fill = "transparent")) +
  facet_grid(factor(Variable, levels = c("Limit volume", "Short sells", "Margin buys")) ~ Phase, scales = "free") +
  scale_fill_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  scale_color_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  geom_errorbar(aes(ymin = dol, ymax = upl), width=.2, color = 'black', position=position_dodge(width=0.5))
#dev.off()
```



```{r offervolumetableAll, echo=F, results = 'asis', warning=F}
### Table WA3 ####
lnoffermiddleUninf <- lm(log(LimitVolumeUni) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
lnoffermiddleInf <- lm(log(LimitVolumeInf) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, LimitVolume>0 & Programme==3 & Period>3 & Period<10))
lnofferbeginningUninf <- lm(log(LimitVolumeUni) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
lnofferbeginningInf <- lm(log(LimitVolumeInf) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, LimitVolumeInf>0 & Programme==3 & Period<=3))
lnofferendUninf <- lm(log(LimitVolumeUni) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
lnofferendInf <- lm(log(LimitVolumeInf) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, LimitVolumeInf>0 & Programme==3 & Period>=10))
lnoffer13Uninf <- lm(log(LimitVolumeUni) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period > 0 & (Period>=10 | Period<=3 )))
lnoffer13Inf <- lm(log(LimitVolumeInf) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, LimitVolumeInf>0 & Programme==3 & Period > 0 & (Period>=10 | Period<=3 )))

lnofferallUninf <- lm(log(LimitVolumeUni) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))
lnofferallInf <- lm(log(LimitVolumeInf) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, LimitVolumeInf>0 & Programme==3))

lnoffermiddle <- lm(log(LimitVolume) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
lnofferbeginning <- lm(log(LimitVolume) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
lnofferend <- lm(log(LimitVolume) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
lnofferall <- lm(log(LimitVolume) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_lnoffermiddle <- coeftest(lnoffermiddle, vcov. = vcovCL(lnoffermiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoffermiddle <- coeftest(lnoffermiddle, vcov. = vcovCL(lnoffermiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferbeginning <- coeftest(lnofferbeginning, vcov. = vcovCL(lnofferbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferbeginning <- coeftest(lnofferbeginning, vcov. = vcovCL(lnofferbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferend <- coeftest(lnofferend, vcov. = vcovCL(lnofferend, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferend <- coeftest(lnofferend, vcov. = vcovCL(lnofferend, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferall <- coeftest(lnofferall, vcov. = vcovCL(lnofferall, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferall <- coeftest(lnofferall, vcov. = vcovCL(lnofferall, cluster = ~ SessionID, type = "HC3"))[,4]


se_lnoffermiddleUninf <- coeftest(lnoffermiddleUninf, vcov. = vcovCL(lnoffermiddleUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoffermiddleUninf <- coeftest(lnoffermiddleUninf, vcov. = vcovCL(lnoffermiddleUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferbeginningUninf <- coeftest(lnofferbeginningUninf, vcov. = vcovCL(lnofferbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferbeginningUninf <- coeftest(lnofferbeginningUninf, vcov. = vcovCL(lnofferbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferendUninf <- coeftest(lnofferendUninf, vcov. = vcovCL(lnofferendUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferendUninf <- coeftest(lnofferendUninf, vcov. = vcovCL(lnofferendUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferallUninf <- coeftest(lnofferallUninf, vcov. = vcovCL(lnofferallUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferallUninf <- coeftest(lnofferallUninf, vcov. = vcovCL(lnofferallUninf, cluster = ~ SessionID, type = "HC3"))[,4]

se_lnoffermiddleInf <- coeftest(lnoffermiddleInf, vcov. = vcovCL(lnoffermiddleInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoffermiddleInf <- coeftest(lnoffermiddleInf, vcov. = vcovCL(lnoffermiddleInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferbeginningInf <- coeftest(lnofferbeginningInf, vcov. = vcovCL(lnofferbeginningInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferbeginningInf <- coeftest(lnofferbeginningInf, vcov. = vcovCL(lnofferbeginningInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferendInf <- coeftest(lnofferendInf, vcov. = vcovCL(lnofferendInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferendInf <- coeftest(lnofferendInf, vcov. = vcovCL(lnofferendInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnofferallInf <- coeftest(lnofferallInf, vcov. = vcovCL(lnofferallInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnofferallInf <- coeftest(lnofferallInf, vcov. = vcovCL(lnofferallInf, cluster = ~ SessionID, type = "HC3"))[,4]

se_lnoffer13Inf <- coeftest(lnoffer13Inf, vcov. = vcovCL(lnoffer13Inf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoffer13Inf <- coeftest(lnoffer13Inf, vcov. = vcovCL(lnoffer13Inf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoffer13Uninf <- coeftest(lnoffer13Uninf, vcov. = vcovCL(lnoffer13Uninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoffer13Uninf <- coeftest(lnoffer13Uninf, vcov. = vcovCL(lnoffer13Uninf, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(lnofferbeginning, lnoffermiddle, lnofferend,lnofferbeginningInf, lnoffermiddleInf, lnofferendInf, lnofferbeginningUninf, lnoffermiddleUninf, lnofferendUninf), 
       custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"),
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Regressions of offered volume (‘ln(limit volume)’) by trader type and phase (Table WA3).", custom.header = list('All traders' = 1:3, 'Informed trader' = 4:6, 'Uninformed trader' = 7:9), override.se=list(se_lnofferbeginning, se_lnoffermiddle, se_lnofferend, se_lnofferbeginningInf, se_lnoffermiddleInf, se_lnofferendInf, se_lnofferbeginningUninf, se_lnoffermiddleUninf, se_lnofferendUninf), 
       override.p = list(p_lnofferbeginning, p_lnoffermiddle, p_lnofferend, p_lnofferbeginningInf, p_lnoffermiddleInf, p_lnofferendInf, p_lnofferbeginningUninf, p_lnoffermiddleUninf, p_lnofferendUninf))

```


```{r tablelnoffervolumebegincalc, echo =F}
t1 <- linearHypothesis(lnofferall, c("historyR = historyN"), singular.ok = T, vcov. = vcovCL(lnofferall, cluster = ~ SessionID, type = "HC3"))
t2 <- linearHypothesis(lnofferall, c("historyN.R = historyR.R", "historyN.N = historyR.N"), singular.ok = T, vcov. = vcovCL(lnofferall, cluster = ~ SessionID, type = "HC3"))
t3 <- linearHypothesis(lnofferall, c("historyR.R = historyR.N","historyN.R = historyN.N"), singular.ok = T, vcov. = vcovCL(lnofferall, cluster = ~ SessionID, type = "HC3"))

t4 <- linearHypothesis(lnoffermiddle, c("historyR = (Intercept)"), singular.ok = T, vcov. = vcovCL(lnoffermiddle, cluster = ~ SessionID, type = "HC3"))

t5 <- linearHypothesis(lnofferend, c("historyN.R = historyR.R", "(Intercept) = historyR.N"), singular.ok = T, vcov. = vcovCL(lnofferend, cluster = ~ SessionID, type = "HC3"))
t6 <- linearHypothesis(lnofferend, c("historyR.R = historyR.N","historyN.R = (Intercept)"), singular.ok = T, vcov. = vcovCL(lnofferend, cluster = ~ SessionID, type = "HC3"))

ta<- data.frame("all" = c(t1$`Pr(>F)`[2], t2$`Pr(>F)`[2], t3$`Pr(>F)`[2]), 
                "center" = c(t4$`Pr(>F)`[2], NA,NA),
                "end" = c(NA, t5$`Pr(>F)`[2], t6$`Pr(>F)`[2]))
rownames(ta) <- c("1$^{st}$ phase effect in the 2$^{nd}$ phase", "1$^{st}$ phase effect in the 3$^{rd}$ phase", "2$^{nd}$ phase effect")

format(ta,  digits = 3, scientific = 5)
```

```{r tLimitVolTreat, echo = F}
dat_VolTreat <- matrix(data = NA, ncol = 6, nrow = 3)
i <- 1
while(i<4){
for(t in c("NN.RR", "RR.NN", "RR.RR")){
  eVolTreatInf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  tVolTreatInf <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Informed trader"), paired = T, var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eVolTreatUni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  tVolTreatUni <- format(round(t.test(LimitVolume ~ IsREG, data=subset(subjectsummary, Period>0 & Phase == "Phase 2" & embTreatment == t & Role== "Uninformed trader"), paired = T, var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_VolTreat[i,] <- as.numeric(c(eVolTreatInf, tVolTreatInf, eVolTreatUni, tVolTreatUni))
  i <- i + 1
}}
                    
colnames(dat_VolTreat) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_VolTreat) <- c("Vol NR",  "Vol RN", "Vol RR")

dat_VolTreat
```

*****************************************************************
\newpage

## Odds
\begin{equation} \label{formula:odds}
    \ln\left(odds_{Phase}\right)=\ln\left(\frac{\sum\limits_p^{Periods}Volume_{p,Top (Bottom)}}{\sum\limits_p^{Periods}Volume_{p,Bottom (Top)}}\right)
\end{equation}

```{r histogrammodds, echo=FALSE ,fig.cap="Distribution of odds of the upper market in Phase 2"}
a <- log(subset(phasesummary, Phase == "Phase 2" & market == "Top", select= odds))
b <- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(phasesummary, Phase == "Phase 2" & market =="Top"), aes(log(odds), color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf()  + 
  facet_grid(. ~ Role) +
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
 
```

```{r plotodds, echo=F, results = 'asis', warning=F, fig.cap="Volume migration between phases by trader type and treatment (Figure WA2)."}
### Figure WA2 ####
# Data for Figure 3, Figure WA2, and Figure WA3 ## 
v <- aggregate(cbind(log(odds) - log(odds_start), log(oddsLimit) - log(oddsLimit_start), geomodds-geomodds_start, geomoddsLimit-geomoddsLimit_start, geomodds)  ~ Role + embTreatment, data = subset(phasesummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x))
  vn <- aggregate(cbind(log(odds) - log(odds_start)) ~ Role + embTreatment, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x))
  colnames(vn) <- c("Role", "embTreatment", "n")
  vsd <- aggregate(cbind(log(odds) - log(odds_start), log(oddsLimit) - log(oddsLimit_start), geomodds-geomodds_start, geomoddsLimit-geomoddsLimit_start) ~ Role + embTreatment, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x))
  colnames(vsd) <- c("Role", "embTreatment", "sdd", "sddL", "sddP", "sddPL")
  v <- merge(v, vsd, by=c("Role", "embTreatment"))
  v <- merge(v, vn, by=c("Role", "embTreatment"))
  v$y <- "From Phase 1 to Phase 2"
  v$embTreatment <- factor(v$embTreatment, levels = c("All treatments", "NN.RR", "RR.NN", "RR.RR"))
  colnames(v)[colnames(v) == "V1"] <- "d"
  colnames(v)[colnames(v) == "V2"] <- "dL"
  colnames(v)[colnames(v) == "V3"] <- "dP"
  colnames(v)[colnames(v) == "V4"] <- "dPL"
  v2 <- aggregate(cbind(log(odds_end) - log(odds),log(oddsLimit_end) - log(oddsLimit), geomodds_end - geomodds, geomoddsLimit_end - geomoddsLimit, geomodds) ~ Role + embTreatment, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x))
  v2n <- aggregate(cbind(log(odds_end) - log(odds)) ~ Role + embTreatment, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x))
  colnames(v2n) <- c("Role", "embTreatment", "n")
  v2sd <- aggregate(cbind(log(odds_end) - log(odds),log(oddsLimit_end) - log(oddsLimit), geomodds_end - geomodds, geomoddsLimit_end - geomoddsLimit) ~ Role + embTreatment, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x))
  colnames(v2sd) <- c("Role", "embTreatment", "sdd", "sddL", "sddP", "sddPL")
  v2 <- merge(v2, v2sd, by=c("Role", "embTreatment"))
  v2 <- merge(v2, v2n, by=c("Role", "embTreatment"))
  v2$y <- "From Phase 2 to Phase 3"
  colnames(v2)[colnames(v2) == "V1"] <- "d"
  colnames(v2)[colnames(v2) == "V2"] <- "dL"
  colnames(v2)[colnames(v2) == "V3"] <- "dP"
  colnames(v2)[colnames(v2) == "V4"] <- "dPL"
  v3 <- aggregate(cbind(log(odds) - log(odds_start), log(oddsLimit) - log(oddsLimit_start), geomodds-geomodds_start, geomoddsLimit-geomoddsLimit_start, geomodds) ~ Role, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x))
  v3n <- aggregate(cbind(log(odds) - log(odds_start)) ~ Role, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x))
  colnames(v3n) <- c("Role", "n")
  v3sd <- aggregate(cbind(log(odds) - log(odds_start), log(oddsLimit) - log(oddsLimit_start), geomodds-geomodds_start, geomoddsLimit-geomoddsLimit_start) ~ Role, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x))
  colnames(v3sd) <- c("Role", "sdd", "sddL", "sddP", "sddPL")
  v3 <- merge(v3, v3sd, by=c("Role"))
  v3 <- merge(v3, v3n, by=c("Role"))
  v3$y <- "From Phase 1 to Phase 2"
  v3$embTreatment <- "All treatments"
  colnames(v3)[colnames(v3) == "V1"] <- "d"
  colnames(v3)[colnames(v3) == "V2"] <- "dL"
  colnames(v3)[colnames(v3) == "V3"] <- "dP"
  colnames(v3)[colnames(v3) == "V4"] <- "dPL"
  v4 <- aggregate(cbind(log(odds_end) - log(odds),log(oddsLimit_end) - log(oddsLimit), geomodds_end - geomodds, geomoddsLimit_end - geomoddsLimit, geomodds) ~ Role, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x))
  v4n <- aggregate(cbind(log(odds_end) - log(odds)) ~ Role, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x))
  colnames(v4n) <- c("Role", "n")
  v4sd <- aggregate(cbind(log(odds_end) - log(odds),log(oddsLimit_end) - log(oddsLimit), geomodds_end - geomodds, geomoddsLimit_end - geomoddsLimit) ~ Role, data = subset(phasesummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x))
  colnames(v4sd) <- c("Role", "sdd", "sddL", "sddP", "sddPL")
  v4 <- merge(v4, v4sd, by=c("Role"))
  v4 <- merge(v4, v4n, by=c("Role"))
  v4$y <- "From Phase 2 to Phase 3"
  v4$embTreatment <- "All treatments"
  colnames(v4)[colnames(v4) == "V1"] <- "d"
  colnames(v4)[colnames(v4) == "V2"] <- "dL"
  colnames(v4)[colnames(v4) == "V3"] <- "dP"
  colnames(v4)[colnames(v4) == "V4"] <- "dPL"
  v <- rbind(v, v2, v3, v4)
  v$Role <- factor(v$Role, labels = c("Informed\ntraders","All traders","Uninformed\ntraders"))
  v$Role <- ordered(v$Role, levels = c("All traders","Informed\ntraders","Uninformed\ntraders"))
  v$ll <- v$d + qt(.025,v$n)*v$sdd/sqrt(v$n)
  v$ul <- v$d + qt(.975,v$n)*v$sdd/sqrt(v$n)
  v$llL <- v$dL + qt(.025,v$n)*v$sddL/sqrt(v$n)
  v$ulL <- v$dL + qt(.975,v$n)*v$sddL/sqrt(v$n)
  v$llP <- v$dP + qt(.025,v$n)*v$sddP/sqrt(v$n)
  v$ulP <- v$dP + qt(.975,v$n)*v$sddP/sqrt(v$n)
  v$llPL <- v$dPL + qt(.025,v$n)*v$sddPL/sqrt(v$n)
  v$ulPL <- v$dPL + qt(.975,v$n)*v$sddPL/sqrt(v$n)
  v$maxT <- NA
  v$maxT[v$y == "From Phase 2 to Phase 3"] <- -max(v$ul)
  v$maxL <- NA
  v$maxL[v$y == "From Phase 2 to Phase 3"] <- -max(v$dL)  
  v$maxP <- NA
  v$maxP[v$y == "From Phase 2 to Phase 3"] <- -max(v$ulP)
  v$maxPL <- NA
  v$maxPL[v$y == "From Phase 2 to Phase 3"] <- -max(v$dPL)

#postscript("Figures/GraphmigrationTreat.eps")  
  ggplot(data=subset(v, embTreatment != "All treatments"), aes(y=d, x= Role, group=interaction(embTreatment,y), fill = Role)) +
  geom_bar(stat="identity") +  
  labs(y=expression("Difference in ln(odds"["Phase"]~")")) +
  geom_errorbar(aes(ymin=ll, ymax=ul, color=factor(Role)), width=.2) +
  theme(text = element_text(size=18),axis.title.x=element_blank(), legend.position = "none", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"),  plot.background = element_rect(fill = "transparent")) +
  facet_grid(y ~ embTreatment,scales = "free") +
  scale_fill_manual( values = c("All traders" = rgb(.96,.61,0), "Informed\ntraders" = rgb(1,.9,.50), "Uninformed\ntraders"  = rgb(1,.9,.50))) + 
  scale_y_continuous(breaks = c(-3:3)/2.5) +
  scale_color_manual("Role", values=c("dimgrey","black", "black", "dimgrey")) +
  geom_blank(aes(y= maxT))
#dev.off()
```

```{r plotoddsAllT, echo=F, results = 'asis', warning=F, fig.cap="Mean volume migration between phases by trader type (Figure 3)."}
#postscript("Figures/Graphmigration2.eps")
ggplot(data=subset(v, embTreatment == "All treatments"), aes(y=d, x= Role, group=y, fill = Role)) +
  geom_bar(stat="identity") +
  labs(y="Difference in ln(odds)") +
  geom_errorbar(aes(ymin=ll, ymax=ul, color=factor(Role)), width=.2) +
  theme(text = element_text(size=18),axis.title.x=element_blank(), legend.position = "none", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"),  plot.background = element_rect(fill = "transparent")) +
  facet_grid(. ~ y,scales = "free") +
  scale_fill_manual( values = c("All traders" = rgb(.96,.61,0), "Informed\ntraders" = rgb(1,.9,.50), "Uninformed\ntraders" = rgb(1,.9,.50))) + 
  scale_color_manual("Role", values=c("dimgrey","black", "black", "dimgrey")) +
  geom_blank(aes(y= -.9))
#dev.off()
```

```{r wtestodds0, echo = F}
#### Differences to 0 from Phase 1 to Phase 2
w0M1 <- wilcox.test(subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG" )$d1, mu = 0)
w0I1 <- wilcox.test(subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d1, mu = 0)
w0U1 <- wilcox.test(subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d1, mu = 0)
```

```{r wtestoddsR, echo = F}
#### Between roles from Phase 1 to Phase 2
reodds <- reshape2::dcast(subset(phasesummary, (Role == "Uninformed trader" | Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"), SessionID + embTreatment ~ Role, value.var = "d1")
wR1 <- wilcox.test(reodds$`Informed trader`, reodds$`Uninformed trader`, paired = T, exact = T)

```

```{r wtestodds0d3, echo = F}
#### Differences to 0 from Phase 2 to Phase 3
w0M3 <- wilcox.test(subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG" )$d3, mu = 0)
w0U3 <- wilcox.test(subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d3, mu = 0)
w0I3 <- wilcox.test(subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d3, mu = 0)
```

```{r wtestoddsRd3, echo = F}
#### Between roles from Phase 2 to Phase 3
reodds2 <- reshape2::dcast(subset(phasesummary, (Role == "Uninformed trader" | Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"), SessionID + embTreatment ~ Role, value.var = "d3")
wR3 <- wilcox.test(reodds2$`Informed trader`, reodds2$`Uninformed trader`, paired = T, exact = T)
```

```{r wtestoddsAll, echo = F}
#### Treatment differences from 1st to 2nd, then, 2nd to 3rd
kTM1 <- kruskal.test(log(odds) - log(odds_start) ~ embTreatment, data = subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG"))
kTM3 <- kruskal.test(log(odds_end) - log(odds) ~ embTreatment, data = subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG"))
kTM13 <- kruskal.test(log(odds_end) - log(odds_start) ~ embTreatment, data = subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG"))
kTI13 <- kruskal.test(log(odds_end) - log(odds_start) ~ embTreatment, data = subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"))
kTU13 <- kruskal.test(log(odds_end) - log(odds_start) ~ embTreatment, data = subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG"))
```


```{r wtestoddsinout, echo = F}
#### Differences between 1st to 2nd, and 2nd to 3rd (paired test)
wPM <- wilcox.test(log(odds_end) - log(odds_start) ~ 1, data = subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG"))
wPI <- wilcox.test(log(odds_end) - log(odds_start) ~ 1, data = subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"))
wPU <- wilcox.test(log(odds_end) - log(odds_start) ~ 1, data = subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG"))

```

```{r tableOdds, echo =F}
taOdds <- data.frame("Diff~0 Phase1~Phase2" = c(paste0("V=", w0M1$statistic, ", p =", format(w0M1$p.value, digits = 2, scientific = 5)), paste0("V=", w0I1$statistic, ", p =", format(w0I1$p.value, digits = 1, scientific = 5)), paste0("V=", w0U1$statistic, ", p =", format(w0U1$p.value, digits = 1, scientific = 5)), paste0("V=", wR1$statistic, ", p =", format(wR1$p.value, digits = 1, scientific = 5))),
                "Diff~0 Phase2~Phase3" = c(paste0("V=", w0M3$statistic, ", p =", format( w0M3$p.value, digits = 1, scientific = 5)), paste0("V=", w0I3$statistic, ", p =", format(w0I3$p.value, digits = 1, scientific = 5)), paste0("V=", w0U3$statistic, ", p =", format(w0U3$p.value, digits = 1, scientific = 5)), paste0("V=", wR3$statistic, ", p =", format(wR3$p.value, digits = 1, scientific = 5))),
                "Diff Phase1~Phase3" = c(paste0("V=", wPM$statistic, ", p =", format(wPM$p.value, digits = 4, scientific = 5)), paste0("V=", wPI$statistic, ", p =", format(wPI$p.value, digits = 4, scientific = 5)), paste0("V=", wPU$statistic, ", p =", format(wPU$p.value, digits = 4, scientific = 5)), paste0("")), 
                "Treat diff Phase1&Phase3" = c(paste0("H=", format(kTM13$statistic, digits = 4, scientific = 5), ", p =", format(kTM13$p.value, digits = 4, scientific = 5)), paste0("H=", format(kTI13$statistic, digits = 4, scientific = 5), ", p =", format(kTI13$p.value, digits = 4, scientific = 5)), paste0("H=", format(kTU13$statistic, digits = 4, scientific = 5), ", p =", format(kTU13$p.value, digits = 4, scientific = 5)), paste0("")))

rownames(taOdds) <- c("Market", "Informed traders", "Uninformed traders", "Role difference")

format(t(taOdds), digits = 4, scientific = 5)
```

*****************************************************************
\newpage

## Geometric odds
\begin{equation} \label{formula:geomodds}
    ln(odds)_{geom} =\frac{1}{Periods}\sum\limits_p^{Periods}\ln\left(\frac{Volume_{p,NOREG}}{Volume_{p,REG}}\right)
\end{equation}

```{r geomoddsotimereg, echo=FALSE ,fig.cap="Odds of upper market over time and regulation", warning=F}
avgmarketsummaryodds <- aggregate(cbind(Volume, log(Volume), LimitVolume, ProfitPotential, RUPT, GD, GAD, RD, RAD, volatility, log(odds), log(oddswins), log(oddsLimit), log(oddsUninf), log(oddsUninfwins), log(oddsInf), log(oddsInfwins), log(odds) - geomodds_start,log(odds) - geomodds_middle, log(odds) - geomodds_end) ~ Period + IsREG + Programme + embTreatment + regOrder + market, data=marketsummary, function(x) mean(x))
colnames(avgmarketsummaryodds) <- c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market", "Volume", "lnVolume", "LimitVolume", "ProfitPotential", "RUPT", "GD", "GAD", "RD", "RAD", "volatility", "geomodds", "geomoddswins", "geomoddsLimit", "geomoddsUni", "geomoddsUniwins", "geomoddsInf", "geomoddsInfwins", "diff1geomodds", "diff2geomodds", "diff3geomodds")
avgmarketsummaryoddsul <- aggregate(cbind(Volume, log(Volume), LimitVolume, ProfitPotential, RUPT, GD, GAD, RD, RAD, log(odds), log(oddswins), log(oddsLimit), log(oddsUninf), log(oddsUninfwins), log(oddsInf), log(oddsInfwins), log(odds) - geomodds_start, log(odds) - geomodds_middle, log(odds) - geomodds_end) ~ Period + IsREG + Programme + embTreatment + regOrder + market, data=marketsummary, function(x) quantile(x, probs = 0.025))
colnames(avgmarketsummaryoddsul) <- c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market", "ulVolume", "ullnVolume", "ulLimitVolume", "ulProfitPotential", "ulRUPT", "ulGD", "ulGAD", "ulRD", "ulRAD", "ulgeomodds", "ulgeomoddswins", "ulgeomoddsLimit", "ulgeomoddsUni", "ulgeomoddsUniwins", "ulgeomoddsInf", "ulgeomoddsInfwins", "uldiff1geomodds", "uldiff2geomodds", "uldiff3geomodds")
avgmarketsummaryoddsll <- aggregate(cbind(Volume, log(Volume), LimitVolume, ProfitPotential,RUPT, GD, GAD, RD, RAD, log(odds), log(oddswins), log(oddsLimit), log(oddsUninf), log(oddsUninfwins), log(oddsInf), log(oddsInfwins), log(odds) - geomodds_start, log(odds) - geomodds_middle, log(odds) - geomodds_end) ~ Period + IsREG + Programme + embTreatment + regOrder + market, data=marketsummary, function(x) quantile(x, probs = 0.975))
colnames(avgmarketsummaryoddsll) <- c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market", "llVolume", "lllnVolume", "llLimitVolume", "llProfitPotential", "llRUPT", "llGD", "llGAD", "llRD", "llRAD", "llgeomodds", "llgeomoddswins", "llgeomoddsLimit", "llgeomoddsUni", "llgeomoddsUniwins", "llgeomoddsInf", "llgeomoddsInfwins", "lldiff1geomodds", "lldiff2geomodds", "lldiff3geomodds")
avgmarketsummaryodds <- merge(avgmarketsummaryodds, avgmarketsummaryoddsul, by = c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market"))
avgmarketsummaryodds <- merge(avgmarketsummaryodds, avgmarketsummaryoddsll, by = c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market"))
avgmarketsummaryoddssd <- aggregate(cbind(Volume, log(Volume), LimitVolume, ProfitPotential, RUPT, GD, GAD, RD, RAD, volatility, log(odds), log(oddswins), log(oddsLimit), log(oddsUninf), log(oddsUninfwins), log(oddsInf), log(oddsInfwins), log(odds) - geomodds_start, log(odds) - geomodds_middle, log(odds) - geomodds_end) ~ Period + IsREG + Programme + embTreatment + regOrder + market, data=marketsummary, function(x) sd(x))
colnames(avgmarketsummaryoddssd) <- c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market", "sdVolume", "sdlnVolume", "sdLimitVolume", "sdProfitPotential", "sdRUPT", "sdGD", "sdGAD", "sdRD", "sdRAD", "sdvolatility", "sdgeomodds", "sdgeomoddswins", "sdgeomoddsLimit", "sdgeomoddsUni", "sdgeomoddsUniwins", "sdgeomoddsInf", "sdgeomoddsInswins", "sddiff1geomodds", "sddiff2geomodds", "sddiff3geomodds")
avgmarketsummaryoddsn <- aggregate( LimitVolume ~ Period + IsREG + Programme + embTreatment + regOrder + market, data=marketsummary, function(x) length(x))
colnames(avgmarketsummaryoddsn) <- c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market", "n")
avgmarketsummaryodds <- merge(avgmarketsummaryodds, avgmarketsummaryoddssd, by = c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market"))
avgmarketsummaryodds <- merge(avgmarketsummaryodds, avgmarketsummaryoddsn, by = c("Period","IsREG", "Programme", "embTreatment", "regOrder", "market"))
avgmarketsummaryodds$uplVolume <- avgmarketsummaryodds$Volume+qt(.975,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sdVolume/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$dolVolume <- avgmarketsummaryodds$Volume+qt(.025,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sdVolume/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$uplodds <- avgmarketsummaryodds$geomodds+qt(.975,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sdgeomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$dolodds <- avgmarketsummaryodds$geomodds+qt(.025,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sdgeomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$uploddswins <- avgmarketsummaryodds$geomoddswins+qt(.975,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sdgeomoddswins/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$doloddswins <- avgmarketsummaryodds$geomoddswins+qt(.025,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sdgeomoddswins/sqrt(avgmarketsummaryodds$n)

avgmarketsummaryodds$upldiff1odds <- avgmarketsummaryodds$diff1geomodds+qt(.975,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sddiff1geomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$doldiff1odds <- avgmarketsummaryodds$diff1geomodds+qt(.025,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sddiff1geomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$upldiff2odds <- avgmarketsummaryodds$diff2geomodds+qt(.975,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sddiff2geomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$doldiff2odds <- avgmarketsummaryodds$diff2geomodds+qt(.025,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sddiff2geomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$upldiff3odds <- avgmarketsummaryodds$diff3geomodds+qt(.975,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sddiff3geomodds/sqrt(avgmarketsummaryodds$n)
avgmarketsummaryodds$doldiff3odds <- avgmarketsummaryodds$diff3geomodds+qt(.025,avgmarketsummaryodds$n-1)*avgmarketsummaryodds$sddiff3geomodds/sqrt(avgmarketsummaryodds$n)

#postscript("Figures/GraphvolumeMarketOdds.eps")
ggplot(data=subset(avgmarketsummaryodds, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), aes(Period, diff1geomodds, color=interaction(regOrder), group = interaction(regOrder))) + 
  geom_line(data=subset(avgmarketsummaryodds, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Period<=3))) +
  geom_line(data=subset(avgmarketsummaryodds, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Period>=10))) + 
  geom_line(data=subset(avgmarketsummaryodds, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Period>=4 & Period<=9))) + 
  geom_line(data=subset(avgmarketsummaryodds, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Period<=4 & Period>=3)), linetype = "dashed") +
  geom_line(data=subset(avgmarketsummaryodds, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Period<=10 & Period>=9)), linetype = "dashed") +
  facet_grid(as.factor(embTreatment) ~ .) +
  scale_x_continuous(breaks=c(1:12))  + 
  theme(legend.position="bottom", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"),  plot.background = element_rect(fill = "transparent")) +
  geom_vline(aes(xintercept = 3.5)) +
  geom_vline(aes(xintercept = 9.5)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed") +
  labs(colour = " ", y = "Markets' mean trading volume")
#dev.off()
```


```{r histogrammgeomodds, echo=FALSE ,fig.cap="Distribution of odds of the upper market in Periods between the 4th and the 9th Period"}
a <- log(subset(marketsummary, Programme==3 & Period>3 & Period<10 & market == "Top" ,select= odds))
b <- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10 & market =="Top"), aes(log(odds), color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf()  + 
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
 
```

```{r plotgeomodds, echo=F, results = 'asis', warning=F, fig.cap="Geometric volume migration between phases by trader type and treatment observing each period individually."}
wInf <- aggregate(cbind(log(oddsInf) - geomoddsInf_start,log(oddsLimitInf) - geomoddsLimitInf_start, log(oddsInfwins) - geomoddsInfwins_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wInfn <- aggregate(cbind(log(oddsInf) - geomoddsInf_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wInfn) <- c("embTreatment", "n")
wInfsd <- aggregate(cbind(log(oddsInf) - geomoddsInf_start,log(oddsLimitInf) - geomoddsLimitInf_start, log(oddsInfwins) - geomoddsInfwins_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wInfsd) <- c( "embTreatment", "sdd", "sddL", "sddwins")
wInf <- merge(wInf, wInfsd, by=c("embTreatment"))
wInf <- merge(wInf, wInfn, by=c("embTreatment"))
wInf$y <- "From Phase 1 to Phase 2"
wInf$Role <- "Informed traders"
colnames(wInf)[colnames(wInf) == "V1"] <- "d"
colnames(wInf)[colnames(wInf) == "V2"] <- "dL"
colnames(wInf)[colnames(wInf) == "V3"] <- "dwins"

w2Inf <- aggregate(cbind(geomoddsInf_end - log(oddsInf), geomoddsLimitInf_end - log(oddsLimitInf), geomoddsInfwins_end - log(oddsInfwins)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
w2Infn <- aggregate(cbind(geomoddsInf_end - log(oddsInf)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(w2Infn) <- c("embTreatment", "n")
w2Infsd <- aggregate(cbind(geomoddsInf_end - log(oddsInf), geomoddsLimitInf_end - log(oddsLimitInf), geomoddsInfwins_end - log(oddsInfwins)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(w2Infsd) <- c( "embTreatment", "sdd", "sddL", "sddwins")
w2Inf <- merge(w2Inf, w2Infsd, by=c( "embTreatment"))
w2Inf <- merge(w2Inf, w2Infn, by=c("embTreatment"))
w2Inf$y <- "From Phase 2 to Phase 3"
colnames(w2Inf)[colnames(w2Inf) == "V1"] <- "d"
colnames(w2Inf)[colnames(w2Inf) == "V2"] <- "dL"
colnames(w2Inf)[colnames(w2Inf) == "V3"] <- "dwins"
w2Inf$Role <- "Informed traders"

wUni <- aggregate(cbind(log(oddsUninf) - geomoddsUni_start,log(oddsLimitUninf) - geomoddsLimitUni_start, log(oddsUninfwins) - geomoddsUniwins_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wUnin <- aggregate(cbind(log(oddsUninf) - geomoddsUni_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wUnin) <- c("embTreatment", "n")
wUnisd <- aggregate(cbind(log(oddsUninf) - geomoddsInf_start,log(oddsLimitUninf) - geomoddsLimitInf_start, log(oddsUninfwins) - geomoddsInfwins_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wUnisd) <- c( "embTreatment", "sdd", "sddL", "sddwins")
wUni <- merge(wUni, wUnisd, by=c("embTreatment"))
wUni <- merge(wUni, wUnin, by=c("embTreatment"))
wUni$y <- "From Phase 1 to Phase 2"
wUni$Role <- "Uninformed traders"
colnames(wUni)[colnames(wUni) == "V1"] <- "d"
colnames(wUni)[colnames(wUni) == "V2"] <- "dL"
colnames(wUni)[colnames(wUni) == "V3"] <- "dwins"

w2Uni <- aggregate(cbind(geomoddsUni_end - log(oddsUninf), geomoddsLimitUni_end - log(oddsLimitUninf), geomoddsUniwins_end - log(oddsUninfwins)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
w2Unin <- aggregate(cbind(geomoddsUni_end - log(oddsUninf)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(w2Unin) <- c("embTreatment", "n")
w2Unisd <- aggregate(cbind(geomoddsUni_end - log(oddsUninf), geomoddsLimitUni_end - log(oddsLimitUninf), geomoddsUniwins_end - log(oddsUninfwins)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(w2Unisd) <- c( "embTreatment", "sdd", "sddL", "sddwins")
w2Uni <- merge(w2Uni, w2Unisd, by=c( "embTreatment"))
w2Uni <- merge(w2Uni, w2Unin, by=c("embTreatment"))
w2Uni$y <- "From Phase 2 to Phase 3"
colnames(w2Uni)[colnames(w2Uni) == "V1"] <- "d"
colnames(w2Uni)[colnames(w2Uni) == "V2"] <- "dL"
colnames(w2Uni)[colnames(w2Uni) == "V3"] <- "dwins"
w2Uni$Role <- "Uninformed traders"

w3 <- aggregate(cbind(log(odds) - geomodds_start,log(oddsLimit) - geomoddsLimit_start, log(oddswins) - geomoddswins_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
w3n <- aggregate(cbind(log(odds) - geomodds_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(w3n) <- c("embTreatment", "n")
w3sd <- aggregate(cbind(log(odds) - geomodds_start,log(oddsLimit) - geomoddsLimit_start, log(oddswins) - geomoddswins_start) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(w3sd) <- c( "embTreatment", "sdd", "sddL", "sddwins")
w3 <- merge(w3, w3sd, by=c("embTreatment"))
w3 <- merge(w3, w3n, by=c("embTreatment"))
w3$y <- "From Phase 1 to Phase 2"
w3$Role <- "All traders"
colnames(w3)[colnames(w3) == "V1"] <- "d"
colnames(w3)[colnames(w3) == "V2"] <- "dL"
colnames(w3)[colnames(w3) == "V3"] <- "dwins"
w4 <- aggregate(cbind(geomodds_end - log(odds),geomoddsLimit_end - log(oddsLimit), geomoddswins_end - log(oddswins)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
w4n <- aggregate(cbind(geomodds_end - log(odds)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(w4n) <- c("embTreatment", "n")
w4sd <- aggregate(cbind(geomodds_end - log(odds),geomoddsLimit_end - log(oddsLimit), geomoddswins_end - log(oddswins)) ~ embTreatment, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(w4sd) <- c( "embTreatment", "sdd", "sddL", "sddwins")
w4 <- merge(w4, w4sd, by=c( "embTreatment"))
w4 <- merge(w4, w4n, by=c("embTreatment"))
w4$y <- "From Phase 2 to Phase 3"
colnames(w4)[colnames(w4) == "V1"] <- "d"
colnames(w4)[colnames(w4) == "V2"] <- "dL"
colnames(w4)[colnames(w4) == "V3"] <- "dwins"
w4$Role <- "All traders"
w <- rbind(wInf, w2Inf, wUni, w2Uni, w3, w4)
w$embTreatment <- factor(w$embTreatment, labels = c("NN.RR","RR.NN", "RR.RR"))
w$Role <- factor(w$Role, labels = c("All traders","Informed\ntraders","Uninformed\ntraders"))
w$Role <- ordered(w$Role, levels = c("All traders","Informed\ntraders","Uninformed\ntraders"))
w$ll <- w$d + qt(.025,w$n)*w$sdd/sqrt(w$n)
w$ul <- w$d + qt(.975,w$n)*w$sdd/sqrt(w$n)
w$llwins <- w$dwins + qt(.025,w$n)*w$sddwins/sqrt(w$n)
w$ulwins <- w$dwins + qt(.975,w$n)*w$sddwins/sqrt(w$n)
w$maxT <- NA
w$maxT[w$y == "From Phase 2 to Phase 3"] <- -max(w$d)
w$maxL <- NA
w$maxL[w$y == "From Phase 2 to Phase 3"] <- -max(w$dL)

ggplot(data=w, aes(y=d, x= Role, group=interaction(embTreatment,y), fill = Role)) +
  geom_bar(stat="identity") +  
  labs(y=expression("Difference in ln(odds)"["geom"])) +
  geom_errorbar(aes(ymin=ll, ymax=ul, color=factor(Role)), width=.2) +
  theme(text = element_text(size=18),axis.title.x=element_blank(), legend.position = "none", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(y ~ embTreatment,scales = "free") +
  scale_fill_manual( values = c("All traders" = rgb(.96,.61,0), "Informed\ntraders" = rgb(1,.9,.50), "Uninformed\ntraders" = rgb(1,.9,.50))) +
  scale_color_manual("Role", values=c("dimgrey","black", "black", "dimgrey"))

```

```{r plotgeomoddswins, echo=F, fig.cap="Winsorized geometric volume migration between phases by trader type and treatment observing each period individually."}
ggplot(data=w, aes(y=dwins, x= Role, group=interaction(embTreatment,y), fill = Role)) +
  geom_bar(stat="identity") +  
  labs(y=expression("Difference in ln(odds)"["geom"])) +
  geom_errorbar(aes(ymin=llwins, ymax=ulwins, color=factor(Role)), width=.2) +
  theme(text = element_text(size=18),axis.title.x=element_blank(), legend.position = "none", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(y ~ embTreatment,scales = "free") +
  scale_fill_manual( values = c("All traders" = rgb(.96,.61,0), "Informed\ntraders" = rgb(1,.9,.50), "Uninformed\ntraders" = rgb(1,.9,.50))) +
  scale_color_manual("Role", values=c("dimgrey","black", "black", "dimgrey"))

```


```{r plotgeomodds2, echo=F, results = 'asis', warning=F, fig.cap="Geometric volume migration between phases by trader type and treatment (Figure WA3)."}
#postscript("Figures/Graphgeomodds.eps") 
  ggplot(data=subset(v, embTreatment != "All treatments"), aes(y=dP, x= Role, group=interaction(embTreatment,y), fill = Role)) +
  geom_bar(stat="identity") +  
  labs(y=expression("Difference in ln(odds)"["geom"])) +
  geom_errorbar(aes(ymin=llP, ymax=ulP, color=factor(Role)), width=.2) +
  theme(text = element_text(size=18),axis.title.x=element_blank(), legend.position = "none", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(y ~ embTreatment,scales = "free") +
  scale_fill_manual( values = c("All traders" = rgb(.96,.61,0), "Informed\ntraders" = rgb(1,.9,.50), "Uninformed\ntraders" = rgb(1,.9,.50))) + 
  scale_color_manual("Role", values=c("dimgrey","black", "black", "dimgrey")) +
  geom_blank(aes(y= maxP))
#dev.off()
```


```{r plotgeomodds3, echo=F, results = 'asis', warning=F, fig.cap="Geometric volume migration between phases by trader type, treatment, and market observing each period individually."}
wzInf <- aggregate(cbind(log(oddsInf) - geomoddsInf_start,log(oddsLimitInf) - geomoddsLimitInf_start, log(oddsInfwins) - geomoddsInfwins_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wzInfn <- aggregate(cbind(log(oddsInf) - geomoddsInf_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wzInfn) <- c("embTreatment", "market", "n")
wzInfsd <- aggregate(cbind(log(oddsInf) - geomoddsInf_start,log(oddsLimitInf) - geomoddsLimitInf_start, log(oddsInfwins) - geomoddsInfwins_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wzInfsd) <- c( "embTreatment", "market", "sdd", "sddL", "sddwins")
wzInf <- merge(wzInf, wzInfsd, by=c("embTreatment", "market"))
wzInf <- merge(wzInf, wzInfn, by=c("embTreatment", "market"))
wzInf$y <- "From Phase 1 to Phase 2"
wzInf$Role <- "Informed traders"
colnames(wzInf)[colnames(wzInf) == "V1"] <- "d"
colnames(wzInf)[colnames(wzInf) == "V2"] <- "dL"
colnames(wzInf)[colnames(wzInf) == "V3"] <- "dwins"
wz2Inf <- aggregate(cbind(geomoddsInf_end - log(oddsInf),geomoddsLimitInf_end - log(oddsLimitInf), geomoddsInfwins_end - log(oddsInfwins)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wz2Infn <- aggregate(cbind(geomoddsInf_end - log(oddsInf)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wz2Infn) <- c("embTreatment", "market", "n")
wz2Infsd <- aggregate(cbind(geomoddsInf_end - log(oddsInf),geomoddsLimitInf_end - log(oddsLimitInf), geomoddsInfwins_end - log(oddsInfwins)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wz2Infsd) <- c( "embTreatment", "market", "sdd", "sddL", "sddwins")
wz2Inf <- merge(wz2Inf, wz2Infsd, by=c( "embTreatment", "market"))
wz2Inf <- merge(wz2Inf, wz2Infn, by=c("embTreatment", "market"))
wz2Inf$y <- "From Phase 2 to Phase 3"
colnames(wz2Inf)[colnames(wz2Inf) == "V1"] <- "d"
colnames(wz2Inf)[colnames(wz2Inf) == "V2"] <- "dL"
colnames(wz2Inf)[colnames(wz2Inf) == "V3"] <- "dwins"
wz2Inf$Role <- "Informed traders"

wzUni <- aggregate(cbind(log(oddsUninf) - geomoddsUni_start,log(oddsLimitUninf) - geomoddsLimitUni_start, log(oddsUninfwins) - geomoddsUniwins_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wzUnin <- aggregate(cbind(log(oddsUninf) - geomoddsUni_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wzUnin) <- c("embTreatment", "market", "n")
wzUnisd <- aggregate(cbind(log(oddsUninf) - geomoddsUni_start,log(oddsLimitUninf) - geomoddsLimitUni_start, log(oddsUninfwins) - geomoddsUniwins_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wzUnisd) <- c( "embTreatment", "market", "sdd", "sddL", "sddwins")
wzUni <- merge(wzUni, wzUnisd, by=c("embTreatment", "market"))
wzUni <- merge(wzUni, wzUnin, by=c("embTreatment", "market"))
wzUni$y <- "From Phase 1 to Phase 2"
wzUni$Role <- "Uninformed traders"
colnames(wzUni)[colnames(wzUni) == "V1"] <- "d"
colnames(wzUni)[colnames(wzUni) == "V2"] <- "dL"
colnames(wzUni)[colnames(wzUni) == "V3"] <- "dwins"
wz2Uni <- aggregate(cbind(geomoddsUni_end - log(oddsUninf),geomoddsLimitUni_end - log(oddsLimitUninf), geomoddsUniwins_end - log(oddsUninfwins)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wz2Unin <- aggregate(cbind(geomoddsUni_end - log(oddsUninf)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wz2Unin) <- c("embTreatment", "market", "n")
wz2Unisd <- aggregate(cbind(geomoddsUni_end - log(oddsUninf),geomoddsLimitUni_end - log(oddsLimitUninf), geomoddsUniwins_end - log(oddsUninfwins)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wz2Unisd) <- c( "embTreatment", "market", "sdd", "sddL", "sddwins")
wz2Uni <- merge(wz2Uni, wz2Unisd, by=c( "embTreatment", "market"))
wz2Uni <- merge(wz2Uni, wz2Unin, by=c("embTreatment", "market"))
wz2Uni$y <- "From Phase 2 to Phase 3"
colnames(wz2Uni)[colnames(wz2Uni) == "V1"] <- "d"
colnames(wz2Uni)[colnames(wz2Uni) == "V2"] <- "dL"
colnames(wz2Uni)[colnames(wz2Uni) == "V3"] <- "dwins"
wz2Uni$Role <- "Uninformed traders"

wz3 <- aggregate(cbind(log(odds) - geomodds_start,log(oddsLimit) - geomoddsLimit_start, log(oddswins) - geomoddswins_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wz3n <- aggregate(cbind(log(odds) - geomodds_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wz3n) <- c("embTreatment", "market", "n")
wz3sd <- aggregate(cbind(log(odds) - geomodds_start,log(oddsLimit) - geomoddsLimit_start, log(oddswins) - geomoddswins_start) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wz3sd) <- c( "embTreatment", "market", "sdd", "sddL", "sddwins")
wz3 <- merge(wz3, wz3sd, by=c("embTreatment", "market"))
wz3 <- merge(wz3, wz3n, by=c("embTreatment", "market"))
wz3$y <- "From Phase 1 to Phase 2"
wz3$Role <- "All traders"
colnames(wz3)[colnames(wz3) == "V1"] <- "d"
colnames(wz3)[colnames(wz3) == "V2"] <- "dL"
colnames(wz3)[colnames(wz3) == "V3"] <- "dwins"
wz4 <- aggregate(cbind(geomodds_end - log(odds),geomoddsLimit_end - log(oddsLimit), geomoddswins_end - log(oddswins)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) mean(x[x < Inf & x > -Inf], na.rm = TRUE))
wz4n <- aggregate(cbind(geomodds_end - log(odds)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) length(x[x < Inf & x > -Inf]))
colnames(wz4n) <- c("embTreatment", "market", "n")
wz4sd <- aggregate(cbind(geomodds_end - log(odds),geomoddsLimit_end - log(oddsLimit), geomoddswins_end - log(oddswins)) ~ embTreatment + market, data = subset(marketsummary, Phase == "Phase 2"& IsREG == "NOREG"), function(x) sd(x[x < Inf & x > -Inf], na.rm = TRUE))
colnames(wz4sd) <- c( "embTreatment", "market", "sdd", "sddL", "sddwins")
wz4 <- merge(wz4, wz4sd, by=c( "embTreatment", "market"))
wz4 <- merge(wz4, wz4n, by=c("embTreatment", "market"))
wz4$y <- "From Phase 2 to Phase 3"
colnames(wz4)[colnames(wz4) == "V1"] <- "d"
colnames(wz4)[colnames(wz4) == "V2"] <- "dL"
colnames(wz4)[colnames(wz4) == "V3"] <- "dwins"
wz4$Role <- "All traders"
wz <- rbind(wzInf, wz2Inf, wzUni, wz2Uni, wz3, wz4)
wz$embTreatment <- factor(wz$embTreatment, labels = c("NN.RR","RR.NN", "RR.RR"))
wz$Role <- factor(wz$Role, labels = c("All traders","Informed\ntraders","Uninformed\ntraders"))
wz$Role <- ordered(wz$Role, levels = c("All traders","Informed\ntraders","Uninformed\ntraders"))
wz$ll <- wz$d + qt(.025,wz$n)*wz$sdd/sqrt(wz$n)
wz$ul <- wz$d + qt(.975,wz$n)*wz$sdd/sqrt(wz$n)
wz$maxT <- NA
wz$maxT[wz$y == "From Phase 2 to Phase 3"] <- -max(wz$d)
wz$maxL <- NA
wz$maxL[wz$y == "From Phase 2 to Phase 3"] <- -max(wz$dL)

ggplot(data=wz, aes(y=d, x= Role, group=interaction(embTreatment,y), fill = Role)) +
  geom_bar(stat="identity") +  
  labs(y=expression("Difference in ln(odds)"["geom"])) +
  geom_errorbar(aes(ymin=ll, ymax=ul, color=factor(Role)), width=.2) +
  theme(text = element_text(size=18),axis.title.x=element_blank(), legend.position = "none", panel.grid.minor = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid( embTreatment ~ market + y,scales = "free") +
  scale_fill_manual( values = c("All traders" = rgb(.96,.61,0), "Informed\ntraders" = rgb(1,.9,.50), "Uninformed\ntraders" = rgb(1,.9,.50))) +
  scale_color_manual("Role", values=c("dimgrey","black", "black", "dimgrey"))

```

```{r wtestgeomodds0, echo = F, results = 'asis'}
#### Differences to 0 from Phase 1 to Phase 2
wg0M1 <- wilcox.test(subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG" )$d1P, mu = 0)
wg0U1 <- wilcox.test(subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d1P, mu = 0)
wg0I1 <- wilcox.test(subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d1P, mu = 0)
```

```{r ttestgeomodds0, echo = F}
tg0M1 <- t.test(log(odds) ~ Phase, data = subset(marketsummary, (Phase == "Phase 1" | Phase == "Phase 2") & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), var.equal=T)
tg0U1 <- t.test(log(oddsUninf) ~ Phase, data = subset(marketsummary, (Phase == "Phase 1" | Phase == "Phase 2") & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), var.equal=T)
tg0I1 <- t.test(log(oddsInfwins) ~ Phase, data = subset(marketsummary, (Phase == "Phase 1" | Phase == "Phase 2") & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), var.equal=T, na.action = na.omit)
```

```{r wtestgeomoddsR, echo = F}
#### Between roles from Phase 1 to Phase 2
reoddsP <- reshape2::dcast(subset(phasesummary, (Role == "Uninformed trader" | Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"), SessionID + embTreatment ~ Role, value.var = "d1P")
wgR1 <- wilcox.test(reoddsP$`Informed trader`, reoddsP$`Uninformed trader`, paired = T, exact = T)
```


```{r ttestgeomoddsR, echo = F}
marketsummary1 <- subset(marketsummary, Phase == "Phase 2" & IsREG == "NOREG" & log(oddsInf)<Inf & log(oddsInf)>-Inf)
tgR1 <- t.test((log(marketsummary1$oddsInf) - marketsummary1$geomoddsInf_start) - (log(marketsummary1$oddsUninf) - marketsummary1$geomoddsUni_start), var.equal=T, na.action = na.omit)

#tgR1 <- t.test(log(odds) - geomodds_start ~ Role, data = subset(Rolesummary, (Role == "Uninformed trader" | Role == "Informed trader") & Part == "middle" & IsREG == "NOREG" & log(odds)<Inf & log(odds)>-Inf), var.equal=T, na.action = na.omit)
```

```{r wtestgeomodds0d3, echo = F}
#### Differences to 0 from Phase 2 to Phase 3
wg0M3 <- wilcox.test(subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG" )$d3P, mu = 0)
wg0I3 <- wilcox.test(subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d3P, mu = 0)
wg0U3 <- wilcox.test(subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG" )$d3P, mu = 0)
```


```{r ttestgeomodds0d3, echo = F}
tg0M3 <- t.test(log(odds) ~ Phase, data = subset(marketsummary, (Phase == "Phase 3" | Phase == "Phase 2") & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), var.equal=T)
tg0U3 <- t.test(log(oddsUninf) ~ Phase, data = subset(marketsummary, (Phase == "Phase 3" | Phase == "Phase 2") & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), var.equal=T)
tg0I3 <- t.test(log(oddsInfwins) ~ Phase, data = subset(marketsummary, (Phase == "Phase 3" | Phase == "Phase 2") & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))), var.equal=T, na.action = na.omit)
```

```{r wtestgeomoddsRd3, echo = F}
#### Between roles from Phase 2 to Phase 3
reodds2 <- reshape2::dcast(subset(phasesummary, (Role == "Uninformed trader" | Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"), SessionID + embTreatment ~ Role, value.var = "d3")
wgR3 <- wilcox.test(reodds2$`Informed trader`, reodds2$`Uninformed trader`, paired = T, exact = T)
```

```{r ttestgeomoddsRd3, echo = F}
tgR3 <- t.test((log(marketsummary1$oddsInfwins) - marketsummary1$geomoddsInfwins_start) - (log(marketsummary1$oddsUninfwins) - marketsummary1$geomoddsUniwins_start), var.equal=T, na.action = na.omit)

#tgR3 <- t.test(geomoddswins_end - log(oddswins) ~ Role, data = subset(rolesummary, (Role == "Uninformed trader" | Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"), var.equal=T, paired = T)
```

```{r ktestgeomodds, echo = F}
#### Treatment differences for uninformed traders from 1st to 2nd, then, 2nd to 3rd
kgTU1 <- kruskal.test(geomodds - geomodds_start ~ embTreatment, data = subset(phasesummary, Role == "Uninformed trader" & Phase == "Phase 2" & IsREG == "NOREG"))
kgTU3 <- kruskal.test(geomodds_end - geomodds ~ embTreatment, data = subset(phasesummary, Role == "Uninformed trader" & Phase == "Phase 2" & IsREG == "NOREG"))
kgTM13 <- kruskal.test(geomodds_end - geomodds_start ~ embTreatment, data = subset(phasesummary, Role == "market" & Phase == "Phase 2" & IsREG == "NOREG"))
kgTI13 <- kruskal.test(geomodds_end - geomodds_start ~ embTreatment, data = subset(phasesummary, Role == "Informed trader" & Phase == "Phase 2" & IsREG == "NOREG"))
kgTU13 <- kruskal.test(geomodds_end - geomodds_start ~ embTreatment, data = subset(phasesummary, Role == "Uninformed trader" & Phase == "Phase 2" & IsREG == "NOREG"))

```

```{r wtestgeomoddsinout, echo = F}
#### Differences between 1st to 2nd, and 2nd to 3rd - Uniformed, then, informed traders (paird test)
wgPM <- wilcox.test(geomodds_end - geomodds_start ~ 1, data = subset(phasesummary, (Role == "market") & Phase == "Phase 2" & IsREG == "NOREG"))
wgPI <- wilcox.test(geomodds_end - geomodds_start ~ 1, data = subset(phasesummary, (Role == "Informed trader") & Phase == "Phase 2" & IsREG == "NOREG"))
wgPU <- wilcox.test(geomodds_end - geomodds_start ~ 1, data = subset(phasesummary, (Role == "Uninformed trader") & Phase == "Phase 2" & IsREG == "NOREG"))

tgPM <- t.test(log(odds) ~ Phase, data = subset(marketsummary, (Phase != "Phase 2" & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")))), paired = T)
tgPU <- t.test(log(oddsUninf) ~ Phase, data = subset(marketsummary, (Phase != "Phase 2" & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")))), paired = T)
tgPI <- t.test(log(oddsInfmax) ~ Phase, data = subset(marketsummary, (Phase != "Phase 2" & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")))), paired = T)
tgPI2 <- t.test(log(oddsInfwins) ~ Phase, data = subset(marketsummary, (Phase != "Phase 2" & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")))), paired = T)
```

#### Tests observing phases
```{r tablegeomodds, echo =F}
tageomodds <- data.frame("Diff~0 Phase1~Phase2" = c(paste0("V=", wg0M1$statistic, ", p =", format(wg0M1$p.value, digits = 1, scientific = 5)), paste0("V=", wg0I1$statistic, ", p =", format(wg0I1$p.value, digits = 1, scientific = 5)), paste0("V=", wg0U1$statistic, ", p =", format(wg0U1$p.value, digits = 4, scientific = 5)), paste0("V=", wgR1$statistic, ", p =", format(wgR1$p.value, digits = 1, scientific = 5))),
                "Diff~0 Phase2~Phase3" = c(paste0("V=", wg0M3$statistic, ", p =", format(wg0M3$p.value, digits = 4, scientific = 5)), paste0("V=", wg0I3$statistic, ", p =", format(wg0I3$p.value, digits = 1, scientific = 5)), paste0("V=", wg0U3$statistic, ", p =", format(wg0U3$p.value, digits = 4, scientific = 5)), paste0("V=", wgR3$statistic, ", p =", format(wgR3$p.value, digits = 1, scientific = 5))),
                "Diff Phase1~Phase3" = c(paste0("V=", wgPM$statistic, ", p =", format(wgPM$p.value, digits = 4, scientific = 5)), paste0("V=", wgPI$statistic, ", p =", format(wgPI$p.value, digits = 4, scientific = 5)), paste0("V=", wgPU$statistic, ", p =", format(wgPU$p.value, digits = 4, scientific = 5)), paste0("")), 
                "Treatment diff Phase1&Phase3" = c(paste0("H=", format(kgTM13$statistic, digits = 4, scientific = 5), ", p =", format(kgTM13$p.value, digits = 4, scientific = 5)), paste0("H=", format(kgTI13$statistic, digits = 4, scientific = 5), ", p =", format(kgTI13$p.value, digits = 4, scientific = 5)), paste0("H=", format(kgTU13$statistic, digits = 4, scientific = 5), ", p =", format(kgTU13$p.value, digits = 4, scientific = 5)), paste0("")))

rownames(tageomodds) <- c("market", "Informed traders", "Uninformed traders", "Role difference")

format(t(tageomodds), digits = 1, scientific = 5)
```

#### Tests observing periods
```{r tabletgeomodds, echo =F}
tageomodds <- data.frame("Diff~0 Phase1~Phase2" = c(paste0("t=", format(tg0M1$statistic, digits = 4, scientific = 5), ", p =", format(tg0M1$p.value, digits = 1, scientific = 5)), paste0("t=", format(tg0I1$statistic, digits = 4, scientific = 5), ", p =", format(tg0I1$p.value, digits = 1, scientific = 5)), paste0("t=", format(tg0U1$statistic, digits = 4, scientific = 5), ", p =", format(tg0U1$p.value, digits = 1, scientific = 5)), paste0("t=", format(tgR1$statistic, digits = 4, scientific = 5), ", p =", format(tgR1$p.value, digits = 1, scientific = 5))),
                "Diff~0 Phase2~Phase3" = c(paste0("t=", format(tg0M3$statistic, digits = 4, scientific = 5), ", p =", format(tg0M3$p.value, digits = 4, scientific = 5)), paste0("t=", format(tg0I3$statistic, digits = 4, scientific = 5), ", p =", format(tg0I3$p.value, digits = 1, scientific = 5)), paste0("t=", format(tg0U3$statistic, digits = 4, scientific = 5), ", p =", format(tg0U3$p.value, digits = 4, scientific = 5)), paste0("t=", format(tgR3$statistic, digits = 4, scientific = 5), ", p =", format(tgR3$p.value, digits = 1, scientific = 5))),
                "Diff Phase1~Phase3" = c(paste0("t=", format(tgPM$statistic, digits = 4, scientific = 5), ", p =", format(tgPM$p.value, digits = 2, scientific = 5)), paste0("t=", format(tgPI$statistic, digits = 4, scientific = 5), ", p =", format(tgPI$p.value, digits = 3, scientific = 5)), paste0("t=", format(tgPU$statistic, digits = 4, scientific = 5), ", p =", format(tgPU$p.value, digits = 4, scientific = 5)), paste0("")))

rownames(tageomodds) <- c("market", "Informed traders", "Uninformed traders", "Role difference")

format(t(tageomodds), digits = 1, scientific = 5)
```

### Geometric odds (market ‘log(odds)’) by trader type, treatment, and phase (Table WA8).
```{r toddsstartTreat, echo = F}
dat_oddsTreat <- matrix(data = NA, ncol = 9, nrow = 4)
  eoddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1")), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1")), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1")), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_oddsTreat[1,] <- as.numeric(c(eoddsTreat, toddsTreat, eoddsTreatInf, toddsTreatInf, eoddsTreatUni, toddsTreatUni))
i <- 2
while(i<5){
for(t in c("NN.RR", "RR.NN", "RR.RR")){
  eoddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1") & embTreatment == t), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1") & embTreatment == t), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 1") & embTreatment == t), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_oddsTreat[i,] <- as.numeric(c(eoddsTreat, toddsTreat, eoddsTreatInf, toddsTreatInf, eoddsTreatUni, toddsTreatUni))
  i <- i + 1
}}
                    
colnames(dat_oddsTreat) <- c("start", "middle", "p_market", "start", "middle", "p_Inf","start", "middle", "p_Uni")
row.names(dat_oddsTreat) <- c("odds all", "odds NR", "odds RN", "odds RR")

dat_oddsTreat
```

```{r toddsendTreat, echo = F}
dat_oddsTreat <- matrix(data = NA, ncol = 9, nrow = 4)
  eoddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3")), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3")), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3")), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_oddsTreat[1,] <- as.numeric(c(eoddsTreat, toddsTreat, eoddsTreatInf, toddsTreatInf, eoddsTreatUni, toddsTreatUni))
i <- 2
while(i<5){
for(t in c("NN.RR", "RR.NN", "RR.RR")){
  eoddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 2" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$p.value, digits = 4), scientific = FALSE)
  dat_oddsTreat[i,] <- as.numeric(c(eoddsTreat, toddsTreat, eoddsTreatInf, toddsTreatInf, eoddsTreatUni, toddsTreatUni))
  i <- i + 1
}}
                    
colnames(dat_oddsTreat) <- c("middle", "end", "p_market", "middle", "end", "p_Inf", "middle", "end", "p_Uni")
row.names(dat_oddsTreat) <- c("odds all", "odds NR", "odds RN", "odds RR")

dat_oddsTreat
```

```{r todds13Treat, echo = F}
dat_oddsTreat <- matrix(data = NA, ncol = 9, nrow = 4)
  eoddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3")), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3")), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3")), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3")), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
  dat_oddsTreat[1,] <- as.numeric(c(eoddsTreat, toddsTreat, eoddsTreatInf, toddsTreatInf, eoddsTreatUni, toddsTreatUni))
i <- 2
while(i<5){
for(t in c("NN.RR", "RR.NN", "RR.RR")){
  eoddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreat <- format(round(t.test(log(odds) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3") & embTreatment == t), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatInf <- format(round(t.test(log(oddsInfmax) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3") & embTreatment == t), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
  eoddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3") & embTreatment == t), var.equal=T)$estimate, digits = 4), scientific = FALSE)
  toddsTreatUni <- format(round(t.test(log(oddsUninf) ~ Phase, data=subset(marketsummary, Period>0 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & (Phase == "Phase 1" | Phase == "Phase 3") & embTreatment == t), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
  dat_oddsTreat[i,] <- as.numeric(c(eoddsTreat, toddsTreat, eoddsTreatInf, toddsTreatInf, eoddsTreatUni, toddsTreatUni))
  i <- i + 1
}}
                    
colnames(dat_oddsTreat) <- c("start", "end", "p_market", "start", "end", "p_Inf", "start", "end", "p_Uni")
row.names(dat_oddsTreat) <- c("odds all", "odds NR", "odds RN", "odds RR")

dat_oddsTreat
```

```{r tableodds, echo = F, results = 'asis', warning=F}
lnoddsmiddleUninf <- lm(log(oddsUninfwins) - geomoddsUniwins_start ~ history + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>3 & Period<10))
lnoddsmiddleInf <- lm(log(oddsInfwins) - geomoddsInfwins_start ~ history + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>3 & Period<10))
lnoddsbeginningUninf <- lm(log(oddsUninfwins) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period<=3))
lnoddsbeginningInf <- lm(log(oddsInfwins) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period<=3))
lnoddsendUninf <- lm(log(oddsUninfwins) - geomoddsUniwins_start ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>=10))
lnoddsendInf <- lm(log(oddsInfwins) - geomoddsInfwins_start ~  history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>=10))

lnoddsallUninf <- lm(log(oddsUninfwins) - geomoddsUniwins_start ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))))
lnoddsallInf <- lm(log(oddsInfwins) - geomoddsInfwins_start ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))))

lnoddsmiddle <- lm(log(oddswins) - geomoddswins_start ~ history + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>3 & Period<10))
lnoddsbeginning <- lm(log(oddswins) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period<=3))
lnoddsend <- lm(log(oddswins) - geomoddswins_start ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>=10))
lnoddsall <- lm(log(oddswins) - geomoddswins_start ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))))

se_lnoddsmiddle <- coeftest(lnoddsmiddle, vcov. = vcovCL(lnoddsmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsmiddle <- coeftest(lnoddsmiddle, vcov. = vcovCL(lnoddsmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsbeginning <- coeftest(lnoddsbeginning, vcov. = vcovCL(lnoddsbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsbeginning <- coeftest(lnoddsbeginning, vcov. = vcovCL(lnoddsbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsend <- coeftest(lnoddsend, vcov. = vcovCL(lnoddsend, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsend <- coeftest(lnoddsend, vcov. = vcovCL(lnoddsend, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsall <- coeftest(lnoddsall, vcov. = vcovCL(lnoddsall, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsall <- coeftest(lnoddsall, vcov. = vcovCL(lnoddsall, cluster = ~ SessionID, type = "HC3"))[,4]


se_lnoddsmiddleUninf <- coeftest(lnoddsmiddleUninf, vcov. = vcovCL(lnoddsmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsmiddleUninf <- coeftest(lnoddsmiddleUninf, vcov. = vcovCL(lnoddsmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsbeginningUninf <- coeftest(lnoddsbeginningUninf, vcov. = vcovCL(lnoddsbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsbeginningUninf <- coeftest(lnoddsbeginningUninf, vcov. = vcovCL(lnoddsbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsendUninf <- coeftest(lnoddsendUninf, vcov. = vcovCL(lnoddsendUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsendUninf <- coeftest(lnoddsendUninf, vcov. = vcovCL(lnoddsendUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsallUninf <- coeftest(lnoddsallUninf, vcov. = vcovCL(lnoddsallUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsallUninf <- coeftest(lnoddsallUninf, vcov. = vcovCL(lnoddsallUninf, cluster = ~ SessionID, type = "HC3"))[,4]

se_lnoddsmiddleInf <- coeftest(lnoddsmiddleInf, vcov. = vcovCL(lnoddsmiddleInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsmiddleInf <- coeftest(lnoddsmiddleInf, vcov. = vcovCL(lnoddsmiddleInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsbeginningInf <- coeftest(lnoddsbeginningInf, vcov. = vcovCL(lnoddsbeginningInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsbeginningInf <- coeftest(lnoddsbeginningInf, vcov. = vcovCL(lnoddsbeginningInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsendInf <- coeftest(lnoddsendInf, vcov. = vcovCL(lnoddsendInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsendInf <- coeftest(lnoddsendInf, vcov. = vcovCL(lnoddsendInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsallInf <- coeftest(lnoddsallInf, vcov. = vcovCL(lnoddsallInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsallInf <- coeftest(lnoddsallInf, vcov. = vcovCL(lnoddsallInf, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(lnoddsbeginning, lnoddsmiddle, lnoddsend,lnoddsbeginningInf, lnoddsmiddleInf, lnoddsendInf, lnoddsbeginningUninf, lnoddsmiddleUninf, lnoddsendUninf), custom.note = ("\\parbox{1\\linewidth}{\\vspace{2pt}%stars. \\\\ One market per session and period is taken into account since the other corresponds to the negative complement. Markets considered had *NOREG* in Phase 2, i.e. top markets in Treatments .NR. and bottom markets in Treatmens .RN.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Regressions of geometric trader migration (‘ln(odds)’) by trader type and phase.", custom.header = list('All traders' = 1:3, 'Informed trader' = 4:6, 'Uninformed trader' = 7:9),
       override.se=list(se_lnoddsbeginning, se_lnoddsmiddle, se_lnoddsend, se_lnoddsbeginningInf, se_lnoddsmiddleInf, se_lnoddsendInf, se_lnoddsbeginningUninf, se_lnoddsmiddleUninf, se_lnoddsendUninf), 
       override.p = list(p_lnoddsbeginning, p_lnoddsmiddle, p_lnoddsend, p_lnoddsbeginningInf, p_lnoddsmiddleInf, p_lnoddsendInf, p_lnoddsbeginningUninf, p_lnoddsmiddleUninf, p_lnoddsendUninf))
```

```{r tableodds5, echo = F, results = 'asis', warning=F}
lnoddsmiddleUninf <- lm(log(oddsUninfwins) ~ history + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>3 & Period<10))
lnoddsmiddleInf <- lm(log(oddsInfwins) ~ history + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>3 & Period<10))
lnoddsbeginningUninf <- lm(log(oddsUninfwins) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period<=3))
lnoddsbeginningInf <- lm(log(oddsInfwins) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period<=3))
lnoddsendUninf <- lm(log(oddsUninfwins) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>=10))
lnoddsendInf <- lm(log(oddsInfwins)  ~  history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>=10))

lnoddsallUninf <- lm(log(oddsUninfwins) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))))
lnoddsallInf <- lm(log(oddsInfwins) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))))

lnoddsmiddle <- lm(log(oddswins) ~ history + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>3 & Period<10))
lnoddsbeginning <- lm(log(oddswins) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period<=3))
lnoddsend <- lm(log(oddswins) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom")) & Period>=10))
lnoddsall <- lm(log(oddswins) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent)  + market + Period0, data = subset(marketsummary, Programme==3 & ((regOrder == "NTop" & market == "Top") | (regOrder == "RTop" & market == "Bottom"))))

se_lnoddsmiddle <- coeftest(lnoddsmiddle, vcov. = vcovCL(lnoddsmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsmiddle <- coeftest(lnoddsmiddle, vcov. = vcovCL(lnoddsmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsbeginning <- coeftest(lnoddsbeginning, vcov. = vcovCL(lnoddsbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsbeginning <- coeftest(lnoddsbeginning, vcov. = vcovCL(lnoddsbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsend <- coeftest(lnoddsend, vcov. = vcovCL(lnoddsend, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsend <- coeftest(lnoddsend, vcov. = vcovCL(lnoddsend, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsall <- coeftest(lnoddsall, vcov. = vcovCL(lnoddsall, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsall <- coeftest(lnoddsall, vcov. = vcovCL(lnoddsall, cluster = ~ SessionID, type = "HC3"))[,4]


se_lnoddsmiddleUninf <- coeftest(lnoddsmiddleUninf, vcov. = vcovCL(lnoddsmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsmiddleUninf <- coeftest(lnoddsmiddleUninf, vcov. = vcovCL(lnoddsmiddleUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsbeginningUninf <- coeftest(lnoddsbeginningUninf, vcov. = vcovCL(lnoddsbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsbeginningUninf <- coeftest(lnoddsbeginningUninf, vcov. = vcovCL(lnoddsbeginningUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsendUninf <- coeftest(lnoddsendUninf, vcov. = vcovCL(lnoddsendUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsendUninf <- coeftest(lnoddsendUninf, vcov. = vcovCL(lnoddsendUninf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsallUninf <- coeftest(lnoddsallUninf, vcov. = vcovCL(lnoddsallUninf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsallUninf <- coeftest(lnoddsallUninf, vcov. = vcovCL(lnoddsallUninf, cluster = ~ SessionID, type = "HC3"))[,4]

se_lnoddsmiddleInf <- coeftest(lnoddsmiddleInf, vcov. = vcovCL(lnoddsmiddleInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsmiddleInf <- coeftest(lnoddsmiddleInf, vcov. = vcovCL(lnoddsmiddleInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsbeginningInf <- coeftest(lnoddsbeginningInf, vcov. = vcovCL(lnoddsbeginningInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsbeginningInf <- coeftest(lnoddsbeginningInf, vcov. = vcovCL(lnoddsbeginningInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsendInf <- coeftest(lnoddsendInf, vcov. = vcovCL(lnoddsendInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsendInf <- coeftest(lnoddsendInf, vcov. = vcovCL(lnoddsendInf, cluster = ~ SessionID, type = "HC3"))[,4]
se_lnoddsallInf <- coeftest(lnoddsallInf, vcov. = vcovCL(lnoddsallInf, cluster = ~ SessionID, type = "HC3"))[,2]
p_lnoddsallInf <- coeftest(lnoddsallInf, vcov. = vcovCL(lnoddsallInf, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(lnoddsbeginning, lnoddsmiddle, lnoddsend,lnoddsbeginningInf, lnoddsmiddleInf, lnoddsendInf, lnoddsbeginningUninf, lnoddsmiddleUninf, lnoddsendUninf), custom.note = ("\\parbox{1\\linewidth}{\\vspace{2pt}%stars. \\\\ One market per session and period is taken into account since the other corresponds to the negative complement. Markets considered had *NOREG* in Phase 2, i.e. top markets in Treatments .NR. and bottom markets in Treatmens .RN.}"),
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Regressions of winsorized geometric tradermigration (‘ln(odds)’) by trader type and phase.", custom.header = list('All traders' = 1:3, 'Informed trader' = 4:6, 'Uninformed trader' = 7:9),override.se=list(se_lnoddsbeginning, se_lnoddsmiddle, se_lnoddsend, se_lnoddsbeginningInf, se_lnoddsmiddleInf, se_lnoddsendInf, se_lnoddsbeginningUninf, se_lnoddsmiddleUninf, se_lnoddsendUninf), 
       override.p = list(p_lnoddsbeginning, p_lnoddsmiddle, p_lnoddsend, p_lnoddsbeginningInf, p_lnoddsmiddleInf, p_lnoddsendInf, p_lnoddsbeginningUninf, p_lnoddsmiddleUninf, p_lnoddsendUninf))
```

**************************************************************************************
\newpage

## Deviations 
\begin{equation}
\begin{split}
RD = & \frac{\sum Volume_i (Price_i-BBV)}{BBV\sum Volume_i} = \frac{\sum Volume_i Price_i}{BBV\sum Volume_i}-1\\
RAD = & \frac{\sum Volume_i |Price_i-BBV|}{BBV\sum Volume_i}\\
GD_{Market}
= & \exp\left(\frac{1}{Vol}\sum_{j=1}^{\#TRA_{m}} \ln\left(\frac{P_j}{BBV}\right)\cdot Vol_j\right)-1\\
GAD_{Market}
=  & \exp\left(\frac{1}{Vol}\sum_{j=1}^{\#TRA_{m}} \left\lvert \ln\left(\frac{P_j}{BBV}\right)\right\rvert\cdot Vol_j\right)-1\\
Efficiency_{Market}
=  & 1 - \exp\left(\frac{1}{Vol}\sum_{j=1}^{\#TRA_{m}} \left(\left\lvert \ln\left(\frac{P_j}{BBV}\right)\right\rvert - \left\lvert \ln\left(\frac{57.5}{BBV}\right)\right\rvert \right)\cdot Vol_j\right)
\end{split}
\end{equation}


```{r histogramRD, echo=FALSE ,fig.cap="Distribution of RD in Periods between the 4th and the 9th Period"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period<10 ,select= RD)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10), aes(RD, color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
 
```


```{r histogramRAD, echo=FALSE ,fig.cap="Distribution of RAD in Periods between the 4th and the 9th Period"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period<10 ,select= RAD)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10), aes(RAD, color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
 
```


```{r histogramGD, echo=FALSE ,fig.cap="Distribution of GD in Periods between the 4th and the 9th Period"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period<10 ,select= GD)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10), aes(GD, color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
 
```

```{r histogramGAD, echo=FALSE ,fig.cap="Distribution of GAD in Periods between the 4th and the 9th Period"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period<10 ,select= GAD)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10), aes(GAD, color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
  
```


```{r GDtable, echo=F, results = 'asis', warning=F}
### Table 4 ####
GDmiddle <- lm(GD ~ history + REGSH + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
GDbeginning <- lm(GD ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
GDend <- lm(GD ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10 ))

GDall <- lm(GD ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_GDmiddle <- coeftest(GDmiddle, vcov. = vcovCL(GDmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDmiddle <- coeftest(GDmiddle, vcov. = vcovCL(GDmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_GDbeginning <- coeftest(GDbeginning, vcov. = vcovCL(GDbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDbeginning <- coeftest(GDbeginning, vcov. = vcovCL(GDbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_GDend <- coeftest(GDend, vcov. = vcovCL(GDend, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDend <- coeftest(GDend, vcov. = vcovCL(GDend, cluster = ~ SessionID, type = "HC3"))[,4]
se_GDall <- coeftest(GDall, vcov. = vcovCL(GDall, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDall <- coeftest(GDall, vcov. = vcovCL(GDall, cluster = ~ SessionID, type = "HC3"))[,4]

GADmiddle <- lm(GAD ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
GADbeginning <- lm(GAD ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
GADend <- lm(GAD ~history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10 ))

GADall <- lm(GAD ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 ))

se_GADmiddle <- coeftest(GADmiddle, vcov. = vcovCL(GADmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADmiddle <- coeftest(GADmiddle, vcov. = vcovCL(GADmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_GADbeginning <- coeftest(GADbeginning, vcov. = vcovCL(GADbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADbeginning <- coeftest(GADbeginning, vcov. = vcovCL(GADbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_GADend <- coeftest(GADend, vcov. = vcovCL(GADend, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADend <- coeftest(GADend, vcov. = vcovCL(GADend, cluster = ~ SessionID, type = "HC3"))[,4]
se_GADall <- coeftest(GADall, vcov. = vcovCL(GADall, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADall <- coeftest(GADall, vcov. = vcovCL(GADall, cluster = ~ SessionID, type = "HC3"))[,4]

da <- 57.5+5.5
db <- 57.5-5.5
rGADmiddle <- lm(rGAD ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10 & (BBV <= db | BBV >= da)))
rGADbeginning <- lm(rGAD ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3 & (BBV <= db | BBV >= da)))
rGADend <- lm(rGAD ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10 & (BBV <= db | BBV >= da)))

rGADall <- lm(rGAD ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & (BBV <= db | BBV >= da)))

se_rGADmiddle <- coeftest(rGADmiddle, vcov. = vcovCL(rGADmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_rGADmiddle <- coeftest(rGADmiddle, vcov. = vcovCL(rGADmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_rGADbeginning <- coeftest(rGADbeginning, vcov. = vcovCL(rGADbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_rGADbeginning <- coeftest(rGADbeginning, vcov. = vcovCL(rGADbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_rGADend <- coeftest(rGADend, vcov. = vcovCL(rGADend, cluster = ~ SessionID, type = "HC3"))[,2]
p_rGADend <- coeftest(rGADend, vcov. = vcovCL(rGADend, cluster = ~ SessionID, type = "HC3"))[,4]
se_rGADall <- coeftest(rGADall, vcov. = vcovCL(rGADall, cluster = ~ SessionID, type = "HC3"))[,2]
p_rGADall <- coeftest(rGADall, vcov. = vcovCL(rGADall, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(GDbeginning, GDmiddle, GDend, GADbeginning, GADmiddle, GADend, rGADbeginning, rGADmiddle, rGADend), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3", "Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Regressions of measures for the informational efficiency of prices (‘GD’, ‘GAD’, and 'Efficiency') by phase (Table 4).", custom.header = list('GD' = 1:3, 'GAD' = 4:6, 'Efficiency' = 7:9),
       override.se=list(se_GDbeginning, se_GDmiddle,se_GDend, se_GADbeginning, se_GADmiddle,se_GADend, se_rGADbeginning, se_rGADmiddle, se_rGADend), 
       override.p=list(p_GDbeginning, p_GDmiddle,p_GDend, p_GADbeginning, p_GADmiddle,p_GADend, p_rGADbeginning, p_rGADmiddle, p_rGADend))
```

```{r GDtableshort, echo=F, results = 'asis', warning=F}
GDmiddleshort <- lm(GD ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                                log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                                log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                               data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
GDbeginningshort <- lm(GD ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                                    log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                                    log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                                  data = subset(marketsummary, Programme==3 & Period<=3))
GDendshort <- lm(GD ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                              log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                              log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                              data = subset(marketsummary, Programme==3 & Period>=10))
GDallshort <- lm(GD ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                    log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                              log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                            data = subset(marketsummary, Programme==3))

se_GDmiddleshort <- coeftest(GDmiddleshort, vcov. = vcovCL(GDmiddleshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDmiddleshort <- coeftest(GDmiddleshort, vcov. = vcovCL(GDmiddleshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_GDbeginningshort <- coeftest(GDbeginningshort, vcov. = vcovCL(GDbeginningshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDbeginningshort <- coeftest(GDbeginningshort, vcov. = vcovCL(GDbeginningshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_GDendshort <- coeftest(GDendshort, vcov. = vcovCL(GDendshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDendshort <- coeftest(GDendshort, vcov. = vcovCL(GDendshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_GDallshort <- coeftest(GDallshort, vcov. = vcovCL(GDallshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GDallshort <- coeftest(GDallshort, vcov. = vcovCL(GDallshort, cluster = ~ SessionID, type = "HC3"))[,4]


GADmiddleshort <- lm(GAD ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                               log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                               log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                             data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
GADbeginningshort <- lm(GAD ~   REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                                  log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                                  log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                                data = subset(marketsummary, Programme==3 & Period<=3))
GADendshort <- lm(GAD ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                            log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                            log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1),
                          data = subset(marketsummary, Programme==3 & Period>=10))
GADallshort <- lm(GAD ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                            log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                            log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                          data = subset(marketsummary, Programme==3))

se_GADmiddleshort <- coeftest(GADmiddleshort, vcov. = vcovCL(GADmiddleshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADmiddleshort <- coeftest(GADmiddleshort, vcov. = vcovCL(GADmiddleshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_GADbeginningshort <- coeftest(GADbeginningshort, vcov. = vcovCL(GADbeginningshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADbeginningshort <- coeftest(GADbeginningshort, vcov. = vcovCL(GADbeginningshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_GADendshort <- coeftest(GADendshort, vcov. = vcovCL(GADendshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADendshort <- coeftest(GADendshort, vcov. = vcovCL(GADendshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_GADallshort <- coeftest(GADallshort, vcov. = vcovCL(GADallshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_GADallshort <- coeftest(GADallshort, vcov. = vcovCL(GADallshort, cluster = ~ SessionID, type = "HC3"))[,4]


texreg(list(GDbeginning, GDbeginningshort, GDmiddle, GDmiddleshort, GDend, GDendshort, GADbeginning, GADbeginningshort, GADmiddle,GADmiddleshort,  GADend, GADendshort), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"),
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3", "Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3"),
       caption = "Regressions of measures for the informational efficiency of prices (‘GD’, ‘GAD’, adn 'Efficiency') by phase considering short selling activity.", custom.header = list('GD' = 1:3, 'GAD' = 4:6, 'Efficiency' = 7:9),
       custom.gof.rows = list("AIC" = c(round( AIC(GDbeginning), 2), round( AIC(GDbeginningshort), 2), round(AIC(GDmiddle), 2), round( AIC(GDmiddleshort), 2), round( AIC(GDend), 2), round( AIC(GDendshort), 2), round( AIC(GADbeginning), 2), round( AIC(GADbeginningshort), 2), round( AIC( GADmiddle), 2), round( AIC(GADmiddleshort), 2), round( AIC( GADend), 2), round( AIC(GADendshort), 2))),
       override.se=list(se_GDbeginning, se_GDbeginningshort, se_GDmiddle, se_GDmiddleshort, se_GDend, se_GDendshort, se_GADbeginning,se_GADbeginningshort, se_GADmiddle,se_GADmiddleshort, se_GADend, se_GADendshort), 
       override.p=list(p_GDbeginning, p_GDbeginningshort, p_GDmiddle, p_GDmiddleshort, p_GDend, p_GDendshort, p_GADbeginning,p_GADbeginningshort, p_GADmiddle,p_GADmiddleshort, p_GADend, p_GADendshort))
```

#### VIF of GD in Phase 1 considering short selling activity

```{r vifDev, echo = F}
vif(GDbeginningshort)
```

#### Mean GADA and Efficiency by phase and time range (Table 5). 

```{r tableEfficiency, echo = F}
### Table 5 ####
sGADfv <- aggregate(cbind(Volume, abs(log(57.5/BBV))*transactionVol) ~ SessionID + BBV + Period + market + IsREG, data = transactions, function(x) sum(x))

sGADfv$GADhyp <- exp(1/sGADfv$Volume*sGADfv$V2)-1
sGADfv <- merge(sGADfv, subset(marketsummary, select = c(GAD, SessionID, Period, market)), by = c("SessionID", "Period", "market"))
sGADfv$rGAD <- 1-sGADfv$GAD/sGADfv$GADhyp
#quantile(sGADfv$rGAD, probs = .3)
sGADfv$lnrGAD <- log(sGADfv$rGAD+1)
#ecdf(x = sGADfv$BBV)(57.5+8)-ecdf(sGADfv$BBV)(57.5-8)
da <- 57.5+5.5
db <- 57.5-5.5

sGADfv$dGAD <- sGADfv$GADhyp-sGADfv$GAD

trGAD <- t.test(rGAD ~ IsREG, data = subset(sGADfv, (BBV <= db | BBV >= da)), var.equal = T)
trGAD1 <- t.test(rGAD ~ IsREG, data = subset(sGADfv, Period > 0 & Period <=3 & (BBV <= db | BBV >= da)), var.equal = T)
trGAD2 <- t.test(rGAD ~ IsREG, data = subset(sGADfv, Period > 3 & Period < 10 & (BBV <= db | BBV >= da)), var.equal = T, paired = T)
trGAD2s <- t.test(rGAD ~ IsREG, data = subset(sGADfv, Period > 3 & Period < 10 & (BBV <= db | BBV >= da)), var.equal = T)
trGAD3 <- t.test(rGAD ~ IsREG, data = subset(sGADfv, Period >=10 & (BBV <= db | BBV >= da)), var.equal = T)
trGAD13 <- t.test(rGAD ~ IsREG, data = subset(sGADfv, (Period <= 3 | Period >= 10) & (BBV <= db | BBV >= da)), var.equal = T)

#t.test(dGAD ~ IsREG, data = subset(sGADfv, (Period <= 3 | Period >= 10)), var.equal = T)
#t.test(dGAD ~ IsREG, data = subset(sGADfv, Period > 3 & Period < 10), var.equal = T)
#t.test(dGAD ~ IsREG, data = subset(sGADfv), var.equal = T)

tGAD <- t.test(GAD ~ IsREG, data = subset(sGADfv), var.equal = T)
tGAD1 <- t.test(GAD ~ IsREG, data = subset(sGADfv, Period > 0 & Period <= 3), var.equal = T)
tGAD2 <- t.test(GAD ~ IsREG, data = subset(sGADfv, Period > 3 & Period < 10), var.equal = T, paired = T)
tGAD2s <- t.test(GAD ~ IsREG, data = subset(sGADfv, Period > 3 & Period < 10), var.equal = T)
tGAD3 <- t.test(GAD ~ IsREG, data = subset(sGADfv, Period >= 10), var.equal = T)
tGAD13 <- t.test(GAD ~ IsREG, data = subset(sGADfv, Period > 0 & (Period <= 3 | Period >= 10)), var.equal = T)

dat_GAD2 <- data.frame(c(tGAD$estimate, tGAD$p.value, trGAD$estimate, trGAD$p.value), c(tGAD1$estimate, tGAD1$p.value, trGAD1$estimate, trGAD1$p.value), c(tGAD2s$estimate, tGAD2$p.value, trGAD2s$estimate, trGAD2$p.value), c(tGAD3$estimate, tGAD3$p.value, trGAD3$estimate, trGAD3$p.value), c(tGAD13$estimate, tGAD13$p.value, trGAD13$estimate, trGAD13$p.value))
dat_GAD2 <- t(dat_GAD2)
colnames(dat_GAD2) <- c("NOREG", "REG", "pvalues_GADA", "NOREG", "REG", "pvalues_Efficiency")
row.names(dat_GAD2) <- c("all phases", "Phase 1", "Phase 2", "Phase 3", "Phase 1 & 3")

format(dat_GAD2, digits = 3, scientific = 5)

sGADfv120 <- aggregate(cbind(Volume, abs(log(57.5/BBV))*transactionVol) ~ SessionID + BBV + Period + market + IsREG, data = subset(transactions, Time >=120), function(x) sum(x))
sGADfv120 <- merge(sGADfv120,subset(sGADfv, select = c("SessionID", "BBV", "Period", "market", "IsREG")), by = c("SessionID", "BBV", "Period", "market", "IsREG"), all = T)
sGADfv120$Volume[is.na(sGADfv120$Volume)] <- 0
sGADfv120$V2[is.na(sGADfv120$V2)] <- 0
sGADfv120$GADhyp120 <- exp(1/sGADfv120$Volume*sGADfv120$V2)-1
sGADfv120$GADhyp120[is.na(sGADfv120$GADhyp120)] <- 57.5/sGADfv120$BBV[is.na(sGADfv120$GADhyp120)]-1
sGADfv120 <- merge(sGADfv120, subset(marketsummary, select = c(GAD120, SessionID, Period, market)), by = c("SessionID", "Period", "market"), all = T)
sGADfv120$GAD120[is.na(sGADfv120$GAD120)] <- 0
sGADfv120$rGAD120 <- 1-sGADfv120$GAD120/sGADfv120$GADhyp120
#quantile(sGADfv120$rGAD120, probs = .3)
sGADfv120$lnrGAD120 <- log(sGADfv120$rGAD120+1)
#ecdf(x = sGADfv120$BBV)(57.5+8)-ecdf(sGADfv120$BBV)(57.5-8)
da <- 57.5+5.5
db <- 57.5-5.5

sGADfv120$dGAD120 <- sGADfv120$GADhyp120-sGADfv120$GAD120

trGAD120 <- t.test(rGAD120 ~ IsREG, data = subset(sGADfv120, (BBV <= db | BBV >= da)), var.equal = T)
trGAD1201 <- t.test(rGAD120 ~ IsREG, data = subset(sGADfv120, Period <=3 & (BBV <= db | BBV >= da)), var.equal = T)
trGAD1202 <- t.test(rGAD120 ~ IsREG, data = subset(sGADfv120, Period > 3 & Period < 10 & (BBV <= db | BBV >= da)), var.equal = T, paired = T)
trGAD1202s <- t.test(rGAD120 ~ IsREG, data = subset(sGADfv120, Period > 3 & Period < 10 & (BBV <= db | BBV >= da)), var.equal = T)
trGAD1203 <- t.test(rGAD120 ~ IsREG, data = subset(sGADfv120, Period >=10 & (BBV <= db | BBV >= da)), var.equal = T)
trGAD12013 <- t.test(rGAD120 ~ IsREG, data = subset(sGADfv120, (Period <= 3 | Period >= 10) & (BBV <= db | BBV >= da)), var.equal = T)

#t.test(dGAD120 ~ IsREG, data = subset(sGADfv120, (Period <= 3 | Period >= 10)), var.equal = T)
#t.test(dGAD120 ~ IsREG, data = subset(sGADfv120, Period > 3 & Period < 10), var.equal = T)
#t.test(dGAD120 ~ IsREG, data = subset(sGADfv120), var.equal = T)

tGAD120 <- t.test(GAD120 ~ IsREG, data = subset(sGADfv120), var.equal = T)
tGAD1201 <- t.test(GAD120 ~ IsREG, data = subset(sGADfv120, Period <=3), var.equal = T)
tGAD1202 <- t.test(GAD120 ~ IsREG, data = subset(sGADfv120, Period > 3 & Period < 10), var.equal = T, paired = T)
tGAD1202s <- t.test(GAD120 ~ IsREG, data = subset(sGADfv120, Period > 3 & Period < 10), var.equal = T)
tGAD1203 <- t.test(GAD120 ~ IsREG, data = subset(sGADfv120, Period >=10), var.equal = T)
tGAD12013 <- t.test(GAD120 ~ IsREG, data = subset(sGADfv120, (Period <= 3 | Period >= 10)), var.equal = T)


dat_GAD3 <- data.frame( c(tGAD120$estimate, tGAD120$p.value, trGAD120$estimate, trGAD120$p.value), c(tGAD1201$estimate, tGAD1201$p.value, trGAD1201$estimate, trGAD1201$p.value), c(tGAD1202s$estimate, tGAD1202$p.value, trGAD1202s$estimate, trGAD1202$p.value), c(tGAD1203$estimate, tGAD1203$p.value, trGAD1203$estimate, trGAD1203$p.value), c(tGAD12013$estimate, tGAD12013$p.value, trGAD12013$estimate, trGAD12013$p.value))
dat_GAD3 <- t(dat_GAD3)
colnames(dat_GAD3) <- c("NOREG", "REG", "pvalues_GADA", "NOREG", "REG", "pvalues_Efficiency")
row.names(dat_GAD3) <- c("all phases", "Phase 1", "Phase 2", "Phase 3", "Phase 1 & 3")

print("Analysing the last 60sec")
format(dat_GAD3, digits = 3, scientific = 5)

```


**************************************************************************************
\newpage

## Bid-Ask spread 
\begin{equation}
\begin{split}
Spread_{Market}
=  & \frac{1}{\#S_{m}}\sum_{s=1}^{\#S_{m}} \left(Ask_s-Bid_s\right)\\
Volatility_{Market}
= & \sqrt{\frac{1}{\#TRA_{m}-1}\sum_{j=1}^{\#TRA_{m}}\left(RET_j - \overline{RET}\right)^2}
\end{split}
\end{equation}

The Bid-Ask spread is analysed via the per second observation of the Bid and Ask prices and four variables:

"BA-spread at the last second" describes the difference between the ask price and the bid price at the last second; therefore, for those markets where either one of the values was not given, there is no BA-spread.

"BA-spread in the last 30 seconds" describes the mean difference between the ask and bid for the last 30 seconds by second. Only those seconds are considered where there has contemporarily been an ask and bid price.

"Mean BA-spread" considers the whole timespan within a market and calculates the mean BA-spread by second.


```{r histogramBAspread, echo=FALSE ,fig.cap="Histogram of BA-spread in Periods between the 4th and the 9th Period"}
a <- subset(marketsummary, Programme==3 & Period>3 & Period<10 ,select= meanBAspread)
b<- max(density(a[is.na(a)!=T])$y)
ggplot(data=subset(marketsummary, Programme==3 & Period>3 & Period<10), aes(meanBAspread, color=IsREG, fill=IsREG)) +
  geom_density(aes(y=..density../b),alpha=0.1, position="identity", linetype = "dashed") +
  stat_ecdf() +  
  scale_y_continuous("Cumulative distribution", sec.axis = sec_axis(~.*b, name = "Density"))
  
```


```{r lmBAspreadtable, echo=F, results = 'asis'}
### Table 6 ####
BAspreadwins_middle <- lm(meanBAspreadwins2 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
BAspreadwins_beginning <- lm(meanBAspreadwins2 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
BAspreadwins_end <- lm(meanBAspreadwins2 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
BAspreadwins_all <- lm(meanBAspreadwins2 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_BAspreadwins_middle <- coeftest(BAspreadwins_middle, vcov. = vcovCL(BAspreadwins_middle, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_middle <- coeftest(BAspreadwins_middle, vcov. = vcovCL(BAspreadwins_middle, cluster = ~ SessionID, type = "HC3"))[,4]
se_BAspreadwins_beginning <- coeftest(BAspreadwins_beginning, vcov. = vcovCL(BAspreadwins_beginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_beginning <- coeftest(BAspreadwins_beginning, vcov. = vcovCL(BAspreadwins_beginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_BAspreadwins_end <- coeftest(BAspreadwins_end, vcov. = vcovCL(BAspreadwins_end, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_end <- coeftest(BAspreadwins_end, vcov. = vcovCL(BAspreadwins_end, cluster = ~ SessionID, type = "HC3"))[,4]
se_BAspreadwins_all <- coeftest(BAspreadwins_all, vcov. = vcovCL(BAspreadwins_all, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_all <- coeftest(BAspreadwins_all, vcov. = vcovCL(BAspreadwins_all, cluster = ~ SessionID, type = "HC3"))[,4]


volatility_middle <- lm(volatility ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
volatility_beginning <- lm(volatility ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
volatility_end <- lm(volatility ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
volatility_all <- lm(volatility ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_volatility_middle <- coeftest(volatility_middle, vcov. = vcovCL(volatility_middle, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_middle <- coeftest(volatility_middle, vcov. = vcovCL(volatility_middle, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatility_beginning <- coeftest(volatility_beginning, vcov. = vcovCL(volatility_beginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_beginning <- coeftest(volatility_beginning, vcov. = vcovCL(volatility_beginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatility_end <- coeftest(volatility_end, vcov. = vcovCL(volatility_end, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_end <- coeftest(volatility_end, vcov. = vcovCL(volatility_end, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatility_all <- coeftest(volatility_all, vcov. = vcovCL(volatility_all, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_all <- coeftest(volatility_all, vcov. = vcovCL(volatility_all, cluster = ~ SessionID, type = "HC3"))[,4]

volatilitywins_middle <- lm(volatilitywins2 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
volatilitywins_beginning <- lm(volatilitywins2 ~ + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
volatilitywins_end <- lm(volatilitywins2 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
volatilitywins_all <- lm(volatilitywins2 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_volatilitywins_middle <- coeftest(volatilitywins_middle, vcov. = vcovCL(volatilitywins_middle, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_middle <- coeftest(volatilitywins_middle, vcov. = vcovCL(volatilitywins_middle, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatilitywins_beginning <- coeftest(volatilitywins_beginning, vcov. = vcovCL(volatilitywins_beginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_beginning <- coeftest(volatilitywins_beginning, vcov. = vcovCL(volatilitywins_beginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatilitywins_end <- coeftest(volatilitywins_end, vcov. = vcovCL(volatilitywins_end, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_end <- coeftest(volatilitywins_end, vcov. = vcovCL(volatilitywins_end, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatilitywins_all <- coeftest(volatilitywins_all, vcov. = vcovCL(volatilitywins_all, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_all <- coeftest(volatilitywins_all, vcov. = vcovCL(volatilitywins_all, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(BAspreadwins_beginning, BAspreadwins_middle, BAspreadwins_end, volatility_beginning, volatility_middle, volatility_end), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3", "Phase 1", "Phase 2", "Phase 3"),
        custom.header = list('Spread' = 1:3, 'Volatility' = 4:6),
       caption = "Regressions of ‘Spread’ and ‘Volatility’ by phase (Table 6).", override.se=list(se_BAspreadwins_beginning, se_BAspreadwins_middle, se_BAspreadwins_end, se_volatility_beginning, se_volatility_middle, se_volatility_end), 
       override.p = list(p_BAspreadwins_beginning, p_BAspreadwins_middle, p_BAspreadwins_end, p_volatility_beginning, p_volatility_middle, p_volatility_end))

## wins
texreg(list(BAspreadwins_beginning, BAspreadwins_middle, BAspreadwins_end, volatilitywins_beginning, volatilitywins_middle, volatilitywins_end), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3", "Phase 1", "Phase 2", "Phase 3"),
        custom.header = list('Spread' = 1:3, 'Volatility' = 4:6),
       caption = "Regressions of ‘Spread ’ and winsorized ‘Volatility’ by phase.", override.se=list(se_BAspreadwins_beginning, se_BAspreadwins_middle, se_BAspreadwins_end, se_volatilitywins_beginning, se_volatilitywins_middle, se_volatilitywins_end), 
       override.p = list(p_BAspreadwins_beginning, p_BAspreadwins_middle, p_BAspreadwins_end, p_volatilitywins_beginning, p_volatilitywins_middle, p_volatilitywins_end))

```

```{r lmBAspreadtableshort, echo=F, results = 'asis'}
BAspreadwins_middleshort <- lm(meanBAspreadwins2 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                                #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                                log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                               data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
BAspreadwins_beginningshort <- lm(meanBAspreadwins2 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                                    #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                                    log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                                  data = subset(marketsummary, Programme==3 & Period<=3))
BAspreadwins_endshort <- lm(meanBAspreadwins2 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                              #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                              log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                              data = subset(marketsummary, Programme==3 & Period>=10))
BAspreadwins_allshort <- lm(meanBAspreadwins2 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0 + #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                              log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                            data = subset(marketsummary, Programme==3))

se_BAspreadwins_middleshort <- coeftest(BAspreadwins_middleshort, vcov. = vcovCL(BAspreadwins_middleshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_middleshort <- coeftest(BAspreadwins_middleshort, vcov. = vcovCL(BAspreadwins_middleshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_BAspreadwins_beginningshort <- coeftest(BAspreadwins_beginningshort, vcov. = vcovCL(BAspreadwins_beginningshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_beginningshort <- coeftest(BAspreadwins_beginningshort, vcov. = vcovCL(BAspreadwins_beginningshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_BAspreadwins_endshort <- coeftest(BAspreadwins_endshort, vcov. = vcovCL(BAspreadwins_endshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_endshort <- coeftest(BAspreadwins_endshort, vcov. = vcovCL(BAspreadwins_endshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_BAspreadwins_allshort <- coeftest(BAspreadwins_allshort, vcov. = vcovCL(BAspreadwins_allshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_BAspreadwins_allshort <- coeftest(BAspreadwins_allshort, vcov. = vcovCL(BAspreadwins_allshort, cluster = ~ SessionID, type = "HC3"))[,4]


volatility_middleshort <- lm(volatility ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                               #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                               log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                             data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
volatility_beginningshort <- lm(volatility ~   REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                                  #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                                  log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                                data = subset(marketsummary, Programme==3 & Period<=3))
volatility_endshort <- lm(volatility ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + 
                            #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                            log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1),
                          data = subset(marketsummary, Programme==3 & Period>=10))
volatility_allshort <- lm(volatility ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0 + 
                            #log(VolumeInf - marginbuysAsset_Informed - shortsells_Informed + 1) + log(VolumeUni - marginbuysAsset_Uninformed - shortsells_Uninformed + 1) + 
                            log(shortsells_Informed + 1) + log(marginbuysAsset_Informed + 1) + log(shortsells_Uninformed + 1) + log(marginbuysAsset_Uninformed + 1), 
                          data = subset(marketsummary, Programme==3))

se_volatility_middleshort <- coeftest(volatility_middleshort, vcov. = vcovCL(volatility_middleshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_middleshort <- coeftest(volatility_middleshort, vcov. = vcovCL(volatility_middleshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatility_beginningshort <- coeftest(volatility_beginningshort, vcov. = vcovCL(volatility_beginningshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_beginningshort <- coeftest(volatility_beginningshort, vcov. = vcovCL(volatility_beginningshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatility_endshort <- coeftest(volatility_endshort, vcov. = vcovCL(volatility_endshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_endshort <- coeftest(volatility_endshort, vcov. = vcovCL(volatility_endshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatility_allshort <- coeftest(volatility_allshort, vcov. = vcovCL(volatility_allshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatility_allshort <- coeftest(volatility_allshort, vcov. = vcovCL(volatility_allshort, cluster = ~ SessionID, type = "HC3"))[,4]

volatilitywins_middleshort <- lm(volatilitywins2 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0 + log(shortsells + 1) + log(marginbuysAsset + 1) + log(Volume - marginbuysAsset - shortsells + 1), data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
volatilitywins_beginningshort <- lm(volatilitywins2 ~ + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + log(shortsells + 1) + log(marginbuysAsset + 1) + log(Volume - marginbuysAsset - shortsells + 1), data = subset(marketsummary, Programme==3 & Period<=3))
volatilitywins_endshort <- lm(volatilitywins2 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0 + log(shortsells + 1) + log(marginbuysAsset + 1) + log(Volume - marginbuysAsset - shortsells + 1), data = subset(marketsummary, Programme==3 & Period>=10))
volatilitywins_allshort <- lm(volatilitywins2 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0 + log(shortsells + 1) + log(marginbuysAsset + 1) + log(Volume - marginbuysAsset - shortsells + 1), data = subset(marketsummary, Programme==3))

se_volatilitywins_middleshort <- coeftest(volatilitywins_middleshort, vcov. = vcovCL(volatilitywins_middleshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_middleshort <- coeftest(volatilitywins_middleshort, vcov. = vcovCL(volatilitywins_middleshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatilitywins_beginningshort <- coeftest(volatilitywins_beginningshort, vcov. = vcovCL(volatilitywins_beginningshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_beginningshort <- coeftest(volatilitywins_beginningshort, vcov. = vcovCL(volatilitywins_beginningshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatilitywins_endshort <- coeftest(volatilitywins_endshort, vcov. = vcovCL(volatilitywins_endshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_endshort <- coeftest(volatilitywins_endshort, vcov. = vcovCL(volatilitywins_endshort, cluster = ~ SessionID, type = "HC3"))[,4]
se_volatilitywins_allshort <- coeftest(volatilitywins_allshort, vcov. = vcovCL(volatilitywins_allshort, cluster = ~ SessionID, type = "HC3"))[,2]
p_volatilitywins_allshort <- coeftest(volatilitywins_allshort, vcov. = vcovCL(volatilitywins_allshort, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(BAspreadwins_beginning, BAspreadwins_beginningshort, BAspreadwins_middle, BAspreadwins_middleshort, BAspreadwins_end, BAspreadwins_endshort, volatility_beginning,volatility_beginningshort, volatility_middle,volatility_middleshort, volatility_end,  volatility_endshort), 
       #custom.coef.names = c(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA, "log(remainingVolInf + 1)", "log(remainingVolUni + 1)",NA,NA,NA,NA,NA), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)",
        custom.header = list('Spread' = 1:6, 'Volatility' = 7:12),
       caption = "Regressions of ‘Spread ’ and ‘Volatility’ by phase considering short selling activity.", custom.model.names = c("Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3", "Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3"),
       custom.gof.rows = list("AIC" = c(round( AIC(BAspreadwins_beginning), 2), round( AIC(BAspreadwins_beginningshort), 2), round(AIC(BAspreadwins_middle), 2), round( AIC(BAspreadwins_middleshort), 2), round( AIC(BAspreadwins_end), 2), round( AIC(BAspreadwins_endshort), 2), round( AIC(volatility_beginning), 2), round( AIC(volatility_beginningshort), 2), round( AIC( volatility_middle), 2), round( AIC(volatility_middleshort), 2), round( AIC( volatility_end), 2), round( AIC(volatility_endshort), 2))),
       override.se=list(se_BAspreadwins_beginning, se_BAspreadwins_beginningshort, se_BAspreadwins_middle, se_BAspreadwins_middleshort, se_BAspreadwins_end, se_BAspreadwins_endshort, se_volatility_beginning,se_volatility_beginningshort, se_volatility_middle,se_volatility_middleshort, se_volatility_end, se_volatility_endshort), 
       override.p=list(p_BAspreadwins_beginning, p_BAspreadwins_beginningshort, p_BAspreadwins_middle, p_BAspreadwins_middleshort, p_BAspreadwins_end, p_BAspreadwins_endshort, p_volatility_beginning,p_volatility_beginningshort, p_volatility_middle,p_volatility_middleshort, p_volatility_end, p_volatility_endshort))

```

```{r bagraph2, echo=F, fig.cap = "GAM-smoothed development of predicted ‘Spread’ over time (Figure 4)."}
### Figure 4 ####
seconds$SessionID2 <- as.factor(seconds$SessionID)

data <- subset(seconds, Programme==3)
fbam3 <- gam(BAspreadwins2 ~ 0 + s(time, k = 20, by = interaction(REGBoth, REGSH, (Period>3 & Period<10))) + BBVCent + abs(BBVCent) + history + REGSH + REGBoth + market + Period0 + s(SessionID2, bs = 're'), data = data)
p.bash2 <- visreg(fbam3, type = "conditional", scale='response', xvar="time", line.par = list(col = 'red'), cond = list(SessionID2=1, REGBoth=1, Period = 3), plot=FALSE)
p.bansh2 <- visreg(fbam3, type = "conditional", scale='response', xvar="time", line.par = list(col = 'red'), cond = list(SessionID2=1, REGBoth=0, Period = 3), plot=FALSE)
dplyr::bind_rows(
  dplyr::mutate(p.bash2$fit, group = "REG"),
  dplyr::mutate(p.bansh2$fit, group = "NOREG")
)-> fitbash2

#postscript("Figures/GraphBAspread1.eps")
ggplot(data = fitbash2) +
  geom_ribbon(aes(time, ymin=visregLwr, ymax=visregUpr, group=group), fill="gray90") +
  geom_line(aes(time, visregFit, group=group, color=group)) +
  theme_bw() +
  scale_x_continuous(limits = c(-5,185),breaks=c(0,30,60,90,120,150,180)) +
  labs(colour = " ") + ylab("Spread") + xlab('Time(s)') + ylim(0,NA) +
  scale_color_manual( values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
  theme(text = element_text(size = 18), axis.text.y.right = element_text(color = "darkgrey"), axis.title.y.right = element_text(color = "darkgrey"), legend.position = "bottom")
#dev.off()
```

*****************************************************************
\newpage

## Trading Profits

\begin{align}
    PD^{Before}=\cdot\frac{\sum\limits_{j}\theta_j\cdot\left(P_j-BBV\right)\cdot Vol_j}{W_{t=0}},
\end{align}

\begin{align}
    PD^{After\,redistribution}=PD^{Before}+\cdot\frac{Redist}{W_{t=0}},
\end{align}

\begin{align}
    PD^{After\, punishment}=PD^{After\,redistribution}-\cdot\frac{Pen}{W_{t=0}},
\end{align}

```{r TP graph, echo=FALSE ,fig.cap="Mean gross trading profits per trader (‘PD’) by regulatory regime, trader type, and phase (Figure 5).", warning=F}
### Figure 5 ####
# Data for Table WA9 ##
tPDbeforeInf <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeUni <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbefore1Inf <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbefore1Uni <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbefore2Inf <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDbefore2Uni <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDbefore3Inf <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbefore3Uni <- format(round(t.test(PDbefore ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunInf <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunUni <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPun1Inf <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPun1Uni <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPun2Inf <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDPun2Uni <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDPun3Inf <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPun3Uni <- format(round(t.test(PDPun ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

ePDbeforeInf <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbeforeUni <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbefore1Inf <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbefore1Uni <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbefore2Inf <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDbefore2Uni <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDbefore3Inf <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbefore3Uni <- format(round(t.test(PDbefore*100 ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunInf <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunUni <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPun1Inf <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPun1Uni <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPun2Inf <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDPun2Uni <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDPun3Inf <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPun3Uni <- format(round(t.test(PDPun*100 ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)

datPD_text <- data.frame(
  label = c(paste0("p = ",tPDbefore1Inf,"0"), paste0("p = ",tPDbefore1Uni,""), paste0("p = ",tPDbefore2Inf,""), paste0("p = ",tPDbefore2Uni,""), paste0("p = ",tPDbefore3Inf,"0"),paste0("p = ",tPDbefore3Uni,""),paste0("p = ",tPDPun1Inf,""),paste0("p = ",tPDPun1Uni,""),paste0("p = ",tPDPun2Inf,".0000"),paste0("p = ",tPDPun2Uni,""),paste0("p = ",tPDPun3Inf,""),paste0("p = ",tPDPun3Uni,"")),
  IsREG = c("REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG"),
  Role = c("Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders"),
  Phase = c("Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3", "Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3"),
  group = c("PDbefore","PDbefore","PDbefore", "PDbefore", "PDbefore", "PDbefore", "REG.PDPun", "REG.PDPun", "REG.PDPun","REG.PDPun","REG.PDPun","REG.PDPun"),
  Variable = c("PDbefore","PDbefore","PDbefore", "PDbefore", "PDbefore", "PDbefore", "PDPun", "PDPun", "PDPun","PDPun","PDPun","PDPun"),
  vjust = c(0,0,0,0,0,0,.003,.003,.003,.003,.003,.003)
)

avgtraderphasesummary2$group <- interaction(avgtraderphasesummary2$IsREG, avgtraderphasesummary2$variable)
avgtraderphasesummary2$group <- factor(avgtraderphasesummary2$group, levels = c("NOREG.PDbefore", "REG.PDbefore", "REG.PDPun", "NOREG.PDbeforeVol", "REG.PDbeforeVol", "REG.PDPunVol"))
avgtraderphasesummary2$group2 <- interaction(avgtraderphasesummary2$IsREG, avgtraderphasesummary2$Variable)
avgtraderphasesummary2$group2 <- factor(avgtraderphasesummary2$group2, levels = c("NOREG.PDbeforePos", "REG.PDbeforePos", "REG.PDPunPos"))

#postscript("Figures/GraphPDPhaseallTreat.eps")
ggplot(data=subset(avgtraderphasesummary2, variable == "PDbefore" | ( IsREG != "NOREG" & variable =="PDPun")), aes(y= value*100, x= Role, group = group, fill = group, color = group)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.7), size = 2)+ 
  labs(y="") +
  geom_text(data = subset(datPD_text[1:6,]), mapping = aes(x = Role, y = 5.5 - vjust, label = label), col = "black", size = 4) +
  geom_text(data = subset(datPD_text[7:12,]), mapping = aes(x = Role, y = 5.5 - vjust*100, label = label), col = "orange", size = 4) +
  geom_errorbar(aes(ymin = dol*100, ymax = upl*100), width=.2, color = 'black', size = .7, position=position_dodge(width=0.7)) +
  theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(. ~ Phase, scales = "free") +
  scale_color_manual(name = "Regime - Punishment", values = c("REG.PDbefore" = "transparent", "NOREG.PDbefore" = "transparent", "REG.PDPun" = "orange"), breaks = c("NOREG.PDbefore", "REG.PDbefore", "REG.PDPun"), labels = c("NOREG", "REG - before punishment", "REG - after punishment")) +
  scale_fill_manual(name = "Regime - Punishment", values = c("NOREG.PDbefore" = rgb(.46, .76, .88), "REG.PDPun" = rgb(0,.29,.51), "REG.PDbefore" = rgb(0,.29,.51)), breaks = c("NOREG.PDbefore", "REG.PDbefore", "REG.PDPun"), labels = c("NOREG", "REG - before punishment", "REG - after punishment"))
#dev.off()

```


```{r avgPDbeforerankgraph, echo=FALSE ,fig.cap="Mean trading profits including compensations over time by regulation", warning=F}
ggplot(data=subset(subjectsummary), aes(x = PDbefore*100, group = IsREG, fill = IsREG)) +
    geom_histogram(binwidth = 5, position = position_dodge(width = 3))+ 
    #geom_density() +
    xlim(-50,50) +
    labs(y="") +
    theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
    scale_fill_manual(name = "Regime - Punishment", values = c("NOREG" = rgb(.46, .76, .88), "REG" = rgb(0,.29,.51))) +
    facet_grid(Role ~ Phase, scales = "free")
#dev.off()

```

```{r histrank, echo = FALSE, fig.cap="Mean gross trading profits per trader (‘PD’) by trader type, phase, and profit rank."}
### Figure 6 ####
avgtraderphasesummaryRank <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset) ~ Role + ceiling(rankavgPDbeforeRole/2) + Phase + IsREG, data=subjectsummary, function(x) mean(x))
colnames(avgtraderphasesummaryRank)[colnames(avgtraderphasesummaryRank) == "V7"] <- "PR"
colnames(avgtraderphasesummaryRank)[2] <- "rank"
avgtraderphasesummaryRank2 <- reshape2::melt(subset(avgtraderphasesummaryRank), id.vars = c("Phase", "IsREG", "Role", "rank"))
avgtraderphasesummaryRankul <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset) ~ Role + ceiling(rankavgPDbeforeRole/2) + Phase + IsREG, data=subjectsummary, function(x) quantile(x, probs = 0.975))
colnames(avgtraderphasesummaryRankul) <- c("Role", "rank", "Phase","IsREG", "ulVolume", "ulLimitVolume", "ulTradingProfit", "ulTPUnits", "ulTPUnitsPun", "ulProfitPeriod", "ulPR", "ulPDbefore", "ulPDPun", "ulPDRedist", "ulPDbeforeVol", "ulPDPunVol", "ulPDRedistVol", "ulV14", "ulV15", "ulV16", "ulV17", "ulV18", "ulV19", "ulshortsells", "ulmarginbuys", "ulmarginbuysAsset")
avgtraderphasesummaryRankll <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset) ~ Role + ceiling(rankavgPDbeforeRole/2) + Phase + IsREG, data=subjectsummary, function(x) quantile(x, probs = 0.025))
colnames(avgtraderphasesummaryRankll) <- c("Role", "rank", "Phase","IsREG", "llVolume", "llLimitVolume", "llTradingProfit", "llTPUnits", "llTPUnitsPun", "llProfitPeriod", "llPR", "llPDbefore", "llPDPun", "llPDRedist", "llPDbeforeVol", "llPDPunVol", "llPDRedistVol", "llV14", "llV15", "llV16", "llV17", "llV18", "llV19", "llshortsells", "llmarginbuys", "llmarginbuysAsset")
avgtraderphasesummaryRanksd <- aggregate(cbind(Volume, LimitVolume, TradingProfit, TPUnits, TPUnitsPun, ProfitPeriod, (Volume > 0 | LimitVolume > 0), PDbefore, PDPun, PDRedist, PDbeforeVol, PDPunVol, PDRedistVol, PDbefore*as.numeric(PDbefore>0), PDPun*as.numeric(PDPun>0), PDRedist*as.numeric(PDRedist>0), PDbefore*as.numeric(PDbefore<0), PDPun*as.numeric(PDPun<0), PDRedist*as.numeric(PDRedist<0), shortsells, marginbuys, marginbuysAsset) ~ Role + ceiling(rankavgPDbeforeRole/2) + Phase + IsREG, data=subjectsummary, function(x) sd(x))
colnames(avgtraderphasesummaryRanksd)[colnames(avgtraderphasesummaryRanksd) == "V7"] <- "PR"
colnames(avgtraderphasesummaryRanksd)[2] <- "rank"
avgtraderphasesummaryRank2sd <- reshape2::melt(subset(avgtraderphasesummaryRanksd), id.vars = c("Phase", "IsREG", "Role", "rank"))
colnames(avgtraderphasesummaryRank2sd)[colnames(avgtraderphasesummaryRank2sd) == "value"] <- "sd"
colnames(avgtraderphasesummaryRanksd) <- c("Role", "rank", "Phase","IsREG", "sdVolume", "sdLimitVolume", "sdTradingProfit", "sdTPUnits", "sdTPUnitsPun", "sdProfitPeriod", "sdPR", "sdPDbefore", "sdPDPun", "sdPDRedist", "sdPDbeforeVol", "sdPDPunVol", "sdPDRedistVol", "sdV14", "sdV15", "sdV16", "sdV17", "sdV18", "sdV19", "sdshortsells", "sdmarginbuys", "sdmarginbuysAsset")
avgtraderphasesummaryRankn <- aggregate(Volume ~ Role + ceiling(rankavgPDbeforeRole/2) + Phase + IsREG, data=subjectsummary, function(x) length(x))
colnames(avgtraderphasesummaryRankn) <- c("Role", "rank", "Phase","IsREG", "n")
avgtraderphasesummaryRank <- merge(avgtraderphasesummaryRank, avgtraderphasesummaryRankn, by = c("Role" ,"Phase","IsREG", "rank"))
avgtraderphasesummaryRank <- merge(avgtraderphasesummaryRank, avgtraderphasesummaryRankul, by = c("Role", "Phase","IsREG", "rank"))
avgtraderphasesummaryRank <- merge(avgtraderphasesummaryRank, avgtraderphasesummaryRankll, by = c("Role", "Phase","IsREG", "rank"))
avgtraderphasesummaryRank <- merge(avgtraderphasesummaryRank, avgtraderphasesummaryRanksd, by = c("Role", "Phase","IsREG", "rank"))
avgtraderphasesummaryRank$uplVolume <- avgtraderphasesummaryRank$Volume+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdVolume/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolVolume <- avgtraderphasesummaryRank$Volume+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdVolume/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplLimitVolume <- avgtraderphasesummaryRank$LimitVolume+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdLimitVolume/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolLimitVolume <- avgtraderphasesummaryRank$LimitVolume+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdLimitVolume/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplTradingProfit <- avgtraderphasesummaryRank$TradingProfit+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdTradingProfit/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolTradingProfit <- avgtraderphasesummaryRank$TradingProfit+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdTradingProfit/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplTPUnits <- avgtraderphasesummaryRank$TPUnits+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdTPUnits/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolTPUnits <- avgtraderphasesummaryRank$TPUnits+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdTPUnits/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplTPUnitsPun <- avgtraderphasesummaryRank$TPUnitsPun+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdTPUnitsPun/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolTPUnitsPun <- avgtraderphasesummaryRank$TPUnitsPun+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdTPUnitsPun/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplProfitPeriod <- avgtraderphasesummaryRank$ProfitPeriod+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdProfitPeriod/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolProfitPeriod <- avgtraderphasesummaryRank$ProfitPeriod+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdProfitPeriod/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPR <- avgtraderphasesummaryRank$PR+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPR/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPR <- avgtraderphasesummaryRank$PR+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPR/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPDbefore <- avgtraderphasesummaryRank$PDbefore+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDbefore/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPDbefore <- avgtraderphasesummaryRank$PDbefore+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDbefore/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPDPun <- avgtraderphasesummaryRank$PDPun+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDPun/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPDPun <- avgtraderphasesummaryRank$PDPun+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDPun/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPDRedist <- avgtraderphasesummaryRank$PDRedist+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDRedist/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPDRedist <- avgtraderphasesummaryRank$PDRedist+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDRedist/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPDbeforeVol <- avgtraderphasesummaryRank$PDbeforeVol+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDbeforeVol/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPDbeforeVol <- avgtraderphasesummaryRank$PDbeforeVol+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDbeforeVol/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPDPunVol <- avgtraderphasesummaryRank$PDPunVol+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDPunVol/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPDPunVol <- avgtraderphasesummaryRank$PDPunVol+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDPunVol/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplPDRedistVol <- avgtraderphasesummaryRank$PDRedistVol+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDRedistVol/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolPDRedistVol <- avgtraderphasesummaryRank$PDRedistVol+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdPDRedistVol/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplshortsells <- avgtraderphasesummaryRank$shortsells+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdshortsells/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolshortsells <- avgtraderphasesummaryRank$shortsells+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdshortsells/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplmarginbuys <- avgtraderphasesummaryRank$marginbuys+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdmarginbuys/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolmarginbuys <- avgtraderphasesummaryRank$marginbuys+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdmarginbuys/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$uplmarginbuysAsset <- avgtraderphasesummaryRank$marginbuysAsset+qt(.975,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdmarginbuysAsset/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$dolmarginbuysAsset <- avgtraderphasesummaryRank$marginbuysAsset+qt(.025,avgtraderphasesummaryRank$n-1)*avgtraderphasesummaryRank$sdmarginbuysAsset/sqrt(avgtraderphasesummaryRank$n)
avgtraderphasesummaryRank$Phase <- factor(avgtraderphasesummaryRank$Phase, levels = c("Phase 1", "Phase 2", "Phase 3"))
avgtraderphasesummaryRank$maxV <- max(avgtraderphasesummaryRank$uplVolume)
avgtraderphasesummaryRank$Role <- factor(avgtraderphasesummaryRank$Role, labels = c("Informed\ntraders","Uninformed\ntraders"))
avgtraderphasesummaryRank$Role <- ordered(avgtraderphasesummaryRank$Role, levels = c("Informed\ntraders","Uninformed\ntraders"))

avgtraderphasesummaryRank2 <- merge(avgtraderphasesummaryRank2, avgtraderphasesummaryRank2sd, by = c("Role", "rank", "Phase","IsREG", "variable"))
avgtraderphasesummaryRank2 <- merge(avgtraderphasesummaryRank2, avgtraderphasesummaryRankn, by = c("Role", "rank", "Phase","IsREG"))
avgtraderphasesummaryRank2$upl <- avgtraderphasesummaryRank2$value+qt(.975,avgtraderphasesummaryRank2$n-1)*avgtraderphasesummaryRank2$sd/sqrt(avgtraderphasesummaryRank2$n)
avgtraderphasesummaryRank2$dol <- avgtraderphasesummaryRank2$value+qt(.025,avgtraderphasesummaryRank2$n-1)*avgtraderphasesummaryRank2$sd/sqrt(avgtraderphasesummaryRank2$n)
avgtraderphasesummaryRank2$Phase <- factor(avgtraderphasesummaryRank2$Phase, levels = c("Phase 1", "Phase 2", "Phase 3"))
avgtraderphasesummaryRank2$Role <- factor(avgtraderphasesummaryRank2$Role, labels = c("Informed\ntraders","Uninformed\ntraders"))
avgtraderphasesummaryRank2$Role <- ordered(avgtraderphasesummaryRank2$Role, levels = c("Informed\ntraders","Uninformed\ntraders"))
avgtraderphasesummaryRank2$Variable <- as.character(avgtraderphasesummaryRank2$variable)
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "LimitVolume"] <- "Limit volume"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "Volume"] <- "Traders' mean trading volume"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PR"] <- "Participation rate"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "shortsells"] <- "Short sells"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "marginbuysAsset"] <- "Margin buys"

avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PDbefore"] <- "Trading profig before redistribution"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PDredist"] <- "Trading profig after redistribution"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PDPun"] <- "Trading profig after punishment"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PDbeforeVol"] <- "Trading profig before redistribution per transacted asset"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PDredistVol"] <- "Trading profig after redistribution per transacted asset"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "PDPunVol"] <- "Trading profig after punishment per transacted asset"

avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "V14"] <- "PDbeforePos"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "V17"] <- "PDbeforePos"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "V15"] <- "PDPunPos"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "V18"] <- "PDPunPos"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "V16"] <- "PDRedisPos"
avgtraderphasesummaryRank2$Variable[avgtraderphasesummaryRank2$variable == "V19"] <- "PDRedisPos"

avgtraderphasesummaryRank2$group <- interaction(avgtraderphasesummaryRank2$IsREG, avgtraderphasesummaryRank2$variable)
avgtraderphasesummaryRank2$group <- factor(avgtraderphasesummaryRank2$group, levels = c("NOREG.PDbefore", "REG.PDbefore", "REG.PDPun", "NOREG.PDbeforeVol", "REG.PDbeforeVol", "REG.PDPunVol"))
avgtraderphasesummaryRank2$group2 <- interaction(avgtraderphasesummaryRank2$IsREG, avgtraderphasesummaryRank2$Variable)
avgtraderphasesummaryRank2$group2 <- factor(avgtraderphasesummaryRank2$group2, levels = c("NOREG.PDbeforePos", "REG.PDbeforePos", "REG.PDPunPos"))
avgtraderphasesummaryRank2$rank2 <- factor(avgtraderphasesummaryRank2$rank, labels = c("1|2", "3|4", "5|6", "7|8", "9|10", "11|12", "13|14"))

#postscript("Figures/GraphPDPhaseallTreatRank.eps")
ggplot(data=subset(avgtraderphasesummaryRank2, variable == "PDbefore" | ( IsREG != "NOREG" & variable =="PDPun")), aes(y= value*100, x= rank2, group = group, fill = group, color = group)) +
    geom_bar(stat="identity", position = position_dodge(width = 0.7), size = 2)+ 
    labs(y="") +
    #geom_text(data = subset(datPD_text[1:6,]), mapping = aes(x = Role3, y = -6 - vjust, label = label), col = "black", size = 4) +
    #geom_text(data = subset(datPD_text[13:18,]), mapping = aes(x = Role3, y = -6 - vjust, label = label), col = "black", size = 4) +
    #geom_text(data = subset(datPD_text[7:12,]), mapping = aes(x = Role3, y = -6 - vjust*200, label = label), col = "orange", size = 4) +
    #geom_text(data = subset(datPD_text[19:24,]), mapping = aes(x = Role3, y = -6 - vjust*200, label = label), col = "orange", size = 4) +
    geom_errorbar(aes(ymin = dol*100, ymax = upl*100), width=.2, color = 'black', size = .7, position=position_dodge(width=0.7)) +
    theme(text = element_text(size=18),axis.title.x=element_blank(), axis.text.x = element_text(size=12), legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
    facet_grid(Role ~ Phase, scales = "free") +
    scale_color_manual(name = "Regime - Punishment", values = c("REG.PDbefore" = "transparent", "NOREG.PDbefore" = "transparent", "REG.PDPun" = "orange"), breaks = c("NOREG.PDbefore", "REG.PDbefore", "REG.PDPun"), labels = c("NOREG", "REG - before punishment", "REG - after punishment")) +
    scale_fill_manual(name = "Regime - Punishment", values = c("NOREG.PDbefore" = rgb(.46, .76, .88), "REG.PDPun" = rgb(0,.29,.51), "REG.PDbefore" = rgb(0,.29,.51)), breaks = c("NOREG.PDbefore", "REG.PDbefore", "REG.PDPun"), labels = c("NOREG", "REG - before punishment", "REG - after punishment"))
#dev.off()

countPDbefore <- aggregate(cbind(PDbefore > 0, PDbefore == 0, PDbefore < 0, 1) ~ subjectID + Role + AvgPDbeforeRole, subset(subjectsummary), function(x) sum(x))
countPDbefore <- cbind(countPDbefore, with(cbind(V1, V2, V3)/V4, data = countPDbefore))
colnames(countPDbefore) <- c("subjectID", "Role", "AvgPDbeforeRole", "positive", "neutral", "negative", "n", "relpositive", "relneutral", "relnegative")

table <- aggregate(cbind(1, positive > 0,positive == 0, neutral == 0, negative == 0, neutral == 0 & negative == 0 & positive > 0, neutral == 0 & negative > 0 & positive == 0, AvgPDbeforeRole > 0, AvgPDbeforeRole == 0, AvgPDbeforeRole < 0) ~ Role ,countPDbefore, function(x) sum(x))
colnames(table) <- c("N", "Any positive rounds", "No positive rounds", "No neutral rounds (30)", "No negative rounds", "All non-negative rounds", "All non-positive rounds", "No positive round", "Positive avg PD", "PD = 0", "Negative avg PD")
```

\begin{align}\label{eq:ProfitBefore}
    \pi^{Before}=1000\cdot\frac{\sum\limits_{j}\theta_j\cdot\left(P_j-BBV\right)\cdot Vol_j}{W_{t=0}\cdot \sum Vol_{j}},
\end{align}

\begin{align}\label{eq:ProfitAfterRedist}
    \pi^{After\,redistribution}=\pi^{Before}+1000\cdot\frac{Redist}{W_{t=0}\cdot \sum Vol_{j}},
\end{align}

\begin{align}\label{eq:ProfitAfterPun}
    \pi^{After\, punishment}=\pi^{After\,redistribution}-1000\cdot\frac{Pen}{W_{t=0}\cdot \sum Vol_{j}},
\end{align}

```{r TPVolgraph, echo=FALSE ,fig.cap="Mean gross trading profits per trader per share (‘$\\pi$’) by regulatory regime, trader type, and phase.", warning=F}
# Data for Table WA10 ##
tPDbeforeVolInf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVolUni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVol1Inf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVol1Uni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVol2Inf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVol2Uni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVol3Inf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDbeforeVol3Uni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunVolInf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunVolUni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunVol1Inf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunVol1Uni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunVol2Inf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDPunVol2Uni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tPDPunVol3Inf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tPDPunVol3Uni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

ePDbeforeVolInf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVolUni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVol1Inf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVol1Uni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVol2Inf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVol2Uni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVol3Inf <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDbeforeVol3Uni <- format(round(t.test(PDbeforeVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunVolInf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunVolUni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunVol1Inf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunVol1Uni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunVol2Inf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDPunVol2Uni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = F)$estimate, digits = 4), scientific = FALSE)
ePDPunVol3Inf <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
ePDPunVol3Uni <- format(round(t.test(PDPunVol ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)


datPDVol_text <- data.frame(
  label = c(paste0("p = ",tPDbeforeVolInf,""), paste0("p = ",tPDbeforeVolUni,""), paste0("p = ",tPDbeforeVol1Inf,""), paste0("p = ",tPDbeforeVol1Uni,""), paste0("p = ",tPDbeforeVol2Inf,""), paste0("p = ",tPDbeforeVol2Uni,""), paste0("p = ",tPDbeforeVol3Inf,""),paste0("p = ",tPDbeforeVol3Uni,""),paste0("p = ",tPDPunVolInf,""),paste0("p = ",tPDPunVolUni,""),paste0("p = ",tPDPunVol1Inf,""),paste0("p = ",tPDPunVol1Uni,""),paste0("p = ",tPDPunVol2Inf,""),paste0("p = ",tPDPunVol2Uni,""),paste0("p = ",tPDPunVol3Inf,""),paste0("p = ",tPDPunVol3Uni,"")),
  IsREG = c("REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG", "REG"),
  Role = c("Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders", "Informed\ntraders", "Uninformed\ntraders"),
  Phase = c("All phases", "All phases", "Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3", "All phases", "All phases", "Phase 1", "Phase 1", "Phase 2", "Phase 2", "Phase 3", "Phase 3"),
  group = c("PDbefore","PDbefore","PDbefore", "PDbefore", "PDbefore", "PDbefore", "PDbefore", "PDbefore", "REG.PDPun", "REG.PDPun", "REG.PDPun", "REG.PDPun", "REG.PDPun","REG.PDPun","REG.PDPun","REG.PDPun"),
  Variable = c("PDbefore","PDbefore","PDbefore", "PDbefore", "PDbefore", "PDbefore", "PDbefore", "PDbefore", "PDPun", "PDPun", "PDPun", "PDPun", "PDPun","PDPun","PDPun","PDPun"),
  vjust = c(0,0,0,0,0,0,0,0,.09,.09,.09,.09,.09,.09,.09,.09)
)

#postscript("Figures/GraphPDPhaseallTreatVol.eps")
ggplot(data=subset(avgtraderphasesummary2, variable == "PDbeforeVol" | ( IsREG != "NOREG" & variable =="PDPunVol")), aes(y= value, x= Role, group = group, fill = group, color = group)) +
  geom_bar(stat="identity", position = position_dodge(width = 0.7), size = 2) + 
  labs(y="") +
  geom_text(data = subset(datPDVol_text[3:8,]), mapping = aes(x = Role, y = 1.9 - vjust, label = label), col = "black", size = 4) +
  geom_text(data = subset(datPDVol_text[11:16,]), mapping = aes(x = Role, y = 1.9 - vjust, label = label), col = "orange", size = 4) +
  geom_errorbar(aes(ymin = dol, ymax = upl), width=.2, color = 'black', size = .7, position=position_dodge(width=0.7)) +
  theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
  facet_grid(. ~ Phase, scales = "free") +
  scale_color_manual(name = "Regime - Punishment", values = c("REG.PDbeforeVol" = "transparent", "NOREG.PDbeforeVol" = "transparent", "REG.PDPunVol" = "orange"), breaks = c("NOREG.PDbeforeVol", "REG.PDbeforeVol", "REG.PDPunVol"), labels = c("NOREG", "REG - before punishment", "REG - after punishment")) +
  scale_fill_manual(name = "Regime - Punishment", values = c("NOREG.PDbeforeVol" = rgb(.46, .76, .88), "REG.PDPunVol" = rgb(0,.29,.51), "REG.PDbeforeVol" = rgb(0,.29,.51)), breaks = c("NOREG.PDbeforeVol", "REG.PDbeforeVol", "REG.PDPunVol"), labels = c("NOREG", "REG - before punishment", "REG - after punishment"))
#dev.off()

```


```{r TPtableInf, echo=F, results = 'asis', warning=F}
### Table 7, Table 8, and Table 11 ####
PDmiddleInfsVol <- lm((PDbeforeVol) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Informed trader"))
PDmiddleUnInfsVol <- lm((PDbeforeVol) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Uninformed trader"))
PDbeginningInfsVol <- lm(PDbeforeVol ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Informed trader"))
PDbeginningUnInfsVol <- lm(PDbeforeVol ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Uninformed trader"))
PDendInfsVol <- lm(PDbeforeVol ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Informed trader"))
PDendUnInfsVol <- lm(PDbeforeVol ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Uninformed trader"))
PDallInfsVol <- lm(PDbeforeVol ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Informed trader"))
PDallUnInfsVol <- lm(PDbeforeVol ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Uninformed trader"))

PDmiddleVol <- lm((PDbeforeVol) ~ history + Role + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10))
PDbeginningVol <- lm(PDbeforeVol ~ REGBoth + Role + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3))
PDendVol <- lm(PDbeforeVol ~ history + Role + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9))
PDallVol <- lm(PDbeforeVol ~ history + Role + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3))

se_PDmiddleInfsVol<- coeftest(PDmiddleInfsVol, vcov. = vcovCL(PDmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDmiddleInfsVol<- coeftest(PDmiddleInfsVol, vcov. = vcovCL(PDmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDbeginningInfsVol<- coeftest(PDbeginningInfsVol, vcov. = vcovCL(PDbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDbeginningInfsVol<- coeftest(PDbeginningInfsVol, vcov. = vcovCL(PDbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDendInfsVol<- coeftest(PDendInfsVol, vcov. = vcovCL(PDendInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDendInfsVol<- coeftest(PDendInfsVol, vcov. = vcovCL(PDendInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDallInfsVol<- coeftest(PDallInfsVol, vcov. = vcovCL(PDallInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDallInfsVol<- coeftest(PDallInfsVol, vcov. = vcovCL(PDallInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDmiddleUnInfsVol<- coeftest(PDmiddleUnInfsVol, vcov. = vcovCL(PDmiddleUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDmiddleUnInfsVol<- coeftest(PDmiddleUnInfsVol, vcov. = vcovCL(PDmiddleUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDbeginningUnInfsVol<- coeftest(PDbeginningUnInfsVol, vcov. = vcovCL(PDbeginningUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDbeginningUnInfsVol<- coeftest(PDbeginningUnInfsVol, vcov. = vcovCL(PDbeginningUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDendUnInfsVol<- coeftest(PDendUnInfsVol, vcov. = vcovCL(PDendUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDendUnInfsVol<- coeftest(PDendUnInfsVol, vcov. = vcovCL(PDendUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDallUnInfsVol<- coeftest(PDallUnInfsVol, vcov. = vcovCL(PDallUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDallUnInfsVol <- coeftest(PDallUnInfsVol, vcov. = vcovCL(PDallUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]

se_PDmiddleVol<- coeftest(PDmiddleVol, vcov. = vcovCL(PDmiddleVol, cluster = ~ SessionID, type = "HC3"))
se_PDbeginningVol<- coeftest(PDbeginningVol, vcov. = vcovCL(PDbeginningVol, cluster = ~ SessionID, type = "HC3"))
se_PDendVol<- coeftest(PDendVol, vcov. = vcovCL(PDendVol, cluster = ~ SessionID, type = "HC3"))
se_PDallVol<- coeftest(PDallVol, vcov. = vcovCL(PDallVol, cluster = ~ SessionID, type = "HC3"))

PDPunmiddleInfsVol <- lm((PDPunVol) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Informed trader"))
PDPunbeginningInfsVol <- lm(PDPunVol ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Informed trader"))
PDPunendInfsVol <- lm(PDPunVol ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Informed trader"))
PDPunallInfsVol <- lm(PDPunVol ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Informed trader"))

PDPunmiddleVol <- lm((PDPunVol) ~ history + Role + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10))
PDPunbeginningVol <- lm(PDPunVol ~ REGBoth + Role + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3))
PDPunendVol <- lm(PDPunVol ~ history + Role + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9))
PDPunallVol <- lm(PDPunVol ~ history + Role + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3))

se_PDPunmiddleInfsVol <- coeftest(PDPunmiddleInfsVol, vcov. = vcovCL(PDPunmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDPunmiddleInfsVol <- coeftest(PDPunmiddleInfsVol, vcov. = vcovCL(PDPunmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDPunbeginningInfsVol <- coeftest(PDPunbeginningInfsVol, vcov. = vcovCL(PDPunbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDPunbeginningInfsVol <- coeftest(PDPunbeginningInfsVol, vcov. = vcovCL(PDPunbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDPunendInfsVol <- coeftest(PDPunendInfsVol, vcov. = vcovCL(PDPunendInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDPunendInfsVol <- coeftest(PDPunendInfsVol, vcov. = vcovCL(PDPunendInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDPunallInfsVol <- coeftest(PDPunallInfsVol, vcov. = vcovCL(PDPunallInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDPunallInfsVol <- coeftest(PDPunallInfsVol, vcov. = vcovCL(PDPunallInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]

se_PDPunmiddleVol<- coeftest(PDPunmiddleVol, vcov. = vcovCL(PDPunmiddleVol, cluster = ~ SessionID, type = "HC3"))
se_PDPunbeginningVol<- coeftest(PDPunbeginningVol, vcov. = vcovCL(PDPunbeginningVol, cluster = ~ SessionID, type = "HC3"))
se_PDPunendVol<- coeftest(PDPunendVol, vcov. = vcovCL(PDPunendVol, cluster = ~ SessionID, type = "HC3"))
se_PDPunallVol<- coeftest(PDPunallVol, vcov. = vcovCL(PDPunallVol, cluster = ~ SessionID, type = "HC3"))

PDRedistmiddleInfsVol <- lm((PDRedistVol) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Informed trader"))
PDRedistmiddleUnInfsVol <- lm((PDRedistVol) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Uninformed trader"))
PDRedistbeginningInfsVol <- lm(PDRedistVol ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Informed trader"))
PDRedistbeginningUnInfsVol <- lm(PDRedistVol ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Uninformed trader"))
PDRedistendInfsVol <- lm(PDRedistVol ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Informed trader"))
PDRedistendUnInfsVol <- lm(PDRedistVol ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Uninformed trader"))
PDRedistallInfsVol <- lm(PDRedistVol ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Informed trader"))
PDRedistallUnInfsVol <- lm(PDRedistVol ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Uninformed trader"))

PDRedistmiddleVol <- lm((PDRedistVol) ~ history + Role + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10))
PDRedistbeginningVol <- lm(PDRedistVol ~ REGBoth + Role + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3))
PDRedistendVol <- lm(PDRedistVol ~ history + Role + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9))
PDRedistallVol <- lm(PDRedistVol ~ history + Role + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3))

se_PDRedistmiddleInfsVol<- coeftest(PDRedistmiddleInfsVol, vcov. = vcovCL(PDRedistmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistmiddleInfsVol<- coeftest(PDRedistmiddleInfsVol, vcov. = vcovCL(PDRedistmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistbeginningInfsVol<- coeftest(PDRedistbeginningInfsVol, vcov. = vcovCL(PDRedistbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistbeginningInfsVol<- coeftest(PDRedistbeginningInfsVol, vcov. = vcovCL(PDRedistbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistendInfsVol<- coeftest(PDRedistendInfsVol, vcov. = vcovCL(PDRedistendInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistendInfsVol<- coeftest(PDRedistendInfsVol, vcov. = vcovCL(PDRedistendInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistallInfsVol<- coeftest(PDRedistallInfsVol, vcov. = vcovCL(PDRedistallInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistallInfsVol<- coeftest(PDRedistallInfsVol, vcov. = vcovCL(PDRedistallInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistmiddleUnInfsVol<- coeftest(PDRedistmiddleUnInfsVol, vcov. = vcovCL(PDRedistmiddleUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistmiddleUnInfsVol<- coeftest(PDRedistmiddleUnInfsVol, vcov. = vcovCL(PDRedistmiddleUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistbeginningUnInfsVol<- coeftest(PDRedistbeginningUnInfsVol, vcov. = vcovCL(PDRedistbeginningUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistbeginningUnInfsVol<- coeftest(PDRedistbeginningUnInfsVol, vcov. = vcovCL(PDRedistbeginningUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistendUnInfsVol<- coeftest(PDRedistendUnInfsVol, vcov. = vcovCL(PDRedistendUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistendUnInfsVol<- coeftest(PDRedistendUnInfsVol, vcov. = vcovCL(PDRedistendUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]
se_PDRedistallUnInfsVol<- coeftest(PDRedistallUnInfsVol, vcov. = vcovCL(PDRedistallUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,2]
p_PDRedistallUnInfsVol<- coeftest(PDRedistallUnInfsVol, vcov. = vcovCL(PDRedistallUnInfsVol, cluster = ~ SessionID, type = "HC3"))[,4]

se_PDRedistmiddleVol<- coeftest(PDRedistmiddleVol, vcov. = vcovCL(PDRedistmiddleVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistbeginningVol<- coeftest(PDRedistbeginningVol, vcov. = vcovCL(PDRedistbeginningVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistendVol<- coeftest(PDRedistendVol, vcov. = vcovCL(PDRedistendVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistallVol<- coeftest(PDRedistallVol, vcov. = vcovCL(PDRedistallVol, cluster = ~ SessionID, type = "HC3"))

texreg(list(PDbeginningInfsVol, PDRedistbeginningInfsVol,PDPunbeginningInfsVol, PDmiddleInfsVol, PDPunmiddleInfsVol, PDRedistmiddleInfsVol, PDendInfsVol, PDPunendInfsVol, PDRedistendInfsVol), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)",
       caption = "Regressions of trading profits per share (‘$\\pi$’) of informed traders by phase (Table 7).", 
       custom.model.names = c("before", "after redist", "after pun","before", "after redist", "after pun","before", "after redist", "after pun"),
       custom.header = list('Phase 1' = 1:3, 'Phase 2' = 4:6, 'Phase 3' = 7:9),
       override.se=list(se_PDbeginningInfsVol, se_PDPunbeginningInfsVol, se_PDRedistbeginningInfsVol, se_PDmiddleInfsVol, se_PDRedistmiddleInfsVol, se_PDPunmiddleInfsVol, se_PDendInfsVol, se_PDRedistendInfsVol, se_PDPunendInfsVol), 
       override.p = list(p_PDbeginningInfsVol, p_PDRedistbeginningInfsVol, p_PDPunbeginningInfsVol, p_PDmiddleInfsVol, p_PDRedistmiddleInfsVol, p_PDPunmiddleInfsVol, p_PDendInfsVol, p_PDRedistendInfsVol, p_PDPunendInfsVol))

texreg(list(PDbeginningUnInfsVol, PDRedistbeginningUnInfsVol, PDmiddleUnInfsVol, PDRedistmiddleUnInfsVol, PDendUnInfsVol, PDRedistendUnInfsVol), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
      caption = "Regressions of trading profits per share (‘$\\pi$’) of uninformed traders by phase (Table 8).", 
       custom.model.names = c("before", "after redist", "after pun","before", "after redist", "after pun"), 
       custom.header = list('Phase 1' = 1:2, 'Phase 2' = 3:4, 'Phase 3' = 5:6),
      override.se=list(se_PDbeginningUnInfsVol, se_PDRedistbeginningUnInfsVol, se_PDmiddleUnInfsVol, se_PDRedistmiddleUnInfsVol, se_PDendUnInfsVol, se_PDRedistendUnInfsVol), 
       override.p = list(p_PDbeginningUnInfsVol, p_PDRedistbeginningUnInfsVol, p_PDmiddleUnInfsVol, p_PDRedistmiddleUnInfsVol, p_PDendUnInfsVol, p_PDRedistendUnInfsVol))

texreg(list(PDbeginningVol, PDRedistbeginningVol, PDmiddleVol, PDRedistmiddleVol, PDendVol, PDRedistendVol), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       caption = "Regressions of trading profits per share (‘$\\pi$’) of both trader types by phase (Table 11)", 
       custom.model.names = c("before", "after redist", "before", "after redist", "before", "after redist"),
       custom.header = list('Phase 1' = 1:2, 'Phase 2' = 3:4, 'Phase 3' = 5:6),
       override.se=list(se_PDbeginningVol[,2], se_PDRedistbeginningVol[,2], se_PDmiddleVol[,2], se_PDRedistmiddleVol[,2], se_PDendVol[,2], se_PDRedistendVol[,2]), 
       override.p = list(se_PDbeginningVol[,4], se_PDRedistbeginningVol[,4], se_PDmiddleVol[,4], se_PDRedistmiddleVol[,4], se_PDendVol[,4], se_PDRedistendVol[,4]))

```


```{r profitrankinteraction, echo = F, fig.cap= "Effect size of regulation by traders' rank, i.e. coefficient and 95% confidence interval of the interaction between regulation and the traders' rank on trading profit per share."}
PDmiddleInfsVol <- lm((PDbeforeVol) ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary,Programme==3 & Period>3 & Period<10 & Role=="Informed trader"))
PDmiddleUnInfsVol <- lm((PDbeforeVol) ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Uninformed trader"))
PDbeginningInfsVol <- lm(PDbeforeVol ~ REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Informed trader"))
PDbeginningUnInfsVol <- lm(PDbeforeVol ~ REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Uninformed trader"))
PDendInfsVol <- lm(PDbeforeVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Informed trader"))
PDendUnInfsVol <- lm(PDbeforeVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Uninformed trader"))
PDallInfsVol <- lm(PDbeforeVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Informed trader"))
PDallUnInfsVol <- lm(PDbeforeVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Uninformed trader"))

se_PDmiddleInfsVol<- coeftest(PDmiddleInfsVol, vcov. = vcovCL(PDmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDbeginningInfsVol<- coeftest(PDbeginningInfsVol, vcov. = vcovCL(PDbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDendInfsVol<- coeftest(PDendInfsVol, vcov. = vcovCL(PDendInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDallInfsVol<- coeftest(PDallInfsVol, vcov. = vcovCL(PDallInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDmiddleUnInfsVol<- coeftest(PDmiddleUnInfsVol, vcov. = vcovCL(PDmiddleUnInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDbeginningUnInfsVol<- coeftest(PDbeginningUnInfsVol, vcov. = vcovCL(PDbeginningUnInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDendUnInfsVol<- coeftest(PDendUnInfsVol, vcov. = vcovCL(PDendUnInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDallUnInfsVol<- coeftest(PDallUnInfsVol, vcov. = vcovCL(PDallUnInfsVol, cluster = ~ SessionID, type = "HC3"))

PDPunmiddleInfsVol <- lm((PDPunVol) ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Informed trader"))
PDPunbeginningInfsVol <- lm(PDPunVol ~ REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Informed trader"))
PDPunendInfsVol <- lm(PDPunVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Informed trader"))
PDPunallInfsVol <- lm(PDPunVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Informed trader"))

se_PDPunmiddleInfsVol <- coeftest(PDPunmiddleInfsVol, vcov. = vcovCL(PDPunmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDPunbeginningInfsVol <- coeftest(PDPunbeginningInfsVol, vcov. = vcovCL(PDPunbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDPunendInfsVol <- coeftest(PDPunendInfsVol, vcov. = vcovCL(PDPunendInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDPunallInfsVol <- coeftest(PDPunallInfsVol, vcov. = vcovCL(PDPunallInfsVol, cluster = ~ SessionID, type = "HC3"))

PDRedistmiddleInfsVol <- lm((PDRedistVol) ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Informed trader"))
PDRedistmiddleUnInfsVol <- lm((PDRedistVol) ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>3 & Period<10 & Role=="Uninformed trader"))
PDRedistbeginningInfsVol <- lm(PDRedistVol ~ REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Informed trader"))
PDRedistbeginningUnInfsVol <- lm(PDRedistVol ~ REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period<=3 & Role=="Uninformed trader"))
PDRedistendInfsVol <- lm(PDRedistVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Informed trader"))
PDRedistendUnInfsVol <- lm(PDRedistVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Period>9 & Role=="Uninformed trader"))
PDRedistallInfsVol <- lm(PDRedistVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Informed trader"))
PDRedistallUnInfsVol <- lm(PDRedistVol ~ history + REGBoth:as.factor(rankavgPDbeforeRole) + REGSH:as.factor(rankavgPDbeforeRole) + as.factor(rankavgPDbeforeRole) + BBVCent + abs(BBVCent) + market + Period0, data = subset(subjectsummary, Programme==3 & Role=="Uninformed trader"))

se_PDRedistmiddleInfsVol<- coeftest(PDRedistmiddleInfsVol, vcov. = vcovCL(PDRedistmiddleInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistbeginningInfsVol<- coeftest(PDRedistbeginningInfsVol, vcov. = vcovCL(PDRedistbeginningInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistendInfsVol<- coeftest(PDRedistendInfsVol, vcov. = vcovCL(PDRedistendInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistallInfsVol<- coeftest(PDRedistallInfsVol, vcov. = vcovCL(PDRedistallInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistmiddleUnInfsVol<- coeftest(PDRedistmiddleUnInfsVol, vcov. = vcovCL(PDRedistmiddleUnInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistbeginningUnInfsVol<- coeftest(PDRedistbeginningUnInfsVol, vcov. = vcovCL(PDRedistbeginningUnInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistendUnInfsVol<- coeftest(PDRedistendUnInfsVol, vcov. = vcovCL(PDRedistendUnInfsVol, cluster = ~ SessionID, type = "HC3"))
se_PDRedistallUnInfsVol<- coeftest(PDRedistallUnInfsVol, vcov. = vcovCL(PDRedistallUnInfsVol, cluster = ~ SessionID, type = "HC3"))

#texreg(list(PDbeginningInfsVol, PDRedistbeginningInfsVol,PDPunbeginningInfsVol, PDmiddleInfsVol, PDPunmiddleInfsVol, PDRedistmiddleInfsVol, PDendInfsVol, PDPunendInfsVol, PDRedistendInfsVol), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
#       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
#       caption = "Trading profits", override.se=list(se_PDbeginningInfsVol[,2], se_PDPunbeginningInfsVol[,2], se_PDRedistbeginningInfsVol[,2], se_PDmiddleInfsVol[,2], se_PDRedistmiddleInfsVol[,2], se_PDPunmiddleInfsVol[,2], se_PDendInfsVol[,2], se_PDRedistendInfsVol[,2], se_PDPunendInfsVol[,2]), 
#       override.p = list(se_PDbeginningInfsVol[,4], se_PDPunbeginningInfsVol[,4], se_PDRedistbeginningInfsVol[,4], se_PDmiddleInfsVol[,4], se_PDRedistmiddleInfsVol[,4], se_PDPunmiddleInfsVol[,4], se_PDendInfsVol[,4], se_PDRedistendInfsVol[,4], se_PDPunendInfsVol[,4]))

#texreg(list(PDbeginningUnInfsVol, PDRedistbeginningUnInfsVol, PDmiddleUnInfsVol, PDRedistmiddleUnInfsVol, PDendUnInfsVol, PDRedistendUnInfsVol), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
#       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
#       caption = "Trading profits", #override.se=list(se_PDbeginningUnInfsVol[,2], se_PDRedistbeginningUnInfsVol[,2], se_PDmiddleUnInfsVol[,2], se_PDRedistmiddleUnInfsVol[,2], se_PDendUnInfsVol[,2], se_PDRedistendUnInfsVol[,2]), 
#       override.p = list(se_PDbeginningUnInfsVol[,4], se_PDRedistbeginningUnInfsVol[,4], se_PDmiddleUnInfsVol[,4], se_PDRedistmiddleUnInfsVol[,4], se_PDendUnInfsVol[,4], se_PDRedistendUnInfsVol[,4]))

coefProfitRank <- rbind(se_PDbeginningUnInfsVol[-(1:18),], se_PDRedistbeginningUnInfsVol[-(1:18),], se_PDmiddleUnInfsVol[-(1:19),], se_PDRedistmiddleUnInfsVol[-(1:19),],se_PDendUnInfsVol[-(1:21),],se_PDRedistendUnInfsVol[-(1:21),], se_PDbeginningInfsVol[-(1:18),], se_PDRedistbeginningInfsVol[-(1:18),], se_PDmiddleInfsVol[-(1:19),], se_PDRedistmiddleInfsVol[-(1:19),], se_PDendInfsVol[-(1:21),],se_PDRedistendInfsVol[-(1:21),])
coefProfitRank <- data.frame(coefProfitRank, Role = rep(c("Uninformed trader", "Informed trader"), each = 28*3), Rank = c(1:14), Phase = rep(c("Phase 1", "Phase 2", "Phase 3"), each = 28),  variable = rep(c("Before", "After"), each = 14), df = rep(c(PDbeginningUnInfsVol$df.residual, PDmiddleUnInfsVol$df.residual, PDendUnInfsVol$df.residual,PDbeginningInfsVol$df.residual, PDmiddleInfsVol$df.residual, PDendInfsVol$df.residual), each = 28)) 
coefProfitRank$variable <- factor(coefProfitRank$variable, levels = c("Before", "After"))

#postscript("Figures/GraphPDEffectrankTreat.eps")
ggplot(data=subset(coefProfitRank), aes(y= Estimate, x= Rank, group=(variable))) +
    geom_point(position = position_dodge(width = 0.5))+ 
    labs(y="") +
    theme(text = element_text(size=18),axis.title.x=element_blank(),legend.title = element_blank(), legend.position = "bottom", legend.direction = "horizontal", panel.grid.major.y = element_line(colour = "lightgrey"), panel.background = element_rect(fill = "transparent"), plot.background = element_rect(fill = "transparent")) +
    facet_grid(Role ~ Phase, scales = "fixed") +
    geom_errorbar(aes(ymin = Estimate + qt(.025,df)*Std..Error, ymax = Estimate + qt(.975,df)*Std..Error, color = variable), width=.2, position=position_dodge(width=0.5)) +
    scale_x_continuous(breaks = c(1:7)*2) +
    scale_color_manual(name = "Redistribution", values = c("Before" = "black", "After" = "orange"))
#dev.off()

```

#### Mean trading profts (`PD') by regulatory regime, trader type, and phase (Table WA9).
```{r profittrader, echo = F}
### Table WA 9 ####
dat_profit <- data.frame( c(ePDbeforeInf, tPDbeforeInf, ePDPunInf, tPDPunInf), 
                          c(ePDbeforeUni, tPDbeforeUni, ePDPunUni, tPDPunUni),
                          c(ePDbefore1Inf, tPDbefore1Inf, ePDPun1Inf, tPDPun1Inf), 
                          c(ePDbefore1Uni, tPDbefore1Uni, ePDPun1Uni, tPDPun1Uni),
                          c(ePDbefore2Inf, tPDbefore2Inf, ePDPun2Inf, tPDPun2Inf), 
                          c(ePDbefore2Uni, tPDbefore2Uni, ePDPun2Uni, tPDPun2Uni),
                          c(ePDbefore3Inf, tPDbefore3Inf, ePDPun3Inf, tPDPun3Inf), 
                          c(ePDbefore3Uni, tPDbefore3Uni, ePDPun3Uni, tPDPun3Uni))

dat_profit <- t(dat_profit)
colnames(dat_profit) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_profit) <- c("Inf all phases", "Uninf all phases", "Inf Phase 1", "Uni Phase 1",  "Inf Phase 2", "Uni Phase 2", "Inf Phase 3", "Uni Phase 3")

dat_profit

dat_profitS <- matrix(data = NA, ncol = 3, nrow = 6)
i <- 1
while(i<7){
  for(p in list("Phase 1", "Phase 2", "Phase 3")){
    for(r in list("Informed trader", "Uninformed trader")){
  sN <- t.test(PDbefore ~ 1, mu = 0, data=subset(subjectsummary, Phase == p & Role == r & IsREG == "NOREG"), var.equal=T)$p.value
  sN <- if(sN<.001){"***"} else if(sN<.01) {"**"} else if(sN<.05) {"*"} else {""}
sR <- t.test(PDbefore ~ 1, mu = 0, data=subset(subjectsummary, Phase == p & Role== r & IsREG == "REG"), var.equal=T)$p.value
  sR <- if(sR<.001){"***"} else if(sR<.01) {"**"} else if(sR<.05) {"*"} else {""}
sRp <- t.test(PDPun ~ 1, mu = 0, data=subset(subjectsummary, Phase == p & Role== r & IsREG == "REG"), var.equal=T)$p.value
  sRp <- if(sRp<.001){"***"} else if(sRp<.01) {"**"} else if(sRp<.05) {"*"} else {""}
  dat_profitS[i,] <- (c(sN, sR, sRp))
  i <- i + 1
}}}
                    
colnames(dat_profitS) <- c("NOREG", "REG", "REG")
row.names(dat_profitS) <- c("Inf Phase 1", "Uni Phase 1", "Inf Phase 2", "Uni Phase 2", "Inf Phase 3", "Uni Phase 3")

dat_profitS
```

```{r profitshare, echo = F}
### Table WA10 ####
dat_profit <- data.frame( c(ePDbeforeVolInf, tPDbeforeVolInf, ePDPunVolInf, tPDPunVolInf), 
                          c(ePDbeforeVolUni, tPDbeforeVolUni, ePDPunVolUni, tPDPunVolUni),
                          c(ePDbeforeVol1Inf, tPDbeforeVol1Inf, ePDPunVol1Inf, tPDPunVol1Inf), 
                          c(ePDbeforeVol1Uni, tPDbeforeVol1Uni, ePDPunVol1Uni, tPDPunVol1Uni),
                          c(ePDbeforeVol2Inf, tPDbeforeVol2Inf, ePDPunVol2Inf, tPDPunVol2Inf), 
                          c(ePDbeforeVol2Uni, tPDbeforeVol2Uni, ePDPunVol2Uni, tPDPunVol2Uni),
                          c(ePDbeforeVol3Inf, tPDbeforeVol3Inf, ePDPunVol3Inf, tPDPunVol3Inf), 
                          c(ePDbeforeVol3Uni, tPDbeforeVol3Uni, ePDPunVol3Uni, tPDPunVol3Uni))

dat_profit <- t(dat_profit)
colnames(dat_profit) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_profit) <- c("Inf all phases", "Uninf all phases", "Inf Phase 1", "Uni Phase 1", "Inf Phase 2", "Uni Phase 2", "Inf Phase 3", "Uni Phase 3")

dat_profit

dat_profitS <- matrix(data = NA, ncol = 3, nrow = 6)
i <- 1
while(i<7){
  for(p in list("Phase 1", "Phase 2", "Phase 3")){
    for(r in list("Informed trader", "Uninformed trader")){
  sN <- t.test(PDbeforeVol ~ 1, mu = 0, data=subset(subjectsummary, Phase == p & Role == r & IsREG == "NOREG"), var.equal=T)$p.value
  sN <- if(sN<.001){"***"} else if(sN<.01) {"**"} else if(sN<.05) {"*"} else {""}
sR <- t.test(PDbeforeVol ~ 1, mu = 0, data=subset(subjectsummary, Phase == p & Role== r & IsREG == "REG"), var.equal=T)$p.value
  sR <- if(sR<.001){"***"} else if(sR<.01) {"**"} else if(sR<.05) {"*"} else {""}
sRp <- t.test(PDPunVol ~ 1, mu = 0, data=subset(subjectsummary, Phase == p & Role== r & IsREG == "REG"), var.equal=T)$p.value
  sRp <- if(sRp<.001){"***"} else if(sRp<.01) {"**"} else if(sRp<.05) {"*"} else {""}
  dat_profitS[i,] <- (c(sN, sR, sRp))
  i <- i + 1
}}}
                    
colnames(dat_profitS) <- c("NOREG", "REG", "REG")
row.names(dat_profitS) <- c("Inf Phase 1", "Uni Phase 1", "Inf Phase 2", "Uni Phase 2", "Inf Phase 3", "Uni Phase 3")

dat_profitS
```

#### Mean trading profits per share (`$\pi$') by regulatory regime, trader type, and phase (Table WA10).
```{r profittype, echo=F}
### Table WA10 ####
dat_profitT<- matrix(data = NA, ncol = 3, nrow = 3)
i <- 1
while(i<4){
  for(p in list("Phase 1", "Phase 2", "Phase 3")){
  sN <- format(round(t.test(PDbefore ~ Role, data=subset(subjectsummary, Phase == p & IsREG == "NOREG"), var.equal=F)$p.value, digits = 4), scientific = FALSE)
sR <- format(round(t.test(PDbefore ~ Role, data=subset(subjectsummary, Phase == p & IsREG == "REG"), var.equal=F)$p.value, digits = 4), scientific = FALSE)
sRp <- format(round(t.test(PDPun ~ Role, data=subset(subjectsummary, Phase == p & IsREG == "REG"), var.equal=F)$p.value, digits = 4), scientific = FALSE)
  dat_profitT[i,] <- (c(sN, sR, sRp))
  i <- i + 1
}}
                    
colnames(dat_profitT) <- c("NOREG", "REG", "REG")
row.names(dat_profitT) <- c("Phase 1", "Phase 2", "Phase 3")

dat_profitT
```

*****************************************************************
\newpage

## Short selling and margin buying activity

#### Mean short selling activity by regulatory regime, trader type, and phase (Table WA4).
```{r shorttradermarket, echo = F}
### Table WA4 ####
dat_short <- data.frame( c(eshortInf, tshortInf, eshortUni, tshortUni), c(eshort1Inf, tshort1Inf, eshort1Uni, tshort1Uni), c(eshort2Inf, tshort2Inf, eshort2Uni, tshort2Uni),  c(eshort3Inf, tshort3Inf, eshort3Uni, tshort3Uni), c(eshort13Inf, tshort13Inf, eshort13Uni, tshort13Uni)
                      )

dat_short <- t(dat_short)
colnames(dat_short) <- c("NOREG", "REG", "pvalues_before","NOREG", "REG", "pvalues_after")
row.names(dat_short) <- c("Short sells all phases", "Short sells Phase 1", "Short sells Phase 2", "Short sells Phase 3", "Short sells Phase 1 & 3")

dat_short
```

#### Mean short margin buying at BBV activity by regulatory regime, trader type, and phase (Table WA4).
```{r margintradermarket, echo = F}
### Table WA4 ####
emarginInf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emarginUni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin1Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin1Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin2Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin2Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin3Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin3Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin13Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Informed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
emargin13Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Uninformed trader"), var.equal=T)$estimate, digits = 4), scientific = FALSE)
tmarginInf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmarginUni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin1Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin1Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>0 & Period<4 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin2Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Informed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tmargin2Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>3 & Period<10 & Role=="Uninformed trader"), var.equal=T, paired = T)$p.value, digits = 4), scientific = FALSE)
tmargin3Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin3Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period>9 & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin13Inf2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Informed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)
tmargin13Uni2 <- format(round(t.test(marginbuys ~ IsREG, data=subset(subjectsummary, Period >0 & (Period <4 | Period>9) & Role=="Uninformed trader"), var.equal=T)$p.value, digits = 4), scientific = FALSE)

dat_margin <- data.frame( c(emarginInf2, tmarginInf2, emarginUni2, tmarginUni2), c(emargin1Inf2, tmargin1Inf2, emargin1Uni2, tmargin1Uni2), c(emargin2Inf2, tmargin2Inf2, emargin2Uni2, tmargin2Uni2), c(emargin3Inf2, tmargin3Inf2, emargin3Uni2, tmargin3Uni2), c(emargin13Inf2, tmargin13Inf2, emargin13Uni2, tmargin13Uni2)
                      )

dat_margin <- t(dat_margin)
colnames(dat_margin) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_margin) <- c("Margin buys all phases", "Margin buys Phase 1", "Margin buys Phase 2", "Margin buys Phase 3", "Margin buys Phase 1 & 3")

dat_margin
```

#### Mean short margin buying at market prices activity by regulatory regime, trader type, and phase (Table WA4).
```{r marginAssettradermarket, echo = F}
### Table WA4 ####
dat_margin <- data.frame( c(emarginInf, tmarginInf, emarginUni, tmarginUni), c(emargin1Inf, tmargin1Inf, emargin1Uni, tmargin1Uni), c(emargin2Inf, tmargin2Inf, emargin2Uni, tmargin2Uni), c(emargin3Inf, tmargin3Inf, emargin3Uni, tmargin3Uni), c(emargin13Inf, tmargin13Inf, emargin13Uni, tmargin13Uni)
                     )

dat_margin <- t(dat_margin)
colnames(dat_margin) <- c("NOREG", "REG", "pvalues_Informed","NOREG", "REG", "pvalues_Uninformed")
row.names(dat_margin) <- c("Margin buys all phases", "Margin buys Phase 1", "Margin buys Phase 2", "Margin buys Phase 3", "Margin buys Phase 1 & 3")

dat_margin
```

```{r shortingtableAll, echo=F, results = 'asis', warning=F}
### Table WA5 ####
shortmiddleUninf <- zeroinfl((shortsells_Uninformed) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
shortmiddleInf <- zeroinfl((shortsells_Informed) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
shortbeginningUninf <- zeroinfl((shortsells_Uninformed) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
shortbeginningInf <- zeroinfl((shortsells_Informed) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
shortendUninf <- zeroinfl((shortsells_Uninformed) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))
shortendInf <- zeroinfl((shortsells_Informed) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))

# <- zeroinfl((shortsells) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0))
#shortallInf <- zeroinfl((shortsells) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Informed trader" & Programme==3))

shortmiddle <- zeroinfl((shortsells) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
shortbeginning <- zeroinfl(shortsells ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
shortend <- zeroinfl(shortsells ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))
#shortall <- zeroinfl(shortsells ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3))

shortmiddleUninftest <- hurdletest(hurdle((shortsells_Uninformed) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
shortmiddleInftest <- hurdletest(hurdle((shortsells_Informed) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
shortbeginningUninftest <- hurdletest(hurdle((shortsells_Uninformed) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
shortbeginningInftest <- hurdletest(hurdle((shortsells_Informed) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
shortendUninftest <- hurdletest(hurdle((shortsells_Uninformed) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))
shortendInftest <- hurdletest(hurdle((shortsells_Informed) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))

#test <- hurdletest(hurdle((shortsells) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0)))
#shortallInftest <- hurdletest(hurdle((shortsells) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Informed trader" & Programme==3)))

shortmiddletest <- hurdletest(hurdle((shortsells) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
shortbeginningtest <- hurdletest(hurdle(shortsells ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
shortendtest <- hurdletest(hurdle(shortsells ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))
#shortalltest <- hurdletest(hurdle(shortsells ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3)))

#clustered errors are not reported because of theta
se_shortmiddle <- coeftest(shortmiddle, vcov. = vcovCL(shortmiddle, cluster = ~ SessionID, type = "HC1"))
se_shortbeginning <- coeftest(shortbeginning, vcov. = vcovCL(shortbeginning, cluster = ~ SessionID, type = "HC1"))
se_shortend <- coeftest(shortend, vcov. = vcovCL(shortend, cluster = ~ SessionID, type = "HC1"))
#se_shortall <- coeftest(shortall, vcov. = vcovCL(shortall, cluster = ~ SessionID, type = "HC1"))

se_shortmiddleUninf <- coeftest(shortmiddleUninf, vcov. = vcovCL(shortmiddleUninf, cluster = ~ SessionID, type = "HC1"))
se_shortbeginningUninf <- coeftest(shortbeginningUninf, vcov. = vcovCL(shortbeginningUninf, cluster = ~ SessionID, type = "HC1"))
se_shortendUninf <- coeftest(shortendUninf, vcov. = vcovCL(shortendUninf, cluster = ~ SessionID, type = "HC1"))
#se_shortallUninf <- coeftest(shortallUninf, vcov. = vcovCL(shortallUninf, cluster = ~ SessionID, type = "HC1"))

se_shortmiddleInf <- coeftest(shortmiddleInf, vcov. = vcovCL(shortmiddleInf, cluster = ~ SessionID, type = "HC1"))
se_shortbeginningInf <- coeftest(shortbeginningInf, vcov. = vcovCL(shortbeginningInf, cluster = ~ SessionID, type = "HC1"))
se_shortendInf <- coeftest(shortendInf, vcov. = vcovCL(shortendInf, cluster = ~ SessionID, type = "HC1"))
#se_shortallInf <- coeftest(shortallInf, vcov. = vcovCL(shortallInf, cluster = ~ SessionID, type = "HC1"))

texreg(list(shortbeginning, shortmiddle, shortend,shortbeginningInf, shortmiddleInf, shortendInf, shortbeginningUninf, shortmiddleUninf, shortendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Zero inflated negative binomial model for short selling (Table WA5).", 
       custom.header = list('All traders' = 1:3, 'Informed traders' = 4:6, 'Uninformed traders' = 7:9),
       override.se=list(se_shortbeginning[,2], se_shortmiddle[,2], se_shortend[,2], se_shortbeginningInf[,2], se_shortmiddleInf[,2], se_shortendInf[,2], se_shortbeginningUninf[,2], se_shortmiddleUninf[,2], se_shortendUninf[,2]), override.p=list(se_shortbeginning[,4], se_shortmiddle[,4], se_shortend[,4], se_shortbeginningInf[,4], se_shortmiddleInf[,4], se_shortendInf[,4], se_shortbeginningUninf[,4], se_shortmiddleUninf[,4], se_shortendUninf[,4]), 
       custom.gof.rows = list("Hurdle test p-value" = c(shortbeginningtest$`Pr(>Chisq)`[2], shortmiddletest$`Pr(>Chisq)`[2], shortendtest$`Pr(>Chisq)`[2],shortbeginningInftest$`Pr(>Chisq)`[2], shortmiddleInftest$`Pr(>Chisq)`[2], shortendInftest$`Pr(>Chisq)`[2], shortbeginningUninftest$`Pr(>Chisq)`[2], shortmiddleUninftest$`Pr(>Chisq)`[2], shortendUninftest$`Pr(>Chisq)`[2]), 
       "$sum_i hat{f}_i(0)$" = c(round(sum(predict(shortbeginning, type = "prob")[,1])),round(sum(predict(shortmiddle, type = "prob")[,1])), round(sum(predict(shortend, type = "prob")[,1])), round(sum(predict(shortbeginningInf, type = "prob")[,1])),round(sum(predict(shortmiddleInf, type = "prob")[,1])), round(sum(predict(shortendInf, type = "prob")[,1])), round(sum(predict(shortbeginningUninf, type = "prob")[,1])),round(sum(predict(shortmiddleUninf, type = "prob")[,1])), round(sum(predict(shortendUninf, type = "prob")[,1]))),
       "$mu_i$" = c(round(predict(shortbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(shortendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2)),
      "$mu_i(BBV12.5)$" = c(round(predict(shortbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2)),
        "$mu_i(BBV-12.5)$" = c(round(predict(shortbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(shortendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2))
       ))

```


```{r marginingtableAll, echo=F, results = 'asis', warning=F}
### Table WA6 ####
marginmiddleUninf <- zeroinfl((ceiling(marginbuys_Uninformed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginmiddleInf <- zeroinfl((ceiling(marginbuys_Informed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginbeginningUninf <- zeroinfl((ceiling(marginbuys_Uninformed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
marginbeginningInf <- zeroinfl((ceiling(marginbuys_Informed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
marginendUninf <- zeroinfl((ceiling(marginbuys_Uninformed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))
marginendInf <- zeroinfl((ceiling(marginbuys_Informed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))

# <- zeroinfl((ceiling(marginbuys)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0))
#marginallInf <- zeroinfl((ceiling(marginbuys)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Informed trader" & Programme==3))

marginmiddle <- zeroinfl((ceiling(marginbuys)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginbeginning <- zeroinfl(ceiling(marginbuys) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
marginend <- zeroinfl(ceiling(marginbuys) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))
#marginall <- zeroinfl(ceiling(marginbuys) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3))

marginmiddleUninftest <- hurdletest(hurdle((ceiling(marginbuys_Uninformed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
marginmiddleInftest <- hurdletest(hurdle((ceiling(marginbuys_Informed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
marginbeginningUninftest <- hurdletest(hurdle((ceiling(marginbuys_Uninformed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
marginbeginningInftest <- hurdletest(hurdle((ceiling(marginbuys_Informed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
marginendUninftest <- hurdletest(hurdle((ceiling(marginbuys_Uninformed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))
marginendInftest <- hurdletest(hurdle((ceiling(marginbuys_Informed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))

#test <- hurdletest(hurdle((ceiling(marginbuys)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0)))
#marginallInftest <- hurdletest(hurdle((ceiling(marginbuys)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Informed trader" & Programme==3)))

marginmiddletest <- hurdletest(hurdle((ceiling(marginbuys)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
marginbeginningtest <- hurdletest(hurdle(ceiling(marginbuys) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
marginendtest <- hurdletest(hurdle(ceiling(marginbuys) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))
#marginalltest <- hurdletest(hurdle(ceiling(marginbuys) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3)))

#clustered errors are not reported because of theta
se_marginmiddle <- coeftest(marginmiddle, vcov. = vcovCL(marginmiddle, cluster = ~ SessionID, type = "HC1"))
se_marginbeginning <- coeftest(marginbeginning, vcov. = vcovCL(marginbeginning, cluster = ~ SessionID, type = "HC1"))
se_marginend <- coeftest(marginend, vcov. = vcovCL(marginend, cluster = ~ SessionID, type = "HC1"))
#se_marginall <- coeftest(marginall, vcov. = vcovCL(marginall, cluster = ~ SessionID, type = "HC1"))

se_marginmiddleUninf <- coeftest(marginmiddleUninf, vcov. = vcovCL(marginmiddleUninf, cluster = ~ SessionID, type = "HC1"))
se_marginbeginningUninf <- coeftest(marginbeginningUninf, vcov. = vcovCL(marginbeginningUninf, cluster = ~ SessionID, type = "HC1"))
se_marginendUninf <- coeftest(marginendUninf, vcov. = vcovCL(marginendUninf, cluster = ~ SessionID, type = "HC1"))
#se_marginallUninf <- coeftest(marginallUninf, vcov. = vcovCL(marginallUninf, cluster = ~ SessionID, type = "HC1"))

se_marginmiddleInf <- coeftest(marginmiddleInf, vcov. = vcovCL(marginmiddleInf, cluster = ~ SessionID, type = "HC1"))
se_marginbeginningInf <- coeftest(marginbeginningInf, vcov. = vcovCL(marginbeginningInf, cluster = ~ SessionID, type = "HC1"))
se_marginendInf <- coeftest(marginendInf, vcov. = vcovCL(marginendInf, cluster = ~ SessionID, type = "HC1"))
#se_marginallInf <- coeftest(marginallInf, vcov. = vcovCL(marginallInf, cluster = ~ SessionID, type = "HC1"))

texreg(list(marginbeginning, marginmiddle, marginend,marginbeginningInf, marginmiddleInf, marginendInf, marginbeginningUninf, marginmiddleUninf, marginendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Zero inflated negative binomial model for margin buying evaluated at BBV (Table WA6).",
       custom.header = list('All traders' = 1:3, 'Informed traders' = 4:6, 'Uninformed traders' = 7:9),
       override.se=list(se_marginbeginning[,2], se_marginmiddle[,2], se_marginend[,2], se_marginbeginningInf[,2], se_marginmiddleInf[,2], se_marginendInf[,2], se_marginbeginningUninf[,2], se_marginmiddleUninf[,2], se_marginendUninf[,2]), override.p=list(se_marginbeginning[,4], se_marginmiddle[,4], se_marginend[,4], se_marginbeginningInf[,4], se_marginmiddleInf[,4], se_marginendInf[,4], se_marginbeginningUninf[,4], se_marginmiddleUninf[,4], se_marginendUninf[,4]), 
       custom.gof.rows = list("Hurdle test p-value" = c(marginbeginningtest$`Pr(>Chisq)`[2], marginmiddletest$`Pr(>Chisq)`[2], marginendtest$`Pr(>Chisq)`[2],marginbeginningInftest$`Pr(>Chisq)`[2], marginmiddleInftest$`Pr(>Chisq)`[2], marginendInftest$`Pr(>Chisq)`[2], marginbeginningUninftest$`Pr(>Chisq)`[2], marginmiddleUninftest$`Pr(>Chisq)`[2], marginendUninftest$`Pr(>Chisq)`[2]), 
       "$sum_i hat{f}_i(0)$" = c(round(sum(predict(marginbeginning, type = "prob")[,1])),round(sum(predict(marginmiddle, type = "prob")[,1])), round(sum(predict(marginend, type = "prob")[,1])), round(sum(predict(marginbeginningInf, type = "prob")[,1])),round(sum(predict(marginmiddleInf, type = "prob")[,1])), round(sum(predict(marginendInf, type = "prob")[,1])), round(sum(predict(marginbeginningUninf, type = "prob")[,1])),round(sum(predict(marginmiddleUninf, type = "prob")[,1])), round(sum(predict(marginendUninf, type = "prob")[,1]))),
       "$mu_i$" = c(round(predict(marginbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2)),
       "$mu_i(BBV12.5)$" = c(round(predict(marginbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2)),
       "$mu_i(BBV-12.5)$" = c(round(predict(marginbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2))
       ))


```


```{r marginAssetingtableAll, echo=F, results = 'asis', warning=F}
### Table WA7 ####
marginAssetmiddleUninf <- zeroinfl((ceiling(marginbuysAsset_Uninformed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginAssetmiddleInf <- zeroinfl((ceiling(marginbuysAsset_Informed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginAssetbeginningUninf <- zeroinfl((ceiling(marginbuysAsset_Uninformed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
marginAssetbeginningInf <- zeroinfl((ceiling(marginbuysAsset_Informed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
marginAssetendUninf <- zeroinfl((ceiling(marginbuysAsset_Uninformed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))
marginAssetendInf <- zeroinfl((ceiling(marginbuysAsset_Informed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))

# <- zeroinfl((ceiling(marginbuysAsset)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0))
#marginAssetallInf <- zeroinfl((ceiling(marginbuysAsset)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Informed trader" & Programme==3))

marginAssetmiddle <- zeroinfl((ceiling(marginbuysAsset)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginAssetbeginning <- zeroinfl(ceiling(marginbuysAsset) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3))
marginAssetend <- zeroinfl(ceiling(marginbuysAsset) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10))
#marginAssetall <- zeroinfl(ceiling(marginbuysAsset) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3))

marginAssetmiddleUninftest <- hurdletest(hurdle((ceiling(marginbuysAsset_Uninformed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
marginAssetmiddleInftest <- hurdletest(hurdle((ceiling(marginbuysAsset_Informed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
marginAssetbeginningUninftest <- hurdletest(hurdle((ceiling(marginbuysAsset_Uninformed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
marginAssetbeginningInftest <- hurdletest(hurdle((ceiling(marginbuysAsset_Informed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
marginAssetendUninftest <- hurdletest(hurdle((ceiling(marginbuysAsset_Uninformed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))
marginAssetendInftest <- hurdletest(hurdle((ceiling(marginbuysAsset_Informed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))

#test <- hurdletest(hurdle((ceiling(marginbuysAsset)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0)))
#marginAssetallInftest <- hurdletest(hurdle((ceiling(marginbuysAsset)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(Rolesummary, Role == "Informed trader" & Programme==3)))

marginAssetmiddletest <- hurdletest(hurdle((ceiling(marginbuysAsset)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>3 & Period<10)))
marginAssetbeginningtest <- hurdletest(hurdle(ceiling(marginbuysAsset) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period<=3)))
marginAssetendtest <- hurdletest(hurdle(ceiling(marginbuysAsset) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3 & Period>=10)))
#marginAssetalltest <- hurdletest(hurdle(ceiling(marginbuysAsset) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, zero.dist = "negbin", dist = "negbin", link = "logit", data = subset(marketsummary, Programme==3)))

#clustered errors are not reported because of theta
se_marginAssetmiddle <- coeftest(marginAssetmiddle, vcov. = vcovCL(marginAssetmiddle, cluster = ~ SessionID, type = "HC1"))
se_marginAssetbeginning <- coeftest(marginAssetbeginning, vcov. = vcovCL(marginAssetbeginning, cluster = ~ SessionID, type = "HC1"))
se_marginAssetend <- coeftest(marginAssetend, vcov. = vcovCL(marginAssetend, cluster = ~ SessionID, type = "HC1"))
#se_marginAssetall <- coeftest(marginAssetall, vcov. = vcovCL(marginAssetall, cluster = ~ SessionID, type = "HC1"))

se_marginAssetmiddleUninf <- coeftest(marginAssetmiddleUninf, vcov. = vcovCL(marginAssetmiddleUninf, cluster = ~ SessionID, type = "HC1"))
se_marginAssetbeginningUninf <- coeftest(marginAssetbeginningUninf, vcov. = vcovCL(marginAssetbeginningUninf, cluster = ~ SessionID, type = "HC1"))
se_marginAssetendUninf <- coeftest(marginAssetendUninf, vcov. = vcovCL(marginAssetendUninf, cluster = ~ SessionID, type = "HC1"))
#se_marginAssetallUninf <- coeftest(marginAssetallUninf, vcov. = vcovCL(marginAssetallUninf, cluster = ~ SessionID, type = "HC1"))

se_marginAssetmiddleInf <- coeftest(marginAssetmiddleInf, vcov. = vcovCL(marginAssetmiddleInf, cluster = ~ SessionID, type = "HC1"))
se_marginAssetbeginningInf <- coeftest(marginAssetbeginningInf, vcov. = vcovCL(marginAssetbeginningInf, cluster = ~ SessionID, type = "HC1"))
se_marginAssetendInf <- coeftest(marginAssetendInf, vcov. = vcovCL(marginAssetendInf, cluster = ~ SessionID, type = "HC1"))
#se_marginAssetallInf <- coeftest(marginAssetallInf, vcov. = vcovCL(marginAssetallInf, cluster = ~ SessionID, type = "HC1"))

texreg(list(marginAssetbeginning, marginAssetmiddle, marginAssetend,marginAssetbeginningInf, marginAssetmiddleInf, marginAssetendInf, marginAssetbeginningUninf, marginAssetmiddleUninf, marginAssetendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "Zero inflated negative binomial model for margin buying evaluated at market prices (Table WA7).",
       custom.header = list('All traders' = 1:3, 'Informed traders' = 4:6, 'Uninformed traders' = 7:9), override.se=list(se_marginAssetbeginning[,2], se_marginAssetmiddle[,2], se_marginAssetend[,2], se_marginAssetbeginningInf[,2], se_marginAssetmiddleInf[,2], se_marginAssetendInf[,2], se_marginAssetbeginningUninf[,2], se_marginAssetmiddleUninf[,2], se_marginAssetendUninf[,2]), override.p=list(se_marginAssetbeginning[,4], se_marginAssetmiddle[,4], se_marginAssetend[,4], se_marginAssetbeginningInf[,4], se_marginAssetmiddleInf[,4], se_marginAssetendInf[,4], se_marginAssetbeginningUninf[,4], se_marginAssetmiddleUninf[,4], se_marginAssetendUninf[,4]), 
       custom.gof.rows = list("Hurdle test p-value" = c(marginAssetbeginningtest$`Pr(>Chisq)`[2], marginAssetmiddletest$`Pr(>Chisq)`[2], marginAssetendtest$`Pr(>Chisq)`[2],marginAssetbeginningInftest$`Pr(>Chisq)`[2], marginAssetmiddleInftest$`Pr(>Chisq)`[2], marginAssetendInftest$`Pr(>Chisq)`[2], marginAssetbeginningUninftest$`Pr(>Chisq)`[2], marginAssetmiddleUninftest$`Pr(>Chisq)`[2], marginAssetendUninftest$`Pr(>Chisq)`[2]), 
       "$sum_i hat{f}_i(0)$" = c(round(sum(predict(marginAssetbeginning, type = "prob")[,1])),round(sum(predict(marginAssetmiddle, type = "prob")[,1])), round(sum(predict(marginAssetend, type = "prob")[,1])), round(sum(predict(marginAssetbeginningInf, type = "prob")[,1])),round(sum(predict(marginAssetmiddleInf, type = "prob")[,1])), round(sum(predict(marginAssetendInf, type = "prob")[,1])), round(sum(predict(marginAssetbeginningUninf, type = "prob")[,1])),round(sum(predict(marginAssetmiddleUninf, type = "prob")[,1])), round(sum(predict(marginAssetendUninf, type = "prob")[,1]))),
       "$mu_i$" = c(round(predict(marginAssetbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 0, market = "Bottom", Period0 = 0)), 2)),
       "$mu_i(BBV12.5)$" = c(round(predict(marginAssetbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = 12.5, market = "Bottom", Period0 = 0)), 2)),
       "$mu_i(BBV-12.5)$" = c(round(predict(marginAssetbeginning, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddle, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetend, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetbeginningInf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddleInf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetendInf, type = "response", newdata = data.frame(history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetbeginningUninf, type = "response", newdata = data.frame(REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetmiddleUninf, type = "response", newdata = data.frame(history = "N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2), round(predict(marginAssetendUninf, type = "response", newdata = data.frame( history = "N.N", REGSH = 0, REGBoth = 0, BBVCent = -12.5, market = "Bottom", Period0 = 0)), 2))
       ))

```

```{r lmmarginAssetingtableAll, echo=F, results = 'asis', warning=F}
marginAssetmiddleUninf <- lm(((marginbuysAsset_Uninformed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginAssetmiddleInf <- lm(((marginbuysAsset_Informed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginAssetbeginningUninf <- lm(((marginbuysAsset_Uninformed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
marginAssetbeginningInf <- lm(((marginbuysAsset_Informed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
marginAssetendUninf <- lm(((marginbuysAsset_Uninformed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
marginAssetendInf <- lm(((marginbuysAsset_Informed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))

# <- lm(((marginbuysAsset)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(Rolesummary, Role == "Uninformed trader" & Programme==3 & Period > 0))
#marginAssetallInf <- lm(((marginbuysAsset)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(Rolesummary, Role == "Informed trader" & Programme==3))

marginAssetmiddle <- lm(((marginbuysAsset)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
marginAssetbeginning <- lm((marginbuysAsset) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
marginAssetend <- lm((marginbuysAsset) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
#marginAssetall <- lm((marginbuysAsset) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

#clustered errors are not reported because of theta
se_marginAssetmiddle <- coeftest(marginAssetmiddle, vcov. = vcovCL(marginAssetmiddle, cluster = ~ SessionID, type = "HC3"))
se_marginAssetbeginning <- coeftest(marginAssetbeginning, vcov. = vcovCL(marginAssetbeginning, cluster = ~ SessionID, type = "HC3"))
se_marginAssetend <- coeftest(marginAssetend, vcov. = vcovCL(marginAssetend, cluster = ~ SessionID, type = "HC3"))
#se_marginAssetall <- coeftest(marginAssetall, vcov. = vcovCL(marginAssetall, cluster = ~ SessionID, type = "HC3"))

se_marginAssetmiddleUninf <- coeftest(marginAssetmiddleUninf, vcov. = vcovCL(marginAssetmiddleUninf, cluster = ~ SessionID, type = "HC3"))
se_marginAssetbeginningUninf <- coeftest(marginAssetbeginningUninf, vcov. = vcovCL(marginAssetbeginningUninf, cluster = ~ SessionID, type = "HC3"))
se_marginAssetendUninf <- coeftest(marginAssetendUninf, vcov. = vcovCL(marginAssetendUninf, cluster = ~ SessionID, type = "HC3"))
#se_marginAssetallUninf <- coeftest(marginAssetallUninf, vcov. = vcovCL(marginAssetallUninf, cluster = ~ SessionID, type = "HC3"))

se_marginAssetmiddleInf <- coeftest(marginAssetmiddleInf, vcov. = vcovCL(marginAssetmiddleInf, cluster = ~ SessionID, type = "HC3"))
se_marginAssetbeginningInf <- coeftest(marginAssetbeginningInf, vcov. = vcovCL(marginAssetbeginningInf, cluster = ~ SessionID, type = "HC3"))
se_marginAssetendInf <- coeftest(marginAssetendInf, vcov. = vcovCL(marginAssetendInf, cluster = ~ SessionID, type = "HC3"))
#se_marginAssetallInf <- coeftest(marginAssetallInf, vcov. = vcovCL(marginAssetallInf, cluster = ~ SessionID, type = "HC3"))

texreg(list(marginAssetbeginning, marginAssetmiddle, marginAssetend,marginAssetbeginningInf, marginAssetmiddleInf, marginAssetendInf, marginAssetbeginningUninf, marginAssetmiddleUninf, marginAssetendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "OLS for margin buying evaluated at market prices", 
       custom.header = list('All traders' = 1:3, 'Informed traders' = 4:6, 'Uninformed traders' = 7:9),
       override.se=list(se_marginAssetbeginning[,2], se_marginAssetmiddle[,2], se_marginAssetend[,2], se_marginAssetbeginningInf[,2], se_marginAssetmiddleInf[,2], se_marginAssetendInf[,2], se_marginAssetbeginningUninf[,2], se_marginAssetmiddleUninf[,2], se_marginAssetendUninf[,2]), override.p=list(se_marginAssetbeginning[,4], se_marginAssetmiddle[,4], se_marginAssetend[,4], se_marginAssetbeginningInf[,4], se_marginAssetmiddleInf[,4], se_marginAssetendInf[,4], se_marginAssetbeginningUninf[,4], se_marginAssetmiddleUninf[,4], se_marginAssetendUninf[,4]))

```

*****************************************************************
\newpage

## Volume on stock

```{r lmstockAssetingtableAll, echo=F, results = 'asis', warning=F}
stockAssetmiddleUninf <- lm((log(VolumeUni - shortsells_Uninformed - marginbuys_Uninformed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
stockAssetmiddleInf <- lm((log(VolumeInf - shortsells_Informed - marginbuys_Informed)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10 & VolumeInf > 0))
stockAssetbeginningUninf <- lm((log(VolumeUni - shortsells_Uninformed - marginbuys_Uninformed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
stockAssetbeginningInf <- lm((log(VolumeInf - shortsells_Informed - marginbuys_Informed)) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
stockAssetendUninf <- lm((log(VolumeUni - shortsells_Uninformed - marginbuys_Uninformed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10 & VolumeUni - shortsells_Uninformed - marginbuysAsset_Uninformed > 0))
stockAssetendInf <- lm((log(VolumeInf - shortsells_Informed - marginbuys_Informed)) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10 & VolumeInf >0))

stockAssetallUninf <- lm((log(VolumeUni - shortsells_Uninformed - marginbuys_Uninformed)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period > 0 & VolumeUni - shortsells_Uninformed - marginbuysAsset_Uninformed > 0))
stockAssetallInf <- lm((log(VolumeInf - shortsells_Informed - marginbuys_Informed)) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & VolumeInf - shortsells_Informed - marginbuysAsset_Informed > 0))

stockAssetmiddle <- lm((log(Volume - shortsells - marginbuysAsset)) ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period<10))
stockAssetbeginning <- lm(log(Volume - shortsells - marginbuysAsset) ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
stockAssetend <- lm(log(Volume - shortsells - marginbuysAsset) ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10 & Volume - shortsells - marginbuysAsset > 0))
stockAssetall <- lm(log(Volume - shortsells - marginbuysAsset) ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Volume - shortsells - marginbuysAsset > 0))

#clustered errors are not reported because of theta
se_stockAssetmiddle <- coeftest(stockAssetmiddle, vcov. = vcovCL(stockAssetmiddle, cluster = ~ SessionID, type = "HC3"))
se_stockAssetbeginning <- coeftest(stockAssetbeginning, vcov. = vcovCL(stockAssetbeginning, cluster = ~ SessionID, type = "HC3"))
se_stockAssetend <- coeftest(stockAssetend, vcov. = vcovCL(stockAssetend, cluster = ~ SessionID, type = "HC3"))
se_stockAssetall <- coeftest(stockAssetall, vcov. = vcovCL(stockAssetall, cluster = ~ SessionID, type = "HC3"))

se_stockAssetmiddleUninf <- coeftest(stockAssetmiddleUninf, vcov. = vcovCL(stockAssetmiddleUninf, cluster = ~ SessionID, type = "HC3"))
se_stockAssetbeginningUninf <- coeftest(stockAssetbeginningUninf, vcov. = vcovCL(stockAssetbeginningUninf, cluster = ~ SessionID, type = "HC3"))
se_stockAssetendUninf <- coeftest(stockAssetendUninf, vcov. = vcovCL(stockAssetendUninf, cluster = ~ SessionID, type = "HC3"))
se_stockAssetallUninf <- coeftest(stockAssetallUninf, vcov. = vcovCL(stockAssetallUninf, cluster = ~ SessionID, type = "HC3"))

se_stockAssetmiddleInf <- coeftest(stockAssetmiddleInf, vcov. = vcovCL(stockAssetmiddleInf, cluster = ~ SessionID, type = "HC3"))
se_stockAssetbeginningInf <- coeftest(stockAssetbeginningInf, vcov. = vcovCL(stockAssetbeginningInf, cluster = ~ SessionID, type = "HC3"))
se_stockAssetendInf <- coeftest(stockAssetendInf, vcov. = vcovCL(stockAssetendInf, cluster = ~ SessionID, type = "HC3"))
se_stockAssetallInf <- coeftest(stockAssetallInf, vcov. = vcovCL(stockAssetallInf, cluster = ~ SessionID, type = "HC3"))

texreg(list(stockAssetbeginning, stockAssetmiddle, stockAssetend,stockAssetbeginningInf, stockAssetmiddleInf, stockAssetendInf, stockAssetbeginningUninf, stockAssetmiddleUninf, stockAssetendUninf), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001, 0.01, 0.05), digits = 2, leading.zero = TRUE, omit.coef = "(Session)|(subject)", 
       custom.model.names = c("Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3","Phase 1", "Phase 2", "Phase 3"),
       caption = "OLS for volume on stock (Volume - short sells - margin buys) evaluated at market prices", override.se=list(se_stockAssetbeginning[,2], se_stockAssetmiddle[,2], se_stockAssetend[,2], se_stockAssetbeginningInf[,2], se_stockAssetmiddleInf[,2], se_stockAssetendInf[,2], se_stockAssetbeginningUninf[,2], se_stockAssetmiddleUninf[,2], se_stockAssetendUninf[,2]), override.p=list(se_stockAssetbeginning[,4], se_stockAssetmiddle[,4], se_stockAssetend[,4], se_stockAssetbeginningInf[,4], se_stockAssetmiddleInf[,4], se_stockAssetendInf[,4], se_stockAssetbeginningUninf[,4], se_stockAssetmiddleUninf[,4], se_stockAssetendUninf[,4]))

```

*****************************************************************
\newpage

## Inequality

```{r HHPDbeforetableAll, echo=F, results = 'asis', warning=F}
HHI_PDbeforemiddle <- lm(HHI_PDbefore*100 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
HHI_PDbeforebeginning <- lm(HHI_PDbefore*100 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
HHI_PDbeforeend <- lm(HHI_PDbefore*100 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
HHI_PDbeforeall <- lm(HHI_PDbefore*100 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_HHI_PDbeforemiddle <- coeftest(HHI_PDbeforemiddle, vcov. = vcovCL(HHI_PDbeforemiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHI_PDbeforemiddle <- coeftest(HHI_PDbeforemiddle, vcov. = vcovCL(HHI_PDbeforemiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_HHI_PDbeforebeginning <- coeftest(HHI_PDbeforebeginning, vcov. = vcovCL(HHI_PDbeforebeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHI_PDbeforebeginning <- coeftest(HHI_PDbeforebeginning, vcov. = vcovCL(HHI_PDbeforebeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_HHI_PDbeforeend <- coeftest(HHI_PDbeforeend, vcov. = vcovCL(HHI_PDbeforeend, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHI_PDbeforeend <- coeftest(HHI_PDbeforeend, vcov. = vcovCL(HHI_PDbeforeend, cluster = ~ SessionID, type = "HC3"))[,4]
se_HHI_PDbeforeall <- coeftest(HHI_PDbeforeall, vcov. = vcovCL(HHI_PDbeforeall, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHI_PDbeforeall <- coeftest(HHI_PDbeforeall, vcov. = vcovCL(HHI_PDbeforeall, cluster = ~ SessionID, type = "HC3"))[,4]

HHPDbeforemiddle <- lm(HHPDbefore*100 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
HHPDbeforebeginning <- lm(HHPDbefore*100 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
HHPDbeforeend <- lm(HHPDbefore*100 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
HHPDbeforeall <- lm(HHPDbefore*100 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_HHPDbeforemiddle <- coeftest(HHPDbeforemiddle, vcov. = vcovCL(HHPDbeforemiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHPDbeforemiddle <- coeftest(HHPDbeforemiddle, vcov. = vcovCL(HHPDbeforemiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_HHPDbeforebeginning <- coeftest(HHPDbeforebeginning, vcov. = vcovCL(HHPDbeforebeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHPDbeforebeginning <- coeftest(HHPDbeforebeginning, vcov. = vcovCL(HHPDbeforebeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_HHPDbeforeend <- coeftest(HHPDbeforeend, vcov. = vcovCL(HHPDbeforeend, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHPDbeforeend <- coeftest(HHPDbeforeend, vcov. = vcovCL(HHPDbeforeend, cluster = ~ SessionID, type = "HC3"))[,4]
se_HHPDbeforeall <- coeftest(HHPDbeforeall, vcov. = vcovCL(HHPDbeforeall, cluster = ~ SessionID, type = "HC3"))[,2]
p_HHPDbeforeall <- coeftest(HHPDbeforeall, vcov. = vcovCL(HHPDbeforeall, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(HHI_PDbeforeall, HHI_PDbeforebeginning, HHI_PDbeforemiddle, HHI_PDbeforeend, HHPDbeforeall, HHPDbeforebeginning, HHPDbeforemiddle, HHPDbeforeend), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)", 

       custom.model.names = c("all", "Phase 1", "Phase 2", "Phase 3","all", "Phase 1", "Phase 2", "Phase 3"),
       caption = "HHIPDbefore(volume)", override.se=list(se_HHI_PDbeforeall, se_HHI_PDbeforebeginning, se_HHI_PDbeforemiddle, se_HHI_PDbeforeend, se_HHPDbeforeall, se_HHPDbeforebeginning, se_HHPDbeforemiddle, se_HHPDbeforeend), 
       override.p = list(p_HHI_PDbeforeall, p_HHI_PDbeforebeginning, p_HHI_PDbeforemiddle, p_HHI_PDbeforeend, p_HHPDbeforeall, p_HHPDbeforebeginning, p_HHPDbeforemiddle, p_HHPDbeforeend))

```

```{r GiniProfitableAll, echo=F, results = 'asis', warning=F}
GiniProfitmiddle <- lm(GiniProfit*100 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
GiniProfitbeginning <- lm(GiniProfit*100 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
GiniProfitend <- lm(GiniProfit*100 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
GiniProfitall <- lm(GiniProfit*100 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_GiniProfitmiddle <- coeftest(GiniProfitmiddle, vcov. = vcovCL(GiniProfitmiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniProfitmiddle <- coeftest(GiniProfitmiddle, vcov. = vcovCL(GiniProfitmiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_GiniProfitbeginning <- coeftest(GiniProfitbeginning, vcov. = vcovCL(GiniProfitbeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniProfitbeginning <- coeftest(GiniProfitbeginning, vcov. = vcovCL(GiniProfitbeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_GiniProfitend <- coeftest(GiniProfitend, vcov. = vcovCL(GiniProfitend, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniProfitend <- coeftest(GiniProfitend, vcov. = vcovCL(GiniProfitend, cluster = ~ SessionID, type = "HC3"))[,4]
se_GiniProfitall <- coeftest(GiniProfitall, vcov. = vcovCL(GiniProfitall, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniProfitall <- coeftest(GiniProfitall, vcov. = vcovCL(GiniProfitall, cluster = ~ SessionID, type = "HC3"))[,4]

GiniPDbeforemiddle <- lm(GiniPDbefore*100 ~ history + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>3 & Period < 10))
GiniPDbeforebeginning <- lm(GiniPDbefore*100 ~ REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period<=3))
GiniPDbeforeend <- lm(GiniPDbefore*100 ~ history + REGBoth + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3 & Period>=10))
GiniPDbeforeall <- lm(GiniPDbefore*100 ~ history + REGBoth + REGSH + BBVCent + abs(BBVCent) + market + Period0, data = subset(marketsummary, Programme==3))

se_GiniPDbeforemiddle <- coeftest(GiniPDbeforemiddle, vcov. = vcovCL(GiniPDbeforemiddle, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniPDbeforemiddle <- coeftest(GiniPDbeforemiddle, vcov. = vcovCL(GiniPDbeforemiddle, cluster = ~ SessionID, type = "HC3"))[,4]
se_GiniPDbeforebeginning <- coeftest(GiniPDbeforebeginning, vcov. = vcovCL(GiniPDbeforebeginning, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniPDbeforebeginning <- coeftest(GiniPDbeforebeginning, vcov. = vcovCL(GiniPDbeforebeginning, cluster = ~ SessionID, type = "HC3"))[,4]
se_GiniPDbeforeend <- coeftest(GiniPDbeforeend, vcov. = vcovCL(GiniPDbeforeend, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniPDbeforeend <- coeftest(GiniPDbeforeend, vcov. = vcovCL(GiniPDbeforeend, cluster = ~ SessionID, type = "HC3"))[,4]
se_GiniPDbeforeall <- coeftest(GiniPDbeforeall, vcov. = vcovCL(GiniPDbeforeall, cluster = ~ SessionID, type = "HC3"))[,2]
p_GiniPDbeforeall <- coeftest(GiniPDbeforeall, vcov. = vcovCL(GiniPDbeforeall, cluster = ~ SessionID, type = "HC3"))[,4]

texreg(list(GiniProfitall, GiniProfitbeginning, GiniProfitmiddle, GiniProfitend, GiniPDbeforeall, GiniPDbeforebeginning, GiniPDbeforemiddle, GiniPDbeforeend), custom.note = ("\\parbox{.4\\linewidth}{\\vspace{2pt}%stars.}"), 
       stars = c(0.001,  0.01, 0.05), digits = 2, leading.zero = TRUE,   omit.coef = "(Session)|(subject)", 

       custom.model.names = c("all", "Phase 1", "Phase 2", "Phase 3","all", "Phase 1", "Phase 2", "Phase 3"),
       caption = "GiniProfit(volume)", override.se=list(se_GiniProfitall, se_GiniProfitbeginning, se_GiniProfitmiddle, se_GiniProfitend, se_GiniPDbeforeall, se_GiniPDbeforebeginning, se_GiniPDbeforemiddle, se_GiniPDbeforeend), 
       override.p = list(p_GiniProfitall, p_GiniProfitbeginning, p_GiniProfitmiddle, p_GiniProfitend, p_GiniPDbeforeall, p_GiniPDbeforebeginning, p_GiniPDbeforemiddle, p_GiniPDbeforeend))

```